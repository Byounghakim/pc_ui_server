import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import MqttClient from '@/lib/mqtt-client';
import { 
  EXTRACTION_INPUT_TOPIC, 
  EXTRACTION_OUTPUT_TOPIC, 
  PROCESS_PROGRESS_TOPIC,
  AUTOMATION_CONTROL_TOPIC,
  AUTOMATION_STATUS_TOPIC,
  ERROR_TOPIC,
  QUEUE_STATUS_TOPIC
} from '@/lib/mqtt-topics';
import { Checkbox } from "@/app/components/ui/checkbox";
import { X, Play, Square, RotateCcw, ArrowUp, ArrowDown, PlusCircle } from 'lucide-react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { PumpSequence } from '../types/index';
import workLogService from '../services/work-log-service';
import { ScrollArea } from "@/app/components/ui/scroll-area";
import { Separator } from "@/app/components/ui/separator";
import { Input } from '@/components/ui/input';
import { v4 as uuidv4 } from 'uuid';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogClose } from "@/app/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { AlertDialog, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogCancel, AlertDialogAction } from "@/app/components/ui/alert-dialog";
import { toast } from "@/app/components/ui/use-toast";

// ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
const AUTOMATION_STATE_KEY = 'automation-process-state';
const AUTOMATION_SEQUENCES_KEY = 'automation-process-sequences';

type AutomationStatus = 'waiting' | 'running' | 'paused' | 'stopped' | 'completed' | 'error';
type SequenceStatus = 'waiting' | 'running' | 'completed' | 'error';

// í ì•„ì´í…œ ì¸í„°í˜ì´ìŠ¤ ì •ì˜
interface QueueItem {
  id: string;
  name: string;
  timestamp: number;
  data: any;
}

// í ìƒíƒœ ì¸í„°í˜ì´ìŠ¤ ì •ì˜
interface QueueStatus {
  isProcessing: boolean;
  count: number;
  items?: QueueItem[];
}

interface SequenceWithStatus {
  id: string;
  sequence: PumpSequence;
  status: SequenceStatus;
  waitTime: number;
  customRepeats: number;
  startTime?: number;
  endTime?: number;
  errorDetails?: string;
  currentRepeatCount?: number; // í˜„ì¬ ë°˜ë³µ íšŸìˆ˜ ì¹´ìš´íŠ¸ ì¶”ê°€
}

interface SavedProcess {
  id: string;
  name: string;
  description?: string;
  sequences: SequenceWithStatus[];
  createdAt: string;
  updatedAt: string;
}

interface AutomationProcessProps {
  mqttClient: MqttClient | null;
  savedSequences: PumpSequence[];
  onLockChange?: (locked: boolean) => void; // ìë™í™” ê³µì • ì ê¸ˆ ìƒíƒœ ë³€ê²½ ì½œë°±
}

// ì‹œí€€ìŠ¤ JSON í˜•ì‹ í‘œì¤€í™” í•¨ìˆ˜
const standardizeSequenceJson = (sequence: any): any => {
  // operation_mode ë³´ì¡´ í”Œë˜ê·¸: trueë¡œ ì„¤ì •í•˜ë©´ ì‹œí€€ìŠ¤ì˜ ì›ë³¸ operation_modeê°€ ë³´ì¡´ë©ë‹ˆë‹¤
  const preserveOriginalMode = true;
  
  // operation_mode ìœ íš¨ì„± ê²€ì‚¬ ë° í‘œì¤€í™”
  let operationMode = sequence.operation_mode;
  
  console.log(`[í‘œì¤€í™”] ì›ë³¸ ì‹œí€€ìŠ¤ operation_mode: ${operationMode}`);
  
  // ì›ë³¸ ëª¨ë“œë¥¼ ë³´ì¡´í•˜ëŠ” ê²½ìš°
  if (preserveOriginalMode) {
    // ì›ë³¸ ëª¨ë“œ ê°’ ìœ ì§€, í‘œì¤€í™”í•˜ì§€ ì•ŠìŒ
    console.log(`[í‘œì¤€í™”] ì›ë³¸ operation_mode ìœ ì§€: ${operationMode}`);
  } else {
    // ì›ë˜ì˜ í‘œì¤€í™” ë¡œì§
    const firstDigit = Math.floor(operationMode / 10);
    const secondDigit = operationMode % 10;
    
    console.log(`[í‘œì¤€í™”] ë¶„ì„: ì²«ì§¸ ìë¦¬(${firstDigit}), ë‘˜ì§¸ ìë¦¬(${secondDigit})`);
    
    // ì²« ë²ˆì§¸ ìë¦¬ê°€ 1ì¸ ê²½ìš° (ë™ì‹œ ëª¨ë“œ) -> ì›ë˜ëŠ” 12ë¡œ í‘œì¤€í™”í–ˆì§€ë§Œ 11(ë™ì‹œ+ì¶”ì¶œìˆœí™˜)ë„ ë³´ì¡´
    if (firstDigit === 1) {
      if (secondDigit === 1) {
        // 11(ë™ì‹œ+ì¶”ì¶œìˆœí™˜)ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ìœ ì§€
        console.log(`[í‘œì¤€í™”] ë™ì‹œ+ì¶”ì¶œìˆœí™˜(11) ëª¨ë“œ ë³´ì¡´`);
      } else {
        operationMode = 12;
        console.log(`[í‘œì¤€í™”] ë™ì‹œ ëª¨ë“œë¥¼ 12ë¡œ í‘œì¤€í™”`);
      }
    } 
    // ì²« ë²ˆì§¸ ìë¦¬ê°€ 2ì¸ ê²½ìš° (ìˆœì°¨ ëª¨ë“œ) -> 22ë¡œ í‘œì¤€í™”
    else if (firstDigit === 2) {
      operationMode = 22;
      console.log(`[í‘œì¤€í™”] ìˆœì°¨ ëª¨ë“œë¥¼ 22ë¡œ í‘œì¤€í™”`);
    }
    // ì²« ë²ˆì§¸ ìë¦¬ê°€ 3ì¸ ê²½ìš° -> 30ìœ¼ë¡œ í‘œì¤€í™”
    else if (firstDigit === 3) {
      operationMode = 30;
      console.log(`[í‘œì¤€í™”] ì¤‘ì²© ëª¨ë“œë¥¼ 30ìœ¼ë¡œ í‘œì¤€í™”`);
    }
    // ê·¸ ì™¸ì˜ ê²½ìš° ë‹¨ì¼ ìë¦¿ìˆ˜ëŠ” ë³´ì¡´ (íŠ¹íˆ 3ì€ ê·¸ëŒ€ë¡œ ìœ ì§€)
    else {
      // ë‹¨ì¼ ìë¦¿ìˆ˜ ëª¨ë“œëŠ” ë³´ì¡´
      console.log(`[í‘œì¤€í™”] ë‹¨ì¼ ìë¦¿ìˆ˜ ëª¨ë“œ ë³´ì¡´: ${operationMode}`);
    }
  }
  
  // í”„ë¡œì„¸ìŠ¤ ë°°ì—´ í‘œì¤€í™” - ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ë§Œ ì²˜ë¦¬
  let processArray = [...sequence.process];
  
  console.log(`[í‘œì¤€í™”] ì›ë³¸ í”„ë¡œì„¸ìŠ¤ ë°°ì—´: [${processArray.join(', ')}], ê¸¸ì´: ${processArray.length}`);
  
  // í”„ë¡œì„¸ìŠ¤ ë°°ì—´ì— ìœ íš¨í•˜ì§€ ì•Šì€ ê°’(7, 8, 9)ì´ ìˆìœ¼ë©´ ìœ íš¨í•œ ê°’(0, 5, 6, 10)ìœ¼ë¡œ ë³€í™˜
  processArray = processArray.map((value: number) => {
    if (value === 7 || value === 8 || value === 9) {
      return 6; // ìœ íš¨í•œ ê°’ìœ¼ë¡œ ëŒ€ì²´
    }
    return value;
  });
  
  // ì›ë³¸ ëª¨ë“œë¥¼ ë³´ì¡´í•˜ëŠ” ê²½ìš° í”„ë¡œì„¸ìŠ¤ ë°°ì—´ë„ ë³´ì¡´
  if (preserveOriginalMode) {
    // í”„ë¡œì„¸ìŠ¤ ë°°ì—´ ê·¸ëŒ€ë¡œ ìœ ì§€
    console.log(`[í‘œì¤€í™”] ì›ë³¸ í”„ë¡œì„¸ìŠ¤ ë°°ì—´ ìœ ì§€: [${processArray.length > 10 ? processArray.slice(0, 10).join(', ') + '...' : processArray.join(', ')}], ê¸¸ì´: ${processArray.length}`);
  } else {
    // ëª¨ë“œë³„ë¡œ ì ì ˆí•œ process ë°°ì—´ ê¸¸ì´ì™€ íŒ¨í„´ í™•ë³´
    if (operationMode === 11 || operationMode === 12) { // ë™ì‹œ ëª¨ë“œ (11: ë™ì‹œ+ì¶”ì¶œìˆœí™˜, 12: ë™ì‹œ+ì „ì²´ìˆœí™˜)
      // í”„ë¡œì„¸ìŠ¤ ê¸¸ì´ê°€ 6ì˜ ë°°ìˆ˜ê°€ ë˜ë„ë¡ ì¡°ì •
      while (processArray.length % 6 !== 0) {
        processArray.push(0);
      }
      console.log(`[í‘œì¤€í™”] ë™ì‹œ ëª¨ë“œ(${operationMode}) í”„ë¡œì„¸ìŠ¤ ê¸¸ì´ ì¡°ì •: ${processArray.length}`);
    } else if (operationMode === 22) { // ìˆœì°¨ ëª¨ë“œ
      // í”„ë¡œì„¸ìŠ¤ ê¸¸ì´ê°€ 3ì˜ ë°°ìˆ˜ê°€ ë˜ë„ë¡ ì¡°ì •
      while (processArray.length % 3 !== 0) {
        processArray.push(0);
      }
      
      // ê° ê·¸ë£¹ì´ [6, 5, 0] íŒ¨í„´ìœ¼ë¡œ í‘œì¤€í™”
      const standardizedProcess = [];
      for (let i = 0; i < processArray.length; i += 3) {
        standardizedProcess.push(6);
        standardizedProcess.push(5);
        standardizedProcess.push(0);
      }
      processArray = standardizedProcess;
      console.log(`[í‘œì¤€í™”] ìˆœì°¨ ëª¨ë“œ í”„ë¡œì„¸ìŠ¤ í‘œì¤€í™”: [${processArray.length > 10 ? processArray.slice(0, 10).join(', ') + '...' : processArray.join(', ')}], ê¸¸ì´: ${processArray.length}`);
    } else if (operationMode === 30) { // í˜¼í•© ëª¨ë“œ
      // í”„ë¡œì„¸ìŠ¤ ê¸¸ì´ê°€ ì§ìˆ˜ê°€ ë˜ë„ë¡ ì¡°ì •
      if (processArray.length % 2 !== 0) {
        processArray.push(0);
      }
      
      // êµì°¨ íŒ¨í„´(10, 5, ...)ìœ¼ë¡œ í‘œì¤€í™”
      const standardizedProcess = [];
      for (let i = 0; i < processArray.length; i += 2) {
        standardizedProcess.push(10);
        standardizedProcess.push(5);
      }
      processArray = standardizedProcess;
      console.log(`[í‘œì¤€í™”] í˜¼í•© ëª¨ë“œ í”„ë¡œì„¸ìŠ¤ í‘œì¤€í™”: [${processArray.length > 10 ? processArray.slice(0, 10).join(', ') + '...' : processArray.join(', ')}], ê¸¸ì´: ${processArray.length}`);
    }
  }
  
  // í‘œì¤€í™”ëœ ì‹œí€€ìŠ¤ ê°ì²´ ìƒì„±
  const standardizedSeq: any = {
    ...sequence,
    operation_mode: operationMode,
    process: processArray
  };
  
  // wait_timeì€ operation_modeê°€ 22(ìˆœì°¨ ëª¨ë“œ)ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¶”ê°€
  if (operationMode === 22) {
    delete standardizedSeq.wait_time;
  }
  
  console.log(`[í‘œì¤€í™”] ìµœì¢… ì‹œí€€ìŠ¤ operation_mode: ${standardizedSeq.operation_mode}, í”„ë¡œì„¸ìŠ¤ ê¸¸ì´: ${standardizedSeq.process.length}`);
  
  return standardizedSeq;
};

// UI ìƒíƒœ ë³€ê²½ ìµœì í™”ë¥¼ ìœ„í•œ ë””ë°”ìš´ìŠ¤ í•¨ìˆ˜ ì •ì˜
const debounce = (func: Function, wait: number) => {
  let timeout: NodeJS.Timeout | null = null;
  return (...args: any[]) => {
    if (timeout) clearTimeout(timeout);
    timeout = setTimeout(() => {
      func(...args);
    }, wait);
  };
};

const AutomationProcess: React.FC<AutomationProcessProps> = ({ 
  mqttClient, 
  savedSequences,
  onLockChange 
}) => {
  // ìƒíƒœ ê´€ë¦¬ ìµœì í™”ë¥¼ ìœ„í•œ useRef ì¶”ê°€
  const prevStatus = useRef<AutomationStatus>('waiting');
  const processingAction = useRef<boolean>(false);
  const pendingUpdates = useRef<{type: string, data: any}[]>([]);
  // í˜„ì¬ ìë™í™” ì‹¤í–‰ ìƒíƒœë¥¼ ì¶”ì í•˜ëŠ” ref ì¶”ê°€
  const automationRunningRef = useRef<boolean>(false);
  
  const [status, setStatus] = useState<AutomationStatus>('waiting');
  const [selectedSequences, setSelectedSequences] = useState<SequenceWithStatus[]>([]);
  const [availableSequences, setAvailableSequences] = useState<string[]>([]);
  const [selectedSequenceName, setSelectedSequenceName] = useState<string>('');
  const [currentSequenceIndex, setCurrentSequenceIndex] = useState<number>(-1);
  // ë¡œê·¸ ìƒíƒœ íƒ€ì… ìˆ˜ì •
  type LogEntry = string | { id: string; message: string; timestamp: number; type: "info" };
  const [logs, setLogs] = useState<LogEntry[]>([]);
  const [logMessages, setLogMessages] = useState<string[]>([]);
  const [progress, setProgress] = useState<string>('ì§„í–‰ ìƒíƒœ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.');
  const [queueItems, setQueueItems] = useState<QueueItem[]>([]);
  const [queueStatus, setQueueStatus] = useState<QueueStatus>({ 
    isProcessing: false, 
    count: 0 
  });
  const [waitingCountdowns, setWaitingCountdowns] = useState<{[key: number]: number}>({});
  const [showTimePopup, setShowTimePopup] = useState<number | null>(null);
  const [tempHours, setTempHours] = useState(0);
  const [tempMinutes, setTempMinutes] = useState(0);
  const [tempSeconds, setTempSeconds] = useState(0);
  const [showSaveDialog, setShowSaveDialog] = useState(false);
  const [showLoadDialog, setShowLoadDialog] = useState(false);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const [processName, setProcessName] = useState('');
  const [processDescription, setProcessDescription] = useState('');
  const [savedProcesses, setSavedProcesses] = useState<SavedProcess[]>([]);
  const [selectedProcessId, setSelectedProcessId] = useState<string>('');
  const [isLoading, setIsLoading] = useState(false);
  const [alertOpen, setAlertOpen] = useState(false);
  const [manualCommand, setManualCommand] = useState('');
  const [showManualCommandDialog, setShowManualCommandDialog] = useState(false);
  const [countdownIntervals, setCountdownIntervals] = useState<{[key: string]: NodeJS.Timeout}>({});
  
  // ì¶”ê°€ ë³€ìˆ˜ ì •ì˜
  const [currentSequenceId, setCurrentSequenceId] = useState('');
  const [serverBusy, setServerBusy] = useState(false);
  const processingRef = useRef<boolean>(false);
  const countdownTimersRef = useRef<{[key: string]: NodeJS.Timeout}>({});
  
  // íŒì—… ìœ„ì¹˜ ìƒíƒœ ì¶”ê°€
  const [popupPosition, setPopupPosition] = useState({ x: window.innerWidth / 2 - 150, y: window.innerHeight / 2 - 100 });
  const [isDragging, setIsDragging] = useState(false);
  const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
  const popupRef = useRef<HTMLDivElement>(null);
  
  // ìƒíƒœ ë³€ê²½ ìµœì í™” í•¨ìˆ˜
  const safeUpdateState = <T extends unknown>(
    stateSetter: React.Dispatch<React.SetStateAction<T>>,
    value: T | ((prev: T) => T),
    stateType: string
  ) => {
    if (processingAction.current) {
      // ì²˜ë¦¬ ì¤‘ì¼ ë•ŒëŠ” ì—…ë°ì´íŠ¸ë¥¼ ëŒ€ê¸°ì—´ì— ë„£ìŒ
      pendingUpdates.current.push({ type: stateType, data: value });
      return;
    }
    
    stateSetter(value);
  };
  
  // ëŒ€ê¸° ì¤‘ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
  const processPendingUpdates = useCallback(() => {
    if (pendingUpdates.current.length === 0) return;
    
    processingAction.current = true;
    
    // ê° ì—…ë°ì´íŠ¸ ìœ í˜•ë³„ë¡œ ë§ˆì§€ë§‰ í•­ëª©ë§Œ ì ìš©
    const uniqueUpdates = pendingUpdates.current.reduce((acc, update) => {
      acc[update.type] = update.data;
      return acc;
    }, {} as Record<string, any>);
    
    // ì—…ë°ì´íŠ¸ ì ìš©
    Object.entries(uniqueUpdates).forEach(([type, data]) => {
      switch (type) {
        case 'status':
          setStatus(typeof data === 'function' ? data(status) : data);
          break;
        case 'selectedSequences':
          setSelectedSequences(typeof data === 'function' ? data(selectedSequences) : data);
          break;
        case 'currentSequenceIndex':
          setCurrentSequenceIndex(typeof data === 'function' ? data(currentSequenceIndex) : data);
          break;
        case 'logs':
          setLogs(typeof data === 'function' ? data(logs) : data);
          break;
        case 'queueItems':
          setQueueItems(typeof data === 'function' ? data(queueItems) : data);
          break;
        case 'queueStatus':
          setQueueStatus(typeof data === 'function' ? data(queueStatus) : data);
          break;
        default:
          break;
      }
    });
    
    pendingUpdates.current = [];
    processingAction.current = false;
  }, [status, selectedSequences, currentSequenceIndex, logs, queueItems, queueStatus]);
  
  // ì£¼ê¸°ì ìœ¼ë¡œ ëŒ€ê¸° ì¤‘ì¸ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
  useEffect(() => {
    const interval = setInterval(() => {
      if (!processingAction.current && pendingUpdates.current.length > 0) {
        processPendingUpdates();
      }
    }, 50); // 50ms ê°„ê²©ìœ¼ë¡œ í™•ì¸
    
    return () => clearInterval(interval);
  }, [processPendingUpdates]);

  // status ìƒíƒœê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ref ì—…ë°ì´íŠ¸
  useEffect(() => {
    // automationRunningRef ì—…ë°ì´íŠ¸
    automationRunningRef.current = status === 'running';

    // ê¸°ì¡´ ì½”ë“œ ìœ ì§€
    if (prevStatus.current !== status) {
      prevStatus.current = status;
      
      // ìƒíƒœ ë³€ê²½ ì‹œ ìë™í™” ê³µì • ì ê¸ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
      if (onLockChange) {
        onLockChange(status === 'running' || status === 'paused');
      }
      
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ìƒíƒœ ì €ì¥
      if (typeof window !== 'undefined') {
        try {
          localStorage.setItem(AUTOMATION_STATE_KEY, JSON.stringify({
            status,
            currentSequenceIndex,
            selectedSequences
          }));
        } catch (error) {
          console.error('ìƒíƒœ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
        }
      }
    }
  }, [status, currentSequenceIndex, selectedSequences, onLockChange]);

  // MQTT ë©”ì‹œì§€ í•¸ë“¤ëŸ¬ ìµœì í™” - ë””ë°”ìš´ìŠ¤ ì ìš©
  const debouncedHandleMessage = useCallback(
    debounce((topic: string, message: Buffer) => {
      try {
        // ê¸°ì¡´ handleMessage ì½”ë“œ ë‚´ìš© ìœ ì§€
        // ...
      } catch (error) {
        console.error('MQTT ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
      }
    }, 50), // 50ms ë””ë°”ìš´ìŠ¤
    []
  );

  // updateSequenceStatus ìµœì í™”
  const updateSequenceStatus = (index: number, newStatus: SequenceStatus) => {
    if (index < 0 || index >= selectedSequences.length) return;
    
    processingAction.current = true;
    setSelectedSequences(prev => {
      const updated = [...prev];
      updated[index] = {
        ...updated[index],
        status: newStatus,
        ...(newStatus === 'running' && { startTime: Date.now() }),
        ...(newStatus === 'completed' && { endTime: Date.now() })
      };
      return updated;
    });
    processingAction.current = false;
  };

  // addSequence ìµœì í™” ë° ì €ì¥ ë¡œì§ ê°•í™”
  const addSequence = (sequenceName: string) => {
    // ëª¨ë“  ë™ì¼í•œ ì´ë¦„ì˜ ì‹œí€€ìŠ¤ë¥¼ ì°¾ë„ë¡ findì—ì„œ filterë¡œ ë³€ê²½
    const sequences = savedSequences.filter(seq => seq.name === sequenceName);
    if (sequences.length === 0) {
      console.log(`'${sequenceName}' ì´ë¦„ì˜ ì‹œí€€ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
      return;
    }
    
    console.log(`ì‹œí€€ìŠ¤ ì¶”ê°€: ${sequenceName} (${sequences.length}ê°œ ë°œê²¬)`);
    
    processingAction.current = true;
    
    // ê° ì‹œí€€ìŠ¤ë¥¼ ë…ë¦½ì ì¸ í•­ëª©ìœ¼ë¡œ ì¶”ê°€
    const newSequences = sequences.map(sequence => ({
      id: uuidv4(),
      sequence,
      status: 'waiting' as SequenceStatus,
      waitTime: 0,
      customRepeats: sequence.repeats || 1
    }));
    
    // ì‹œí€€ìŠ¤ ë°°ì—´ ì—…ë°ì´íŠ¸
    setSelectedSequences(prev => {
      const updatedSequences = [...prev, ...newSequences];
      
      // ì¦‰ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
      try {
        localStorage.setItem(AUTOMATION_SEQUENCES_KEY, JSON.stringify(updatedSequences));
        console.log(`${sequenceName} ì´ë¦„ì˜ ì‹œí€€ìŠ¤ ${newSequences.length}ê°œ ì¶”ê°€ ë° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ ì™„ë£Œ`);
      } catch (error) {
        console.error('ì‹œí€€ìŠ¤ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì‹¤íŒ¨:', error);
      }
      
      return updatedSequences;
    });
    
    // ë¡œê·¸ì— ì¶”ê°€
    addLog(`ì‹œí€€ìŠ¤ '${sequenceName}' ${newSequences.length}ê°œ ì¶”ê°€ë¨`);
    
    processingAction.current = false;
  };

  // resetAutomation í•¨ìˆ˜ ìˆ˜ì • - automationRunningRef ì—…ë°ì´íŠ¸ ì¶”ê°€
  const resetAutomation = () => {
    // ì‘ì—… ì²˜ë¦¬ ì¤‘ í”Œë˜ê·¸ ì„¤ì •
    processingAction.current = true;
    console.log('ìë™í™” ê³µì • ë¦¬ì…‹ ì‹œì‘ - ëª¨ë“  ì‹¤í–‰ ì¤‘ì§€ ë° ìƒíƒœ ì´ˆê¸°í™”');
    
    // automationRunningRef ìƒíƒœ ì—…ë°ì´íŠ¸
    automationRunningRef.current = false;
    
    // ì‹¤í–‰ ì¤‘ì¸ ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ëª¨ë‘ ì •ë¦¬
    Object.values(countdownIntervals).forEach(interval => {
      clearInterval(interval);
    });
    
    // ê°•ì œ ì¤‘ì§€ ë©”ì‹œì§€ ë°œí–‰ - ì‹¤í–‰ ì¤‘ì¸ ê³µì • ì¦‰ì‹œ ì¤‘ì§€
    if (mqttClient) {
      try {
        // ë¨¼ì € ê°•ì œ ì¤‘ì§€ ë©”ì‹œì§€ ë°œí–‰
        mqttClient.publish(AUTOMATION_CONTROL_TOPIC, JSON.stringify({
          action: 'force_stop',
          message: 'ì‚¬ìš©ìê°€ ë¦¬ì…‹ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ëª¨ë“  ê³µì •ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.'
        }));
        
        // ì§„í–‰ ìƒíƒœ ë©”ì‹œì§€ ì „ì†¡
        mqttClient.publish(PROCESS_PROGRESS_TOPIC, JSON.stringify({
          status: 'stopped',
          message: 'ì‚¬ìš©ìê°€ ë¦¬ì…‹ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ëª¨ë“  ê³µì •ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.'
        }));
        
        console.log('ê°•ì œ ì¤‘ì§€ ë©”ì‹œì§€ ë°œí–‰ ì™„ë£Œ');
      } catch (error) {
        console.error('MQTT ë©”ì‹œì§€ ë°œí–‰ ì¤‘ ì˜¤ë¥˜:', error);
      }
    }
    
    // ìƒíƒœ ì´ˆê¸°í™” (ì„ íƒí•œ ì‹œí€€ìŠ¤ëŠ” ìœ ì§€)
    setStatus('waiting');
    setCurrentSequenceIndex(-1);
    setWaitingCountdowns({});
    setCountdownIntervals({});
    
    // ëª¨ë“  ì‹œí€€ìŠ¤ì˜ ìƒíƒœë¥¼ 'waiting'ìœ¼ë¡œ ì´ˆê¸°í™”
    setSelectedSequences(prev => prev.map(seq => ({
      ...seq,
      status: 'waiting',
      startTime: undefined,
      endTime: undefined,
      errorDetails: undefined
    })));
    
    // ì•½ê°„ì˜ ì§€ì—° í›„ í ì´ˆê¸°í™” (ì¤‘ì§€ ë©”ì‹œì§€ê°€ ì²˜ë¦¬ë  ì‹œê°„ í™•ë³´)
    setTimeout(() => {
      // í ì´ˆê¸°í™”
      if (mqttClient) {
        try {
          mqttClient.publish(AUTOMATION_CONTROL_TOPIC, JSON.stringify({
            action: 'clear_all'
          }));
          console.log('í ì´ˆê¸°í™” ë©”ì‹œì§€ ë°œí–‰ ì™„ë£Œ');
        } catch (error) {
          console.error('MQTT ë©”ì‹œì§€ ë°œí–‰ ì¤‘ ì˜¤ë¥˜:', error);
        }
      }
      
      processingAction.current = false;
      
      toast({
        title: "ë¦¬ì…‹ ì™„ë£Œ",
        description: "ê³µì • ìƒíƒœê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì¼ê´„ ì‹¤í–‰ ë²„íŠ¼ìœ¼ë¡œ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
      });
    }, 500); // 0.5ì´ˆ ì§€ì—°
  };

  // ì™„ì „ ì´ˆê¸°í™” í•¨ìˆ˜ ìˆ˜ì • - automationRunningRef ì—…ë°ì´íŠ¸ ì¶”ê°€
  const fullReset = () => {
    console.log('ìë™í™” ê³µì • ì™„ì „ ì´ˆê¸°í™” ì‹œì‘ - ëª¨ë“  ì„¤ì • ì´ˆê¸°í™”');
    
    // ëª¨ë“  êµ¬ë… ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¼ì‹œ ì¤‘ì§€
    if (mqttClient) {
      // ëª¨ë“  ë©”ì‹œì§€ í•¸ë“¤ëŸ¬ ì¼ì‹œ ì¤‘ì§€ - ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ë¥¼ ìƒëµí•˜ë©´ ëª¨ë“  í•¸ë“¤ëŸ¬ê°€ ì œê±°ë¨
      mqttClient.off("message", function() {});
    }
    
    // ì™„ì „ ì´ˆê¸°í™”ëŠ” ë‹¤ë¥¸ ëª¨ë“  ì²˜ë¦¬ë¥¼ ì¤‘ë‹¨ì‹œí‚¤ë¯€ë¡œ processingAction í”Œë˜ê·¸ ì„¤ì •
    processingAction.current = true;
    
    // automationRunningRef ìƒíƒœ ì—…ë°ì´íŠ¸
    automationRunningRef.current = false;
    
    // ì‹¤í–‰ ì¤‘ì¸ ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ëª¨ë‘ ì •ë¦¬
    Object.values(countdownIntervals).forEach(interval => {
      if (interval) {
        clearInterval(interval);
        clearTimeout(interval);
      }
    });
    
    // ëª¨ë“  ì¶”ê°€ íƒ€ì´ë¨¸ë„ ì œê±°
    for (let i = 0; i < 100; i++) {
      clearTimeout(i);
      clearInterval(i);
    }
    
    // ê°•ì œ ì¤‘ì§€ ë©”ì‹œì§€ ë°œí–‰ - ëª¨ë“  ì—ëŸ¬ì™€ ë¬´í•œ ë£¨í”„ ìƒíƒœì—ì„œë„ íƒˆì¶œ
    if (mqttClient) {
      try {
        // ë¨¼ì € ê°€ì¥ ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ ê°•ì œ ì¤‘ì§€ ë©”ì‹œì§€ ë°œí–‰
        mqttClient.publish(AUTOMATION_CONTROL_TOPIC, JSON.stringify({
          action: 'force_stop',
          priority: 'highest',
          message: 'ì‚¬ìš©ìê°€ ì™„ì „ ì´ˆê¸°í™” ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ëª¨ë“  ê³µì •ì´ ê°•ì œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.',
          timestamp: Date.now()
        }));
        
        // ì§„í–‰ ìƒíƒœ ë©”ì‹œì§€ ì „ì†¡
        mqttClient.publish(PROCESS_PROGRESS_TOPIC, JSON.stringify({
          status: 'reset',
          message: 'ì‚¬ìš©ìê°€ ì™„ì „ ì´ˆê¸°í™” ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ëª¨ë“  ê³µì •ì´ ê°•ì œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.',
          timestamp: Date.now()
        }));
        
        // ì•½ê°„ì˜ ì§€ì—° í›„ í ì´ˆê¸°í™” ë©”ì‹œì§€ ë°œí–‰
        setTimeout(() => {
          mqttClient.publish(AUTOMATION_CONTROL_TOPIC, JSON.stringify({
            action: 'clear_all',
            priority: 'highest',
            timestamp: Date.now()
          }));
          
          console.log('í ì´ˆê¸°í™” ë©”ì‹œì§€ ë°œí–‰ ì™„ë£Œ');
        }, 300);
        
        console.log('ê°•ì œ ì¤‘ì§€ ë° ì´ˆê¸°í™” ë©”ì‹œì§€ ë°œí–‰ ì™„ë£Œ');
      } catch (error) {
        console.error('MQTT ë©”ì‹œì§€ ë°œí–‰ ì¤‘ ì˜¤ë¥˜:', error);
      }
    }
    
    // ìƒíƒœ ì´ˆê¸°í™”
    setStatus('waiting');
    setSelectedSequences([]);
    setCurrentSequenceIndex(-1);
    setLogs([]);
    setLogMessages([]);
    setWaitingCountdowns({});
    setShowTimePopup(null);
    setTempHours(0);
    setTempMinutes(0);
    setTempSeconds(0);
    setCountdownIntervals({});
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°ì´í„° ì™„ì „ ì œê±°
    if (typeof window !== 'undefined') {
      try {
        // ìë™í™” ê³µì • ê´€ë ¨ ëª¨ë“  í‚¤ ì œê±°
        localStorage.removeItem(AUTOMATION_STATE_KEY);
        localStorage.removeItem(AUTOMATION_SEQUENCES_KEY);
        
        // ì¶”ê°€ì ì¸ ê´€ë ¨ í‚¤ë„ ì‚­ì œ
        localStorage.removeItem('process-running-state');
        localStorage.removeItem('automation-last-state');
        localStorage.removeItem('automation-logs');
        
        console.log('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìë™í™” ê³µì • ë°ì´í„° ì™„ì „ ì œê±° ì™„ë£Œ');
      } catch (error) {
        console.error('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
      }
    }
    
    // ì•½ê°„ì˜ ì§€ì—° í›„ ì´ˆê¸°í™” ì™„ë£Œ ì²˜ë¦¬
    setTimeout(() => {
      // ì›¹ ìŠ¤í† ë¦¬ì§€ ì´ë²¤íŠ¸ ë°œìƒ ì‹œí‚¤ê¸° (ë‹¤ë¥¸ íƒ­ì— ì•Œë¦¼)
      if (typeof window !== 'undefined') {
        try {
          // ì™„ì „ ì´ˆê¸°í™”ë¥¼ ì•Œë¦¬ëŠ” ì´ë²¤íŠ¸ ë°œìƒ
          window.dispatchEvent(new StorageEvent('storage', {
            key: 'automation-force-reset',
            newValue: JSON.stringify({ 
              timestamp: Date.now(),
              action: 'force_reset_complete'
            })
          }));
          
          // ì²˜ë¦¬ ì™„ë£Œ í”Œë˜ê·¸ í•´ì œ
          processingAction.current = false;
          
          // MQTT ì¬ì—°ê²° ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë³µì›
          if (mqttClient) {
            // MQTT êµ¬ë… ë³µì› - êµ¬ë…ì´ ë¨¼ì € í•„ìš”í•¨
            mqttClient.subscribe(EXTRACTION_OUTPUT_TOPIC);
            mqttClient.subscribe(PROCESS_PROGRESS_TOPIC);
          }
          
          // ì´ˆê¸°í™” ì™„ë£Œ í† ìŠ¤íŠ¸ í‘œì‹œ
          toast({
            title: "ì™„ì „ ì´ˆê¸°í™” ì™„ë£Œ",
            description: "ëª¨ë“  ì„¤ì •ê³¼ ê³µì • ìƒíƒœê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹œí€€ìŠ¤ë¥¼ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì„¤ì •í•˜ì„¸ìš”.",
          });
          
          // ìƒˆë¡œê³ ì¹¨ ê¶Œì¥ ì•Œë¦¼ ì¶”ê°€
          toast({
            title: "í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ê¶Œì¥",
            description: "ì™„ì „í•œ ì´ˆê¸°í™”ë¥¼ ìœ„í•´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.",
            variant: "destructive"
          });
          
          console.log('ì™„ì „ ì´ˆê¸°í™” ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë¨');
        } catch (e) {
          console.error('ì™„ì „ ì´ˆê¸°í™” ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', e);
          processingAction.current = false;
        }
      }
    }, 1000);
  };
  
  // ì‹œí€€ìŠ¤ ì¶”ê°€/ì‚­ì œ ìµœì í™” - ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ë””ë°”ìš´ìŠ¤
  const debouncedSaveSequences = useCallback(
    debounce((sequences: SequenceWithStatus[]) => {
      if (typeof window !== 'undefined') {
        try {
          localStorage.setItem(AUTOMATION_SEQUENCES_KEY, JSON.stringify(sequences));
        } catch (error) {
          console.error('ì‹œí€€ìŠ¤ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
        }
      }
    }, 300), // 300ms ë””ë°”ìš´ìŠ¤
    []
  );
  
  // ì„ íƒëœ ì‹œí€€ìŠ¤ ë³€ê²½ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
  useEffect(() => {
    debouncedSaveSequences(selectedSequences);
  }, [selectedSequences, debouncedSaveSequences]);
  
  useEffect(() => {
    if (!mqttClient) return;
    
    console.log('MQTT í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì„¤ì • ì¤‘...');
    
    // MQTT ë©”ì‹œì§€ ì²˜ë¦¬
    const messageHandler = (topic: string, message: Buffer) => {
      try {
        const messageStr = message.toString();
        
        // í•„ìˆ˜ í† í”½ë§Œ ë¡œê·¸ì— ì¶œë ¥
        if (topic === EXTRACTION_INPUT_TOPIC) {
          console.log(`ğŸ“¤ [INPUT] ${messageStr.substring(0, 100)}...`);
        } 
        else if (topic === EXTRACTION_OUTPUT_TOPIC) {
          console.log(`ğŸ“¥ [OUTPUT] ${messageStr}`);
          // addLog ëŒ€ì‹  ì§ì ‘ ë¡œê·¸ ê°ì²´ ìƒì„±
          const newLog = {
            id: `log_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
            message: `OUTPUT: ${messageStr}`,
            timestamp: Date.now(),
            type: 'info' as const
          };
          setLogs(prevLogs => [...prevLogs, newLog].slice(-100));
          
          // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì²˜ë¦¬
          addLog(`ìƒíƒœ ë©”ì‹œì§€ ìˆ˜ì‹ : ${messageStr}`, true);
            
          // ê³µì • ì¢…ë£Œ ë©”ì‹œì§€ ê°ì§€ - í‚¤ì›Œë“œ í™•ì¥ ë° ë¡œê¹… ê°•í™”
          console.log(`ì¢…ë£Œ ë©”ì‹œì§€ ê°ì§€ ì‹œë„: ${messageStr}`);
          const isCompletionMessage = messageStr.toLowerCase().includes('ê³µì • ì¢…ë£Œ') || 
                                    messageStr.toLowerCase().includes('ê³µì •ì¢…ë£Œ');
          
          // ì™„ë£Œ ë©”ì‹œì§€ ê°ì§€ë˜ë©´ ê°•ì œ ì‹œí€€ìŠ¤ ì „í™˜ ì‹¤í–‰
          if (isCompletionMessage) {
            console.log(`ğŸš¨ ì™„ë£Œ ë©”ì‹œì§€ ê°ì§€: "${messageStr}"`);
            forceProgressToNextSequence();
            return;
          } else if (messageStr.includes("JSON ëª…ë ¹ì´ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤")) {
            // JSON ëª…ë ¹ ì„±ê³µ ë©”ì‹œì§€ - ì‹œí€€ìŠ¤ ì‹œì‘ì„ ì•Œë¦¼
            addLog(`ì‹œí€€ìŠ¤ ëª…ë ¹ì´ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`, true);
          }
        }
        else if (topic === PROCESS_PROGRESS_TOPIC) {
          console.log(`ğŸ“Š [PROGRESS] ${messageStr}`);
          
          // ë©”ì‹œì§€ í¬ê¸° ì œí•œ ì²˜ë¦¬ (10000ì ì´ìƒì¸ ê²½ìš° ì¶•ì•½)
          let displayMessage = messageStr;
          if (displayMessage && displayMessage.length > 10000) {
            console.warn(`ì§„í–‰ ìƒíƒœ ë©”ì‹œì§€ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤: ${displayMessage.length} ë°”ì´íŠ¸. ì˜ë¼ëƒ…ë‹ˆë‹¤.`);
            displayMessage = displayMessage.substring(0, 10000) + "... (ë©”ì‹œì§€ í¬ê¸° ì´ˆê³¼ë¡œ ì˜ë¦¼)";
          }
          
          // ì§„í–‰ ìƒíƒœ ë©”ì‹œì§€ ì €ì¥
          setProgress(displayMessage);
          
          // ë¡œê·¸ ê°ì²´ ì¶”ê°€ (logsëŠ” ë¡œê·¸ ê°ì²´ ë°°ì—´)
          const newLog = {
            id: `log_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
            message: `PROGRESS: ${displayMessage.substring(0, 100)}${displayMessage.length > 100 ? '...' : ''}`,
            timestamp: Date.now(),
            type: 'info' as const
          };
          setLogs(prevLogs => [...prevLogs, newLog].slice(-100));
          
          // ë¡œê·¸ ë©”ì‹œì§€ ì¶”ê°€ (logMessagesëŠ” ë¬¸ìì—´ ë°°ì—´)
          setLogMessages(prev => {
            const newMessage = `[${new Date().toLocaleTimeString()}] ì§„í–‰ ìƒíƒœ: ${displayMessage.substring(0, 50)}${displayMessage.length > 50 ? '...' : ''}`;
            return [newMessage, ...prev].slice(0, 100); // ìµœëŒ€ 100ê°œë§Œ ìœ ì§€
          });
          
          // JSON ë°ì´í„° ì²˜ë¦¬ (ì‹œí€€ìŠ¤ ì™„ë£Œ ê°ì§€)
          try {
            const data = JSON.parse(messageStr);
            
            // ì§„í–‰ ìƒíƒœ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‹œí€€ìŠ¤ ì™„ë£Œ ê°ì§€
            if (data && status === 'running' && currentSequenceIndex >= 0) {
              const currentSeq = selectedSequences[currentSequenceIndex];
              
              // ì™„ë£Œ ìƒíƒœ ê°ì§€
              if (data.process_info && data.process_info.includes("ì™„ë£Œ") && currentSeq && currentSeq.status === 'running') {
                console.log(`í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ ìƒíƒœ ê°ì§€: ${data.process_info}`);
                addLog(`ì‹œí€€ìŠ¤ ${currentSequenceIndex + 1} ì™„ë£Œë¨: ${currentSeq.sequence.name} (${data.process_info})`, true);
                handleSequenceCompletion(currentSequenceIndex, 'completed', 'ì§„í–‰ ìƒíƒœ ì™„ë£Œ');
              }
              // ì˜¤ë¥˜ ìƒíƒœ ê°ì§€
              else if (data.process_info && data.process_info.includes("ì˜¤ë¥˜") && currentSeq && currentSeq.status === 'running') {
                console.log(`í”„ë¡œì„¸ìŠ¤ ì˜¤ë¥˜ ìƒíƒœ ê°ì§€: ${data.process_info}`);
                addLog(`ì‹œí€€ìŠ¤ ${currentSequenceIndex + 1} ì˜¤ë¥˜ ë°œìƒ: ${currentSeq.sequence.name} (${data.process_info})`, true);
                handleSequenceCompletion(currentSequenceIndex, 'error', `ì§„í–‰ ìƒíƒœ ì˜¤ë¥˜: ${data.process_info}`);
              }
              
              // íŠ¹ë³„í•œ ìƒíƒœ ê°ì§€ - ë‚¨ì€ ì‹œê°„ì´ 0ì´ê³  ì‘ì—…ì´ ì™„ë£Œëœ ê²½ìš°
              if (data.remaining_time !== undefined && data.remaining_time === "0s" && currentSeq && currentSeq.status === 'running') {
                console.log(`ë‚¨ì€ ì‹œê°„ì´ 0ì´ˆì¸ ìƒíƒœ ê°ì§€, ì‘ì—… ì™„ë£Œ ì²˜ë¦¬`);
                addLog(`ì‹œí€€ìŠ¤ ${currentSequenceIndex + 1} ë‚¨ì€ ì‹œê°„ 0ì´ˆ, ì™„ë£Œ ì²˜ë¦¬: ${currentSeq.sequence.name}`, true);
                handleSequenceCompletion(currentSequenceIndex, 'completed', 'ë‚¨ì€ ì‹œê°„ 0ì´ˆ');
              }
            }
          } catch (error) {
            // JSON íŒŒì‹± ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ (í…ìŠ¤íŠ¸ ë©”ì‹œì§€ì¼ ìˆ˜ ìˆìŒ)
            // console.debug('ì§„í–‰ ìƒíƒœ ë©”ì‹œì§€ JSON íŒŒì‹± ì‹¤íŒ¨ (í…ìŠ¤íŠ¸ ë©”ì‹œì§€ì¼ ìˆ˜ ìˆìŒ):', error);
          }
        }
        
        // í ìƒíƒœ í† í”½ ì²˜ë¦¬
        if (topic === QUEUE_STATUS_TOPIC) {
          try {
            const queueData = JSON.parse(messageStr);
            // ì´ì „ ìƒíƒœì™€ ë¹„êµí•´ì„œ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
            setQueueStatus(prev => {
              // ìƒíƒœê°€ ë™ì¼í•˜ë©´ ì´ì „ ìƒíƒœ ê·¸ëŒ€ë¡œ ë°˜í™˜í•˜ì—¬ ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ ë°©ì§€
              if (prev && 
                  prev.count === queueData.count && 
                  prev.isProcessing === queueData.isProcessing) {
                return prev;
              }
              console.log(`[í ìƒíƒœ ì—…ë°ì´íŠ¸] í•­ëª© ìˆ˜: ${queueData.count}, ì²˜ë¦¬ ì¤‘: ${queueData.isProcessing}`);
              return queueData;
            });
          } catch (error) {
            console.error('í ìƒíƒœ ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
          }
        }
      } catch (error) {
        console.error('ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
      }
    };
    
    // MQTT êµ¬ë… ì„¤ì •
    mqttClient.on('message', messageHandler);
    
    // í•„ìˆ˜ í† í”½ êµ¬ë…
    mqttClient.subscribe(EXTRACTION_OUTPUT_TOPIC);
    mqttClient.subscribe(PROCESS_PROGRESS_TOPIC);
    mqttClient.subscribe(QUEUE_STATUS_TOPIC);
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì´ˆê¸° ìƒíƒœ ë¡œë“œëŠ” ì—¬ê¸°ì„œ ìˆ˜í–‰í•˜ì§€ ì•ŠìŒ
    // ë³„ë„ì˜ useEffectë¡œ ë¶„ë¦¬ë¨
    
    return () => {
    