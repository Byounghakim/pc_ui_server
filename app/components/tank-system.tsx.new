"use client"
import { motion } from "framer-motion"
import { useEffect, useState, useRef, useCallback } from "react"
import { MqttClient } from "mqtt"
import { cn } from '@/lib/utils';
import "./tank-system.css"; // ?ˆë¡œ ?ì„±??CSS ?Œì¼ import
import { PROCESS_PROGRESS_TOPIC, AUTOMATION_STATUS_TOPIC } from "@/lib/mqtt-topics"; // MQTT ? í”½ import
import { Tank } from '@/interface/tank'; // Tank ?¸í„°?˜ì´?¤ë§Œ ?„í¬??
// ê³ ìœ  ?´ë¼?´ì–¸??ID ?ì„± ?¨ìˆ˜
const generateClientId = () => {
  if (typeof window === 'undefined') return 'server';
  return `client_${Math.random().toString(36).substring(2, 15)}`;
};

// ?œê°„ ?•ì‹ ?¬ë§·???¨ìˆ˜ ì¶”ê?
const formatTimeStr = (): string => {
  const now = new Date();
  const hours = now.getHours().toString().padStart(2, '0');
  const minutes = now.getMinutes().toString().padStart(2, '0');
  const seconds = now.getSeconds().toString().padStart(2, '0');
  return `${hours}:${minutes}:${seconds}`;
};

// ?œìŠ¤???íƒœ ?€??ë°?ë¶ˆëŸ¬?¤ê¸° ?¨ìˆ˜ ê°œì„ 
const saveState = async (stateToSave: any) => {
  try {
    // ë¡œì»¬ ?¤í† ë¦¬ì????íƒœ ?€??    if (typeof window !== 'undefined') {
      localStorage.setItem('tankSystemState', JSON.stringify(stateToSave));
      
      // API ?¸ì¶œ ë¹„í™œ?±í™” - ?œë²„ API ?€??ë¡œì»¬ ?¤í† ë¦¬ì?ë§??¬ìš©
      console.log('?œë²„ API ?¸ì¶œ ?€??ë¡œì»¬ ?¤í† ë¦¬ì??ë§Œ ?€?¥í•©?ˆë‹¤.');
      
      // IndexedDB?ë„ ?€??      if (typeof saveToIndexedDB === 'function') {
        saveToIndexedDB(stateToSave);
      }
      
      // ?¤ë¥¸ ??ì°½ì— ?íƒœ ë³€ê²??Œë¦¼
      localStorage.setItem('tankSystemStateUpdate', Date.now().toString());
    }
  } catch (error) {
    console.error('?íƒœ ?€???¤íŒ¨:', error);
  }
};

// IndexedDB???íƒœ ?€??const saveToIndexedDB = (state: any) => {
  if (typeof window === 'undefined' || !window.indexedDB) {
    console.warn('IndexedDBë¥??¬ìš©?????†ìŠµ?ˆë‹¤.');
    return;
  }
  
  try {
    const request = window.indexedDB.open('TankSystemDB', 1);
    
    request.onupgradeneeded = function(event) {
      try {
        const db = request.result;
        if (!db.objectStoreNames.contains('systemState')) {
          db.createObjectStore('systemState', { keyPath: 'id' });
        }
      } catch (error) {
        console.error('IndexedDB ?¤í‚¤ë§??…ê·¸?ˆì´??ì¤??¤ë¥˜:', error);
        // ?¤ë¥˜ê°€ ë°œìƒ?´ë„ ê³„ì† ì§„í–‰
      }
    };
    
    request.onsuccess = function(event) {
      try {
        const db = request.result;
        const transaction = db.transaction(['systemState'], 'readwrite');
        const store = transaction.objectStore('systemState');
        
        // ??ƒ ê°™ì? ?¤ë¡œ ?€?¥í•˜??ìµœì‹  ?íƒœë§?? ì?
        const putRequest = store.put({
          id: 'currentState',
          data: state,
          timestamp: Date.now()
        });
        
        putRequest.onsuccess = function() {
          console.log('IndexedDB???íƒœ ?€???±ê³µ');
        };
        
        putRequest.onerror = function(event) {
          console.warn('IndexedDB ?°ì´???€??ì¤??¤ë¥˜:', event);
        };
        
        transaction.oncomplete = function() {
          db.close();
        };
        
        transaction.onerror = function(event) {
          console.warn('IndexedDB ?¸ëœ??…˜ ?¤ë¥˜:', event);
        };
      } catch (error) {
        console.error('IndexedDB ?¸ëœ??…˜ ?ì„± ì¤??¤ë¥˜:', error);
      }
    };
    
    request.onerror = function(event) {
      console.warn('IndexedDB ?´ê¸° ?¤ë¥˜:', event);
    };
  } catch (error) {
    console.error('IndexedDB ?‘ê·¼ ì¤??ˆìƒì¹?ëª»í•œ ?¤ë¥˜:', error);
  }
};

// ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¨ìˆ˜ ê°œì„ 
const loadState = () => {
  if (typeof window !== 'undefined') {
    try {
      const storedState = localStorage.getItem('tankSystemState');
      
      if (storedState) {
        return JSON.parse(storedState);
      }
      
      return null;
    } catch (error) {
      console.error('?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', error);
      return null;
    }
  }
  
  return null;
};

// ?œë²„?ì„œ ì´ˆê¸° ?íƒœ ë¶ˆëŸ¬?¤ê¸°
const loadInitialState = async (): Promise<any> => {
  if (typeof window !== 'undefined') {
    try {
      // ?œë²„ API?ì„œ ?íƒœ ê°€?¸ì˜¤ê¸?      if (window.navigator.onLine) {
        try {
          console.log('?œë²„?ì„œ ìµœì‹  ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?œë„...');
          console.log('API ?¸ì¶œ ?€??ë¡œì»¬ ?¤í† ë¦¬ì?ë§??¬ìš©?©ë‹ˆ??');
        } catch (serverError) {
          console.error('?œë²„?ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', serverError);
          // ?œë²„ ?¤ë¥˜ ??ê³„ì† ì§„í–‰ - ë¡œì»¬ ?€?¥ì†Œ ?¬ìš©
        }
      }
      
      // ?œë²„?ì„œ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨ ??ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ë¶ˆëŸ¬?¤ê¸° ?œë„
      try {
        const localState = loadState();
        if (localState) {
          console.log('ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ?íƒœë¥?ë¶ˆëŸ¬?”ìŠµ?ˆë‹¤.');
          return localState;
        }
      } catch (localError) {
        console.error('ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', localError);
        // ë¡œì»¬ ?¤í† ë¦¬ì? ?¤ë¥˜ ??ê³„ì† ì§„í–‰ - IndexedDB ?¬ìš©
      }
      
      // IndexedDB?ì„œ ë¶ˆëŸ¬?¤ê¸° ?œë„
      try {
        const idbState = await loadFromIndexedDB();
        if (idbState) {
          console.log('IndexedDB?ì„œ ?íƒœë¥?ë¶ˆëŸ¬?”ìŠµ?ˆë‹¤.');
          return idbState;
        }
      } catch (idbError) {
        console.error('IndexedDB?ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', idbError);
        // IndexedDB ?¤ë¥˜ ??ê¸°ë³¸ê°??¬ìš©
      }
    } catch (error) {
      console.error('ì´ˆê¸° ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?„ì²´ ?„ë¡œ?¸ìŠ¤ ?¤íŒ¨:', error);
      // ëª¨ë“  ?¤ë¥˜ ??ê¸°ë³¸ê°??¬ìš©
    }
  }
  
  console.log('?¬ìš© ê°€?¥í•œ ?€?¥ëœ ?íƒœê°€ ?†ìŠµ?ˆë‹¤. ê¸°ë³¸ê°??¬ìš©.');
  return null;
};

// IndexedDB?ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° (Promise ë°˜í™˜)
const loadFromIndexedDB = (): Promise<any> => {
  return new Promise((resolve, reject) => {
    if (typeof window === 'undefined' || !window.indexedDB) {
      console.warn('IndexedDBë¥??¬ìš©?????†ìŠµ?ˆë‹¤.');
      resolve(null);
      return;
    }
    
    try {
      const request = window.indexedDB.open('TankSystemDB', 1);
      
      request.onupgradeneeded = function(event) {
        try {
          const db = request.result;
          if (!db.objectStoreNames.contains('systemState')) {
            db.createObjectStore('systemState', { keyPath: 'id' });
          }
        } catch (error) {
          console.error('IndexedDB ?¤í‚¤ë§??…ê·¸?ˆì´??ì¤??¤ë¥˜:', error);
          // ?…ê·¸?ˆì´???¤ë¥˜ê°€ ë°œìƒ?´ë„ ê³„ì† ì§„í–‰ ê°€?¥í•˜?„ë¡ ??        }
      };
      
      request.onsuccess = function(event) {
        try {
          const db = request.result;
          const transaction = db.transaction(['systemState'], 'readonly');
          const store = transaction.objectStore('systemState');
          const getRequest = store.get('currentState');
          
          getRequest.onsuccess = function() {
            if (getRequest.result) {
              resolve(getRequest.result.data);
            } else {
              console.log('IndexedDB???€?¥ëœ ?íƒœê°€ ?†ìŠµ?ˆë‹¤.');
              resolve(null);
            }
          };
          
          getRequest.onerror = function(event) {
            console.warn('IndexedDB ?½ê¸° ?¤ë¥˜:', event);
            resolve(null); // ?¤ë¥˜ ë°œìƒ ?œì—??null??ë°˜í™˜?˜ì—¬ ?±ì´ ê³„ì† ?¤í–‰?˜ë„ë¡???          };
          
          transaction.oncomplete = function() {
            db.close();
          };
        } catch (error) {
          console.error('IndexedDB ?¸ëœ??…˜ ì¤??¤ë¥˜:', error);
          resolve(null);
        }
      };
      
      request.onerror = function(event) {
        console.warn('IndexedDB ?‘ê·¼ ?¤ë¥˜:', event);
        resolve(null); // reject ?€??resolve(null)???¬ìš©?˜ì—¬ ?±ì´ ê³„ì† ?¤í–‰?˜ë„ë¡???      };
    } catch (error) {
      console.error('IndexedDB ?¬ìš© ì¤??ˆìƒì¹?ëª»í•œ ?¤ë¥˜:', error);
      resolve(null); // ëª¨ë“  ?ˆì™¸ ?í™©?ì„œ???±ì´ ê³„ì† ?¤í–‰?˜ë„ë¡???    }
  });
};

interface TankSystemProps {
  tankData: {
    mainTank: {
      level: number
      status: string
    }
    tanks: Tank[]
    valveState: string
    valveStatusMessage?: string
    valveADesc?: string  // ë°¸ë¸Œ A ?¤ëª… ì¶”ê?
    valveBDesc?: string  // ë°¸ë¸Œ B ?¤ëª… ì¶”ê?
    tankMessages?: Record<number, string>
    mainTankMessage?: string
    progressInfo?: {
      step: string
      elapsedTime: string
      remainingTime: string
      totalRemainingTime: string
    }
  }
  onValveChange: (newState: string) => void
  onPumpToggle?: (pumpId: number) => void  // ?Œí”„ ? ê? ?¨ìˆ˜
  onPumpReset?: (pumpId: number) => void   // ?Œí”„ ë¦¬ì…‹ ?¨ìˆ˜
  onPumpKCommand?: (pumpId: number) => void // ?Œí”„ K ëª…ë ¹ ?¨ìˆ˜
  // onExtractionCommand ?ì„± ?œê±°??  pumpStateMessages?: Record<number, string> // ?Œí”„ ?íƒœ ë©”ì‹œì§€
  mqttClient?: MqttClient // MQTT ?´ë¼?´ì–¸??ì¶”ê?
  kButtonActive?: boolean // K ë²„íŠ¼ ?œì„±???¬ë?
  pumpMessages?: Record<number, string> // ?Œí”„ ë©”ì‹œì§€
  progressMessages?: Array<{timestamp: number, message: string, rawJson?: string | null}> // ì§„í–‰ ë©”ì‹œì§€ ì¶”ê?
  setProgressMessages?: (messages: Array<{timestamp: number, message: string, rawJson?: string | null}> | ((prev: Array<{timestamp: number, message: string, rawJson?: string | null}>) => Array<{timestamp: number, message: string, rawJson?: string | null}>)) => void // ì§„í–‰ ë©”ì‹œì§€ ?…ë°?´íŠ¸ ?¨ìˆ˜ ì¶”ê?
}

// ì¶”ì¶œ ì§„í–‰ ë©”ì‹œì§€ë¥??„í•œ ?¸í„°?˜ì´??interface ExtractionProgress {
  timestamp: number
  message: string
}

// ?°ê²° ?íƒœë¥??„í•œ ?¸í„°?˜ì´??interface ConnectionStatus {
  connected: boolean
  lastConnected: Date | null
  reconnecting: boolean
}

// ?„ìŠ¤ ? ë‹ˆë©”ì´?˜ì„ ?„í•œ ?¤í???ì¶”ê?
const pulseCss = `
  @keyframes pulse {
    0% {
      opacity: 0.6;
    }
    50% {
      opacity: 0.8;
    }
    100% {
      opacity: 0.6;
    }
  }
`;

// ?Œë¦¼???„í•œ ì»¤ìŠ¤?€ ?¸í„°?˜ì´???•ì˜
interface SystemNotification {
  message: string;
  timestamp: number;
  source?: string;
  type?: 'info' | 'warning' | 'error';
  pumpId?: number;
}

export default function TankSystem({ 
  tankData, 
  onValveChange, 
  progressMessages = [], 
  onPumpToggle, 
  onPumpReset,
  onPumpKCommand,
  pumpStateMessages = {},
  mqttClient,
  // onExtractionCommand ?ì„± ?œê±°??  kButtonActive,
  pumpMessages,
  setProgressMessages
}: TankSystemProps) {
  // MQTT ? í”½?ì„œ ì§„í–‰ ?•ë³´ ?Œì‹±???„í•œ ?¸í„°?˜ì´??ì¶”ê?
  interface ProcessProgress {
    mode: string;             // ?‘ë™ ëª¨ë“œ (?™ì‹œëª¨ë“œ, ?œì°¨ëª¨ë“œ, ?¤ë²„?©ëª¨??
    elapsed_time: number;     // ê²½ê³¼ ?œê°„ (ì´?
    remaining_time: number;   // ?¨ì? ?œê°„ (ì´?
    total_repeats: number;    // ì´?ë°˜ë³µ ?Ÿìˆ˜ 
    current_repeat: number;   // ?„ì¬ ë°˜ë³µ ?Ÿìˆ˜
    pump_id?: string;         // ?Œí”„ ID (?œì°¨ëª¨ë“œ, ?¤ë²„?©ëª¨?œì—???¬ìš©)
  }

  // ì§„í–‰ ?íƒœ ?•ë³´ ?€??(?Œí”„ IDë³?
  const [pumpProgressInfo, setPumpProgressInfo] = useState<Record<number, ProcessProgress>>({});
  const [isResetDragging, setIsResetDragging] = useState<Record<number, boolean>>({});
  const [dragStartPos, setDragStartPos] = useState<{x: number, y: number}>({x: 0, y: 0});
  const [isPumpDragging, setIsPumpDragging] = useState<Record<number, boolean>>({});
  const [pumpClickStatus, setPumpClickStatus] = useState<Record<number, boolean>>({});
  const [isPumpHolding, setIsPumpHolding] = useState<number | null>(null);
  const pumpHoldTimer = useRef<number | null>(null);
  const [lastProcessedMessage, setLastProcessedMessage] = useState<string>('');
  const [extractionStarted, setExtractionStarted] = useState<boolean>(false);
  const [extractionCompleteMessage, setExtractionCompleteMessage] = useState<string>("");
  const [automationStatus, setAutomationStatus] = useState<string>("");
"use client"
import { motion } from "framer-motion"
import { useEffect, useState, useRef, useCallback } from "react"
import { MqttClient } from "mqtt"
import { cn } from '@/lib/utils';
import "./tank-system.css"; // ?ˆë¡œ ?ì„±??CSS ?Œì¼ import
import { PROCESS_PROGRESS_TOPIC, AUTOMATION_STATUS_TOPIC } from "@/lib/mqtt-topics"; // MQTT ? í”½ import
import { Tank } from '@/interface/tank'; // Tank ?¸í„°?˜ì´?¤ë§Œ ?„í¬??
// ê³ ìœ  ?´ë¼?´ì–¸??ID ?ì„± ?¨ìˆ˜
const generateClientId = () => {
  if (typeof window === 'undefined') return 'server';
  return `client_${Math.random().toString(36).substring(2, 15)}`;
};

// ?œê°„ ?•ì‹ ?¬ë§·???¨ìˆ˜ ì¶”ê?
const formatTimeStr = (): string => {
  const now = new Date();
  const hours = now.getHours().toString().padStart(2, '0');
  const minutes = now.getMinutes().toString().padStart(2, '0');
  const seconds = now.getSeconds().toString().padStart(2, '0');
  return `${hours}:${minutes}:${seconds}`;
};

// ?œìŠ¤???íƒœ ?€??ë°?ë¶ˆëŸ¬?¤ê¸° ?¨ìˆ˜ ê°œì„ 
const saveState = async (stateToSave: any) => {
  try {
    // ë¡œì»¬ ?¤í† ë¦¬ì????íƒœ ?€??    if (typeof window !== 'undefined') {
      localStorage.setItem('tankSystemState', JSON.stringify(stateToSave));
      
      // API ?¸ì¶œ ë¹„í™œ?±í™” - ?œë²„ API ?€??ë¡œì»¬ ?¤í† ë¦¬ì?ë§??¬ìš©
      console.log('?œë²„ API ?¸ì¶œ ?€??ë¡œì»¬ ?¤í† ë¦¬ì??ë§Œ ?€?¥í•©?ˆë‹¤.');
      
      // IndexedDB?ë„ ?€??      if (typeof saveToIndexedDB === 'function') {
        saveToIndexedDB(stateToSave);
      }
      
      // ?¤ë¥¸ ??ì°½ì— ?íƒœ ë³€ê²??Œë¦¼
      localStorage.setItem('tankSystemStateUpdate', Date.now().toString());
    }
  } catch (error) {
    console.error('?íƒœ ?€???¤íŒ¨:', error);
  }
};

// IndexedDB???íƒœ ?€??const saveToIndexedDB = (state: any) => {
  if (typeof window === 'undefined' || !window.indexedDB) {
    console.warn('IndexedDBë¥??¬ìš©?????†ìŠµ?ˆë‹¤.');
    return;
  }
  
  try {
    const request = window.indexedDB.open('TankSystemDB', 1);
    
    request.onupgradeneeded = function(event) {
      try {
        const db = request.result;
        if (!db.objectStoreNames.contains('systemState')) {
          db.createObjectStore('systemState', { keyPath: 'id' });
        }
      } catch (error) {
        console.error('IndexedDB ?¤í‚¤ë§??…ê·¸?ˆì´??ì¤??¤ë¥˜:', error);
        // ?¤ë¥˜ê°€ ë°œìƒ?´ë„ ê³„ì† ì§„í–‰
      }
    };
    
    request.onsuccess = function(event) {
      try {
        const db = request.result;
        const transaction = db.transaction(['systemState'], 'readwrite');
        const store = transaction.objectStore('systemState');
        
        // ??ƒ ê°™ì? ?¤ë¡œ ?€?¥í•˜??ìµœì‹  ?íƒœë§?? ì?
        const putRequest = store.put({
          id: 'currentState',
          data: state,
          timestamp: Date.now()
        });
        
        putRequest.onsuccess = function() {
          console.log('IndexedDB???íƒœ ?€???±ê³µ');
        };
        
        putRequest.onerror = function(event) {
          console.warn('IndexedDB ?°ì´???€??ì¤??¤ë¥˜:', event);
        };
        
        transaction.oncomplete = function() {
          db.close();
        };
        
        transaction.onerror = function(event) {
          console.warn('IndexedDB ?¸ëœ??…˜ ?¤ë¥˜:', event);
        };
      } catch (error) {
        console.error('IndexedDB ?¸ëœ??…˜ ?ì„± ì¤??¤ë¥˜:', error);
      }
    };
    
    request.onerror = function(event) {
      console.warn('IndexedDB ?´ê¸° ?¤ë¥˜:', event);
    };
  } catch (error) {
    console.error('IndexedDB ?‘ê·¼ ì¤??ˆìƒì¹?ëª»í•œ ?¤ë¥˜:', error);
  }
};

// ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¨ìˆ˜ ê°œì„ 
const loadState = () => {
  if (typeof window !== 'undefined') {
    try {
      const storedState = localStorage.getItem('tankSystemState');
      
      if (storedState) {
        return JSON.parse(storedState);
      }
      
      return null;
    } catch (error) {
      console.error('?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', error);
      return null;
    }
  }
  
  return null;
};

// ?œë²„?ì„œ ì´ˆê¸° ?íƒœ ë¶ˆëŸ¬?¤ê¸°
const loadInitialState = async (): Promise<any> => {
  if (typeof window !== 'undefined') {
    try {
      // ?œë²„ API?ì„œ ?íƒœ ê°€?¸ì˜¤ê¸?      if (window.navigator.onLine) {
        try {
          console.log('?œë²„?ì„œ ìµœì‹  ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?œë„...');
          console.log('API ?¸ì¶œ ?€??ë¡œì»¬ ?¤í† ë¦¬ì?ë§??¬ìš©?©ë‹ˆ??');
        } catch (serverError) {
          console.error('?œë²„?ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', serverError);
          // ?œë²„ ?¤ë¥˜ ??ê³„ì† ì§„í–‰ - ë¡œì»¬ ?€?¥ì†Œ ?¬ìš©
        }
      }
      
      // ?œë²„?ì„œ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨ ??ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ë¶ˆëŸ¬?¤ê¸° ?œë„
      try {
        const localState = loadState();
        if (localState) {
          console.log('ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ?íƒœë¥?ë¶ˆëŸ¬?”ìŠµ?ˆë‹¤.');
          return localState;
        }
      } catch (localError) {
        console.error('ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', localError);
        // ë¡œì»¬ ?¤í† ë¦¬ì? ?¤ë¥˜ ??ê³„ì† ì§„í–‰ - IndexedDB ?¬ìš©
      }
      
      // IndexedDB?ì„œ ë¶ˆëŸ¬?¤ê¸° ?œë„
      try {
        const idbState = await loadFromIndexedDB();
        if (idbState) {
          console.log('IndexedDB?ì„œ ?íƒœë¥?ë¶ˆëŸ¬?”ìŠµ?ˆë‹¤.');
          return idbState;
        }
      } catch (idbError) {
        console.error('IndexedDB?ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', idbError);
        // IndexedDB ?¤ë¥˜ ??ê¸°ë³¸ê°??¬ìš©
      }
    } catch (error) {
      console.error('ì´ˆê¸° ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?„ì²´ ?„ë¡œ?¸ìŠ¤ ?¤íŒ¨:', error);
      // ëª¨ë“  ?¤ë¥˜ ??ê¸°ë³¸ê°??¬ìš©
    }
  }
  
  console.log('?¬ìš© ê°€?¥í•œ ?€?¥ëœ ?íƒœê°€ ?†ìŠµ?ˆë‹¤. ê¸°ë³¸ê°??¬ìš©.');
  return null;
};

// IndexedDB?ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° (Promise ë°˜í™˜)
const loadFromIndexedDB = (): Promise<any> => {
  return new Promise((resolve, reject) => {
    if (typeof window === 'undefined' || !window.indexedDB) {
      console.warn('IndexedDBë¥??¬ìš©?????†ìŠµ?ˆë‹¤.');
      resolve(null);
      return;
    }
    
    try {
      const request = window.indexedDB.open('TankSystemDB', 1);
      
      request.onupgradeneeded = function(event) {
        try {
          const db = request.result;
          if (!db.objectStoreNames.contains('systemState')) {
            db.createObjectStore('systemState', { keyPath: 'id' });
          }
        } catch (error) {
          console.error('IndexedDB ?¤í‚¤ë§??…ê·¸?ˆì´??ì¤??¤ë¥˜:', error);
          // ?…ê·¸?ˆì´???¤ë¥˜ê°€ ë°œìƒ?´ë„ ê³„ì† ì§„í–‰ ê°€?¥í•˜?„ë¡ ??        }
      };
      
      request.onsuccess = function(event) {
        try {
          const db = request.result;
          const transaction = db.transaction(['systemState'], 'readonly');
          const store = transaction.objectStore('systemState');
          const getRequest = store.get('currentState');
          
          getRequest.onsuccess = function() {
            if (getRequest.result) {
              resolve(getRequest.result.data);
            } else {
              console.log('IndexedDB???€?¥ëœ ?íƒœê°€ ?†ìŠµ?ˆë‹¤.');
              resolve(null);
            }
          };
          
          getRequest.onerror = function(event) {
            console.warn('IndexedDB ?½ê¸° ?¤ë¥˜:', event);
            resolve(null); // ?¤ë¥˜ ë°œìƒ ?œì—??null??ë°˜í™˜?˜ì—¬ ?±ì´ ê³„ì† ?¤í–‰?˜ë„ë¡???          };
          
          transaction.oncomplete = function() {
            db.close();
          };
        } catch (error) {
          console.error('IndexedDB ?¸ëœ??…˜ ì¤??¤ë¥˜:', error);
          resolve(null);
        }
      };
      
      request.onerror = function(event) {
        console.warn('IndexedDB ?‘ê·¼ ?¤ë¥˜:', event);
        resolve(null); // reject ?€??resolve(null)???¬ìš©?˜ì—¬ ?±ì´ ê³„ì† ?¤í–‰?˜ë„ë¡???      };
    } catch (error) {
      console.error('IndexedDB ?¬ìš© ì¤??ˆìƒì¹?ëª»í•œ ?¤ë¥˜:', error);
      resolve(null); // ëª¨ë“  ?ˆì™¸ ?í™©?ì„œ???±ì´ ê³„ì† ?¤í–‰?˜ë„ë¡???    }
  });
};

interface TankSystemProps {
  tankData: {
    mainTank: {
      level: number
      status: string
    }
    tanks: Tank[]
    valveState: string
    valveStatusMessage?: string
    valveADesc?: string  // ë°¸ë¸Œ A ?¤ëª… ì¶”ê?
    valveBDesc?: string  // ë°¸ë¸Œ B ?¤ëª… ì¶”ê?
    tankMessages?: Record<number, string>
    mainTankMessage?: string
    progressInfo?: {
      step: string
      elapsedTime: string
      remainingTime: string
      totalRemainingTime: string
    }
  }
  onValveChange: (newState: string) => void
  onPumpToggle?: (pumpId: number) => void  // ?Œí”„ ? ê? ?¨ìˆ˜
  onPumpReset?: (pumpId: number) => void   // ?Œí”„ ë¦¬ì…‹ ?¨ìˆ˜
  onPumpKCommand?: (pumpId: number) => void // ?Œí”„ K ëª…ë ¹ ?¨ìˆ˜
  // onExtractionCommand ?ì„± ?œê±°??  pumpStateMessages?: Record<number, string> // ?Œí”„ ?íƒœ ë©”ì‹œì§€
  mqttClient?: MqttClient // MQTT ?´ë¼?´ì–¸??ì¶”ê?
  kButtonActive?: boolean // K ë²„íŠ¼ ?œì„±???¬ë?
  pumpMessages?: Record<number, string> // ?Œí”„ ë©”ì‹œì§€
  progressMessages?: Array<{timestamp: number, message: string, rawJson?: string | null}> // ì§„í–‰ ë©”ì‹œì§€ ì¶”ê?
  setProgressMessages?: (messages: Array<{timestamp: number, message: string, rawJson?: string | null}> | ((prev: Array<{timestamp: number, message: string, rawJson?: string | null}>) => Array<{timestamp: number, message: string, rawJson?: string | null}>)) => void // ì§„í–‰ ë©”ì‹œì§€ ?…ë°?´íŠ¸ ?¨ìˆ˜ ì¶”ê?
}

// ì¶”ì¶œ ì§„í–‰ ë©”ì‹œì§€ë¥??„í•œ ?¸í„°?˜ì´??interface ExtractionProgress {
  timestamp: number
  message: string
}

// ?°ê²° ?íƒœë¥??„í•œ ?¸í„°?˜ì´??interface ConnectionStatus {
  connected: boolean
  lastConnected: Date | null
  reconnecting: boolean
}

// ?„ìŠ¤ ? ë‹ˆë©”ì´?˜ì„ ?„í•œ ?¤í???ì¶”ê?
const pulseCss = `
  @keyframes pulse {
    0% {
      opacity: 0.6;
    }
    50% {
      opacity: 0.8;
    }
    100% {
      opacity: 0.6;
    }
  }
`;

// ?Œë¦¼???„í•œ ì»¤ìŠ¤?€ ?¸í„°?˜ì´???•ì˜
interface SystemNotification {
  message: string;
  timestamp: number;
  source?: string;
  type?: 'info' | 'warning' | 'error';
  pumpId?: number;
}

export default function TankSystem({ 
  tankData, 
  onValveChange, 
  progressMessages = [], 
  onPumpToggle, 
  onPumpReset,
  onPumpKCommand,
  pumpStateMessages = {},
  mqttClient,
  // onExtractionCommand ?ì„± ?œê±°??  kButtonActive,
  pumpMessages,
  setProgressMessages
}: TankSystemProps) {
  // ê³ ìœ  ?´ë¼?´ì–¸??ID ?ì„± ?¨ìˆ˜
  const generateClientId = () => {
    if (typeof window === 'undefined') return 'server';
    return `client_${Math.random().toString(36).substring(2, 15)}`;
  };

  // MQTT ? í”½?ì„œ ì§„í–‰ ?•ë³´ ?Œì‹±???„í•œ ?¸í„°?˜ì´??ì¶”ê?
  interface ProcessProgress {
    mode: string;             // ?‘ë™ ëª¨ë“œ (?™ì‹œëª¨ë“œ, ?œì°¨ëª¨ë“œ, ?¤ë²„?©ëª¨??
    elapsed_time: number;     // ê²½ê³¼ ?œê°„ (ì´?
    remaining_time: number;   // ?¨ì? ?œê°„ (ì´?
    total_repeats: number;    // ì´?ë°˜ë³µ ?Ÿìˆ˜ 
    current_repeat: number;   // ?„ì¬ ë°˜ë³µ ?Ÿìˆ˜
    pump_id?: string;         // ?Œí”„ ID (?œì°¨ëª¨ë“œ, ?¤ë²„?©ëª¨?œì—???¬ìš©)
  }

  // ì§„í–‰ ?íƒœ ?•ë³´ ?€??(?Œí”„ IDë³?
  const [pumpProgressInfo, setPumpProgressInfo] = useState<Record<number, ProcessProgress>>({});
  const [isResetDragging, setIsResetDragging] = useState<Record<number, boolean>>({});
  const [dragStartPos, setDragStartPos] = useState<{x: number, y: number}>({x: 0, y: 0});
  const [isPumpDragging, setIsPumpDragging] = useState<Record<number, boolean>>({});
  const [pumpClickStatus, setPumpClickStatus] = useState<Record<number, boolean>>({});
  const [isPumpHolding, setIsPumpHolding] = useState<number | null>(null);
  const pumpHoldTimer = useRef<number | null>(null);
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [lastProcessedMessage, setLastProcessedMessage] = useState<string>('');
  const [extractionStarted, setExtractionStarted] = useState<boolean>(false);
  const [extractionCompleteMessage, setExtractionCompleteMessage] = useState<string>("");
  const [automationStatus, setAutomationStatus] = useState<string>("");
  const [automationProgress, setAutomationProgress] = useState<string>("");
  const [automationWaitTime, setAutomationWaitTime] = useState<{value: number, endTime?: number} | null>(null);
  const [lastProgressPercent, setLastProgressPercent] = useState<number>(0); // ì§„í–‰ë¥??íƒœ ì¶”ê?

  // ?Œì´???œì„±???íƒœ ê´€ë¦?  const [pipeActiveStatus, setPipeActiveStatus] = useState<Record<number, boolean>>({});

  // ì§„í–‰ ?•ë³´ ë©”ì‹œì§€ ?Œì‹± ?¨ìˆ˜ - extwork/extraction/progress ? í”½??  const parseProgressMessage = (messageStr: string): ProcessProgress | null => {
    try {
      // JSON ?Œì‹± ?œë„
      if (messageStr.startsWith('{') && messageStr.endsWith('}')) {
        const progressData = JSON.parse(messageStr);
        
        // ê¸°ë³¸ ?„ë“œ ?•ì¸
        if (progressData.elapsed_time && progressData.remaining_time) {
          // ê²½ê³¼ ?œê°„ê³??¨ì? ?œê°„??ì´??¨ìœ„ë¡??Œì‹±
          const elapsedStr = progressData.elapsed_time.replace('s', '');
          const remainingStr = progressData.remaining_time.replace('s', '');
          const elapsed = parseInt(elapsedStr, 10);
          const remaining = parseInt(remainingStr, 10);
          
          // ê¸°ë³¸ ?„ë¡œê·¸ë ˆ???•ë³´ ê°ì²´
          const progress: ProcessProgress = {
            mode: '',
            elapsed_time: elapsed,
            remaining_time: remaining,
            total_repeats: 1,
            current_repeat: 0,
            pump_id: undefined
          };
          
          // ëª¨ë“œ ?•ë³´ ?Œì‹±
          if (progressData.mode) {
            progress.mode = progressData.mode;
          } else if (messageStr.includes('?™ì‹œëª¨ë“œ')) {
            progress.mode = '?™ì‹œëª¨ë“œ';
          } else if (messageStr.includes('?œì°¨ëª¨ë“œ')) {
            progress.mode = '?œì°¨ëª¨ë“œ';
          } else if (messageStr.includes('?¤ë²„?©ëª¨??)) {
            progress.mode = '?¤ë²„?©ëª¨??;
          }
          
          // ë°˜ë³µ ?Ÿìˆ˜ ?•ë³´ ?Œì‹± - ?™ì‹œëª¨ë“œ
          if (progress.mode === '?™ì‹œëª¨ë“œ' && progressData.process_info) {
            const processMatch = progressData.process_info.match(/S\((\d+)\/(\d+)\)/);
            if (processMatch) {
              progress.current_repeat = parseInt(processMatch[1], 10);
              progress.total_repeats = parseInt(processMatch[2], 10) || 1; // 0?´ë©´ 1ë¡?ì²˜ë¦¬
            }
          }
          
          // ?Œí”„ ID ë°?ë°˜ë³µ ?Ÿìˆ˜ ?Œì‹± - ?œì°¨ëª¨ë“œ & ?¤ë²„?©ëª¨??          if ((progress.mode === '?œì°¨ëª¨ë“œ' || progress.mode === '?¤ë²„?©ëª¨??) && progressData.pump_id) {
            // ?•í™•???¨í„´ ë§¤ì¹­: "1(0/9)" ?•ì‹
            const pumpMatch = progressData.pump_id.match(/(\d+)\((\d+)\/(\d+)\)/);
            if (pumpMatch) {
              progress.pump_id = pumpMatch[1]; // ?Œí”„ ID (?? "1")
              
              // ?œì°¨ ëª¨ë“œ ê°œì„ : ?•í™•???„ì¬ ë°˜ë³µ ?Ÿìˆ˜?€ ì´?ë°˜ë³µ ?Ÿìˆ˜ ê³„ì‚°
              progress.current_repeat = parseInt(pumpMatch[2], 10); // ?„ì¬ ë°˜ë³µ ?Ÿìˆ˜ (?? 0)
              
              // ì´?ë°˜ë³µ ?Ÿìˆ˜ ì²˜ë¦¬ - 0ë¶€???œì‘?˜ë?ë¡?+1
              const totalRepeats = parseInt(pumpMatch[3], 10) + 1; // 0ë¶€???œì‘?˜ë?ë¡?+1
              progress.total_repeats = totalRepeats || 1; // ì´?ë°˜ë³µ ?Ÿìˆ˜ê°€ 0?´ë©´ 1ë¡??¤ì •
              
              console.log(`?Œí”„ ${progress.pump_id} ì§„í–‰ ?•ë³´ ?Œì‹±: ?„ì¬ ${progress.current_repeat+1}/${progress.total_repeats} ??(${((progress.current_repeat/progress.total_repeats)*100).toFixed(1)}% ì§„í–‰)`);
            }
          }
          
          return progress;
        }
      }
      
      // ?ìŠ¤???•ì‹?¼ë¡œ ??ë©”ì‹œì§€ ?Œì‹± ?œë„ (ë¹?JSON ?•ì‹)
      const elapsedMatch = messageStr.match(/ê²½ê³¼:\s*(\d+)s/) || messageStr.match(/elapsed_time":\s*"(\d+)s/);
      const remainingMatch = messageStr.match(/?¨ì?:\s*(\d+)s/) || messageStr.match(/remaining_time":\s*"(\d+)s/);
      
      if (elapsedMatch && remainingMatch) {
        const elapsed = parseInt(elapsedMatch[1], 10);
        const remaining = parseInt(remainingMatch[1], 10);
        
        // ê¸°ë³¸ ?„ë¡œê·¸ë ˆ???•ë³´ ê°ì²´
        const progress: ProcessProgress = {
          mode: '',
          elapsed_time: elapsed,
          remaining_time: remaining,
          total_repeats: 1,
          current_repeat: 0,
          pump_id: undefined
        };
        
        // ëª¨ë“œ ?•ë³´ ?Œì‹±
        if (messageStr.includes('?™ì‹œëª¨ë“œ')) {
          progress.mode = '?™ì‹œëª¨ë“œ';
          // ?™ì‹œëª¨ë“œ ë°˜ë³µ ?Ÿìˆ˜ ?•ë³´ ?Œì‹±
          const processMatch = messageStr.match(/S\((\d+)\/(\d+)\)/);
          if (processMatch) {
            progress.current_repeat = parseInt(processMatch[1], 10);
            progress.total_repeats = parseInt(processMatch[2], 10) || 1; // 0?´ë©´ 1ë¡?ì²˜ë¦¬
          }
        } else if (messageStr.includes('?œì°¨ëª¨ë“œ')) {
          progress.mode = '?œì°¨ëª¨ë“œ';
          
          // ?œì°¨ëª¨ë“œ ?Œí”„ ID ë°?ë°˜ë³µ ?Ÿìˆ˜ ?Œì‹± - ê°œì„ ???•ê·œ??          const pumpMatch = messageStr.match(/?Œí”„\s*(\d+)\s*\((\d+)\/(\d+)\)/) || 
                            messageStr.match(/(\d+)\((\d+)\/(\d+)\)/);
          
          if (pumpMatch) {
            progress.pump_id = pumpMatch[1]; // ?Œí”„ ID
            progress.current_repeat = parseInt(pumpMatch[2], 10); // ?„ì¬ ë°˜ë³µ ?Ÿìˆ˜
            
            // ì´?ë°˜ë³µ ?Ÿìˆ˜ ì²˜ë¦¬ - 0?´ë©´ 1ë¡??¤ì • (100% ì±„ì›Œì§?
            const totalRepeats = parseInt(pumpMatch[3], 10) + 1; // 0ë¶€???œì‘?˜ë?ë¡?+1
            progress.total_repeats = totalRepeats || 1;
            
            console.log(`[?ìŠ¤?? ?Œí”„ ${progress.pump_id} ?œì°¨ëª¨ë“œ ì§„í–‰ ?•ë³´: ${progress.current_repeat+1}/${progress.total_repeats} ??);
          }
        } else if (messageStr.includes('?¤ë²„?©ëª¨??)) {
          progress.mode = '?¤ë²„?©ëª¨??;
          
          // ?¤ë²„?©ëª¨???Œí”„ ID ë°?ë°˜ë³µ ?Ÿìˆ˜ ?Œì‹± - ê°œì„ ???•ê·œ??          const pumpMatch = messageStr.match(/?Œí”„\s*(\d+)\s*\((\d+)\/(\d+)\)/) || 
                            messageStr.match(/(\d+)\((\d+)\/(\d+)\)/);
                          
          if (pumpMatch) {
            progress.pump_id = pumpMatch[1]; // ?Œí”„ ID
            progress.current_repeat = parseInt(pumpMatch[2], 10); // ?„ì¬ ë°˜ë³µ ?Ÿìˆ˜
            
            // ì´?ë°˜ë³µ ?Ÿìˆ˜ ì²˜ë¦¬ - 0?´ë©´ 1ë¡??¤ì • (100% ì±„ì›Œì§?
            const totalRepeats = parseInt(pumpMatch[3], 10) + 1; // 0ë¶€???œì‘?˜ë?ë¡?+1
            progress.total_repeats = totalRepeats || 1;
            
            console.log(`[?ìŠ¤?? ?Œí”„ ${progress.pump_id} ?¤ë²„?©ëª¨??ì§„í–‰ ?•ë³´: ${progress.current_repeat+1}/${progress.total_repeats} ??);
          }
        }
        
        return progress;
      }
      
      return null;
    } catch (error) {
      console.error('ì§„í–‰ ?•ë³´ ?Œì‹± ?¤ë¥˜:', error);
      return null;
    }
  };

  // ? ë‹ˆë©”ì´?˜ì„ ?„í•œ ?íƒœ ì¶”ê?
  const [fillPercentage, setFillPercentage] = useState(0);
  
  // ê¸¸ê²Œ ?„ë¥´ê¸?ê°ì?ë¥??„í•œ ?€?´ë¨¸ ?íƒœ ì¶”ê?
  const [longPressTimer, setLongPressTimer] = useState<NodeJS.Timeout | null>(null);
  const [currentPressedPump, setCurrentPressedPump] = useState<number | null>(null);
  
  // ?´ë¼?´ì–¸??ID ?íƒœ ì¶”ê?
  const clientId = useRef(generateClientId());
  
  // ë§ˆì?ë§??íƒœ ?…ë°?´íŠ¸ ?œê°„
  const [lastStateUpdate, setLastStateUpdate] = useState<Date | null>(null);
  
  // ?°ê²° ?íƒœ ì¶”ê?
  const [connectionStatus, setConnectionStatus] = useState<ConnectionStatus>({
    connected: false,
    lastConnected: null,
    reconnecting: false
  });
  
  // ?íƒœ ë³€ê²??Œë¦¼???„í•œ ?íƒœ ?…ë°?´íŠ¸ - SystemNotification ?€???¬ìš©
  const [notificationsList, setNotificationsList] = useState<SystemNotification[]>([]);

  // ?Œë¦¼ ì¶”ê? ?¨ìˆ˜ 
  const addNotification = (message: string, type: 'info' | 'warning' | 'error' = 'info', pumpId?: number) => {
"use client"
import { motion } from "framer-motion"
import { useEffect, useState, useRef, useCallback } from "react"
import { MqttClient } from "mqtt"
import { cn } from '@/lib/utils';
import "./tank-system.css"; // ?ˆë¡œ ?ì„±??CSS ?Œì¼ import
import { PROCESS_PROGRESS_TOPIC, AUTOMATION_STATUS_TOPIC } from "@/lib/mqtt-topics"; // MQTT ? í”½ import
import { Tank } from '@/interface/tank'; // Tank ?¸í„°?˜ì´?¤ë§Œ ?„í¬??
// ê³ ìœ  ?´ë¼?´ì–¸??ID ?ì„± ?¨ìˆ˜
const generateClientId = () => {
  if (typeof window === 'undefined') return 'server';
  return `client_${Math.random().toString(36).substring(2, 15)}`;
};

// ?œê°„ ?•ì‹ ?¬ë§·???¨ìˆ˜ ì¶”ê?
const formatTimeStr = (): string => {
  const now = new Date();
  const hours = now.getHours().toString().padStart(2, '0');
  const minutes = now.getMinutes().toString().padStart(2, '0');
  const seconds = now.getSeconds().toString().padStart(2, '0');
  return `${hours}:${minutes}:${seconds}`;
};

// ?œìŠ¤???íƒœ ?€??ë°?ë¶ˆëŸ¬?¤ê¸° ?¨ìˆ˜ ê°œì„ 
const saveState = async (stateToSave: any) => {
  try {
    // ë¡œì»¬ ?¤í† ë¦¬ì????íƒœ ?€??    if (typeof window !== 'undefined') {
      localStorage.setItem('tankSystemState', JSON.stringify(stateToSave));
      
      // API ?¸ì¶œ ë¹„í™œ?±í™” - ?œë²„ API ?€??ë¡œì»¬ ?¤í† ë¦¬ì?ë§??¬ìš©
      console.log('?œë²„ API ?¸ì¶œ ?€??ë¡œì»¬ ?¤í† ë¦¬ì??ë§Œ ?€?¥í•©?ˆë‹¤.');
      
      // IndexedDB?ë„ ?€??      if (typeof saveToIndexedDB === 'function') {
        saveToIndexedDB(stateToSave);
      }
      
      // ?¤ë¥¸ ??ì°½ì— ?íƒœ ë³€ê²??Œë¦¼
      localStorage.setItem('tankSystemStateUpdate', Date.now().toString());
    }
  } catch (error) {
    console.error('?íƒœ ?€???¤íŒ¨:', error);
  }
};

// IndexedDB???íƒœ ?€??const saveToIndexedDB = (state: any) => {
  if (typeof window === 'undefined' || !window.indexedDB) {
    console.warn('IndexedDBë¥??¬ìš©?????†ìŠµ?ˆë‹¤.');
    return;
  }
  
  try {
    const request = window.indexedDB.open('TankSystemDB', 1);
    
    request.onupgradeneeded = function(event) {
      try {
        const db = request.result;
        if (!db.objectStoreNames.contains('systemState')) {
          db.createObjectStore('systemState', { keyPath: 'id' });
        }
      } catch (error) {
        console.error('IndexedDB ?¤í‚¤ë§??…ê·¸?ˆì´??ì¤??¤ë¥˜:', error);
        // ?¤ë¥˜ê°€ ë°œìƒ?´ë„ ê³„ì† ì§„í–‰
      }
    };
    
    request.onsuccess = function(event) {
      try {
        const db = request.result;
        const transaction = db.transaction(['systemState'], 'readwrite');
        const store = transaction.objectStore('systemState');
        
        // ??ƒ ê°™ì? ?¤ë¡œ ?€?¥í•˜??ìµœì‹  ?íƒœë§?? ì?
        const putRequest = store.put({
          id: 'currentState',
          data: state,
          timestamp: Date.now()
        });
        
        putRequest.onsuccess = function() {
          console.log('IndexedDB???íƒœ ?€???±ê³µ');
        };
        
        putRequest.onerror = function(event) {
          console.warn('IndexedDB ?°ì´???€??ì¤??¤ë¥˜:', event);
        };
        
        transaction.oncomplete = function() {
          db.close();
        };
        
        transaction.onerror = function(event) {
          console.warn('IndexedDB ?¸ëœ??…˜ ?¤ë¥˜:', event);
        };
      } catch (error) {
        console.error('IndexedDB ?¸ëœ??…˜ ?ì„± ì¤??¤ë¥˜:', error);
      }
    };
    
    request.onerror = function(event) {
      console.warn('IndexedDB ?´ê¸° ?¤ë¥˜:', event);
    };
  } catch (error) {
    console.error('IndexedDB ?‘ê·¼ ì¤??ˆìƒì¹?ëª»í•œ ?¤ë¥˜:', error);
  }
};

// ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¨ìˆ˜ ê°œì„ 
const loadState = () => {
  if (typeof window !== 'undefined') {
    try {
      const storedState = localStorage.getItem('tankSystemState');
      
      if (storedState) {
        return JSON.parse(storedState);
      }
      
      return null;
    } catch (error) {
      console.error('?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', error);
      return null;
    }
  }
  
  return null;
};

// ?œë²„?ì„œ ì´ˆê¸° ?íƒœ ë¶ˆëŸ¬?¤ê¸°
const loadInitialState = async (): Promise<any> => {
  if (typeof window !== 'undefined') {
    try {
      // ?œë²„ API?ì„œ ?íƒœ ê°€?¸ì˜¤ê¸?      if (window.navigator.onLine) {
        try {
          console.log('?œë²„?ì„œ ìµœì‹  ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?œë„...');
          console.log('API ?¸ì¶œ ?€??ë¡œì»¬ ?¤í† ë¦¬ì?ë§??¬ìš©?©ë‹ˆ??');
        } catch (serverError) {
          console.error('?œë²„?ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', serverError);
          // ?œë²„ ?¤ë¥˜ ??ê³„ì† ì§„í–‰ - ë¡œì»¬ ?€?¥ì†Œ ?¬ìš©
        }
      }
      
      // ?œë²„?ì„œ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨ ??ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ë¶ˆëŸ¬?¤ê¸° ?œë„
      try {
        const localState = loadState();
        if (localState) {
          console.log('ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ?íƒœë¥?ë¶ˆëŸ¬?”ìŠµ?ˆë‹¤.');
          return localState;
        }
      } catch (localError) {
        console.error('ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', localError);
        // ë¡œì»¬ ?¤í† ë¦¬ì? ?¤ë¥˜ ??ê³„ì† ì§„í–‰ - IndexedDB ?¬ìš©
      }
      
      // IndexedDB?ì„œ ë¶ˆëŸ¬?¤ê¸° ?œë„
      try {
        const idbState = await loadFromIndexedDB();
        if (idbState) {
          console.log('IndexedDB?ì„œ ?íƒœë¥?ë¶ˆëŸ¬?”ìŠµ?ˆë‹¤.');
          return idbState;
        }
      } catch (idbError) {
        console.error('IndexedDB?ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', idbError);
        // IndexedDB ?¤ë¥˜ ??ê¸°ë³¸ê°??¬ìš©
      }
    } catch (error) {
      console.error('ì´ˆê¸° ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?„ì²´ ?„ë¡œ?¸ìŠ¤ ?¤íŒ¨:', error);
      // ëª¨ë“  ?¤ë¥˜ ??ê¸°ë³¸ê°??¬ìš©
    }
  }
  
  console.log('?¬ìš© ê°€?¥í•œ ?€?¥ëœ ?íƒœê°€ ?†ìŠµ?ˆë‹¤. ê¸°ë³¸ê°??¬ìš©.');
  return null;
};

// IndexedDB?ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° (Promise ë°˜í™˜)
const loadFromIndexedDB = (): Promise<any> => {
  return new Promise((resolve, reject) => {
    if (typeof window === 'undefined' || !window.indexedDB) {
      console.warn('IndexedDBë¥??¬ìš©?????†ìŠµ?ˆë‹¤.');
      resolve(null);
      return;
    }
    
    try {
      const request = window.indexedDB.open('TankSystemDB', 1);
      
      request.onupgradeneeded = function(event) {
        try {
          const db = request.result;
          if (!db.objectStoreNames.contains('systemState')) {
            db.createObjectStore('systemState', { keyPath: 'id' });
          }
        } catch (error) {
          console.error('IndexedDB ?¤í‚¤ë§??…ê·¸?ˆì´??ì¤??¤ë¥˜:', error);
          // ?…ê·¸?ˆì´???¤ë¥˜ê°€ ë°œìƒ?´ë„ ê³„ì† ì§„í–‰ ê°€?¥í•˜?„ë¡ ??        }
      };
      
      request.onsuccess = function(event) {
        try {
          const db = request.result;
          const transaction = db.transaction(['systemState'], 'readonly');
          const store = transaction.objectStore('systemState');
          const getRequest = store.get('currentState');
          
          getRequest.onsuccess = function() {
            if (getRequest.result) {
              resolve(getRequest.result.data);
            } else {
              console.log('IndexedDB???€?¥ëœ ?íƒœê°€ ?†ìŠµ?ˆë‹¤.');
              resolve(null);
            }
          };
          
          getRequest.onerror = function(event) {
            console.warn('IndexedDB ?½ê¸° ?¤ë¥˜:', event);
            resolve(null); // ?¤ë¥˜ ë°œìƒ ?œì—??null??ë°˜í™˜?˜ì—¬ ?±ì´ ê³„ì† ?¤í–‰?˜ë„ë¡???          };
          
          transaction.oncomplete = function() {
            db.close();
          };
        } catch (error) {
          console.error('IndexedDB ?¸ëœ??…˜ ì¤??¤ë¥˜:', error);
          resolve(null);
        }
      };
      
      request.onerror = function(event) {
        console.warn('IndexedDB ?‘ê·¼ ?¤ë¥˜:', event);
        resolve(null); // reject ?€??resolve(null)???¬ìš©?˜ì—¬ ?±ì´ ê³„ì† ?¤í–‰?˜ë„ë¡???      };
    } catch (error) {
      console.error('IndexedDB ?¬ìš© ì¤??ˆìƒì¹?ëª»í•œ ?¤ë¥˜:', error);
      resolve(null); // ëª¨ë“  ?ˆì™¸ ?í™©?ì„œ???±ì´ ê³„ì† ?¤í–‰?˜ë„ë¡???    }
  });
};

interface TankSystemProps {
  tankData: {
    mainTank: {
      level: number
      status: string
    }
    tanks: Tank[]
    valveState: string
    valveStatusMessage?: string
    valveADesc?: string  // ë°¸ë¸Œ A ?¤ëª… ì¶”ê?
    valveBDesc?: string  // ë°¸ë¸Œ B ?¤ëª… ì¶”ê?
    tankMessages?: Record<number, string>
    mainTankMessage?: string
    progressInfo?: {
      step: string
      elapsedTime: string
      remainingTime: string
      totalRemainingTime: string
    }
  }
  onValveChange: (newState: string) => void
  onPumpToggle?: (pumpId: number) => void  // ?Œí”„ ? ê? ?¨ìˆ˜
  onPumpReset?: (pumpId: number) => void   // ?Œí”„ ë¦¬ì…‹ ?¨ìˆ˜
  onPumpKCommand?: (pumpId: number) => void // ?Œí”„ K ëª…ë ¹ ?¨ìˆ˜
  // onExtractionCommand ?ì„± ?œê±°??  pumpStateMessages?: Record<number, string> // ?Œí”„ ?íƒœ ë©”ì‹œì§€
  mqttClient?: MqttClient // MQTT ?´ë¼?´ì–¸??ì¶”ê?
  kButtonActive?: boolean // K ë²„íŠ¼ ?œì„±???¬ë?
  pumpMessages?: Record<number, string> // ?Œí”„ ë©”ì‹œì§€
  progressMessages?: Array<{timestamp: number, message: string, rawJson?: string | null}> // ì§„í–‰ ë©”ì‹œì§€ ì¶”ê?
  setProgressMessages?: (messages: Array<{timestamp: number, message: string, rawJson?: string | null}> | ((prev: Array<{timestamp: number, message: string, rawJson?: string | null}>) => Array<{timestamp: number, message: string, rawJson?: string | null}>)) => void // ì§„í–‰ ë©”ì‹œì§€ ?…ë°?´íŠ¸ ?¨ìˆ˜ ì¶”ê?
}

// ì¶”ì¶œ ì§„í–‰ ë©”ì‹œì§€ë¥??„í•œ ?¸í„°?˜ì´??interface ExtractionProgress {
  timestamp: number
  message: string
}

// ?°ê²° ?íƒœë¥??„í•œ ?¸í„°?˜ì´??interface ConnectionStatus {
  connected: boolean
  lastConnected: Date | null
  reconnecting: boolean
}

// ?„ìŠ¤ ? ë‹ˆë©”ì´?˜ì„ ?„í•œ ?¤í???ì¶”ê?
const pulseCss = `
  @keyframes pulse {
    0% {
      opacity: 0.6;
    }
    50% {
      opacity: 0.8;
    }
    100% {
      opacity: 0.6;
    }
  }
`;

export default function TankSystem({ 
  tankData, 
  onValveChange, 
  progressMessages = [], 
  onPumpToggle, 
  onPumpReset,
  onPumpKCommand,
  pumpStateMessages = {},
  mqttClient,
  // onExtractionCommand ?ì„± ?œê±°??  kButtonActive,
  pumpMessages,
  setProgressMessages
}: TankSystemProps) {
  // ê³ ìœ  ?´ë¼?´ì–¸??ID ?ì„± ?¨ìˆ˜
  const generateClientId = () => {
    if (typeof window === 'undefined') return 'server';
    return `client_${Math.random().toString(36).substring(2, 15)}`;
  };

  // MQTT ? í”½?ì„œ ì§„í–‰ ?•ë³´ ?Œì‹±???„í•œ ?¸í„°?˜ì´??ì¶”ê?
  interface ProcessProgress {
    mode: string;             // ?‘ë™ ëª¨ë“œ (?™ì‹œëª¨ë“œ, ?œì°¨ëª¨ë“œ, ?¤ë²„?©ëª¨??
    elapsed_time: number;     // ê²½ê³¼ ?œê°„ (ì´?
    remaining_time: number;   // ?¨ì? ?œê°„ (ì´?
    total_repeats: number;    // ì´?ë°˜ë³µ ?Ÿìˆ˜ 
    current_repeat: number;   // ?„ì¬ ë°˜ë³µ ?Ÿìˆ˜
    pump_id?: string;         // ?Œí”„ ID (?œì°¨ëª¨ë“œ, ?¤ë²„?©ëª¨?œì—???¬ìš©)
  }

  // ì§„í–‰ ?íƒœ ?•ë³´ ?€??(?Œí”„ IDë³?
  const [pumpProgressInfo, setPumpProgressInfo] = useState<Record<number, ProcessProgress>>({});
  const [isResetDragging, setIsResetDragging] = useState<Record<number, boolean>>({});
  const [dragStartPos, setDragStartPos] = useState<{x: number, y: number}>({x: 0, y: 0});
  const [isPumpDragging, setIsPumpDragging] = useState<Record<number, boolean>>({});
  const [pumpClickStatus, setPumpClickStatus] = useState<Record<number, boolean>>({});
  const [isPumpHolding, setIsPumpHolding] = useState<number | null>(null);
  const pumpHoldTimer = useRef<number | null>(null);
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [lastProcessedMessage, setLastProcessedMessage] = useState<string>('');
  const [extractionStarted, setExtractionStarted] = useState<boolean>(false);
  const [extractionCompleteMessage, setExtractionCompleteMessage] = useState<string>("");
  const [automationStatus, setAutomationStatus] = useState<string>("");
  const [automationProgress, setAutomationProgress] = useState<string>("");
  const [automationWaitTime, setAutomationWaitTime] = useState<{value: number, endTime?: number} | null>(null);
  const [lastProgressPercent, setLastProgressPercent] = useState<number>(0); // ì§„í–‰ë¥??íƒœ ì¶”ê?

  // ?Œì´???œì„±???íƒœ ê´€ë¦?  const [pipeActiveStatus, setPipeActiveStatus] = useState<Record<number, boolean>>({});

  // ì§„í–‰ ?•ë³´ ë©”ì‹œì§€ ?Œì‹± ?¨ìˆ˜ - extwork/extraction/progress ? í”½??  const parseProgressMessage = (messageStr: string): ProcessProgress | null => {
    try {
      // JSON ?Œì‹± ?œë„
      if (messageStr.startsWith('{') && messageStr.endsWith('}')) {
        const progressData = JSON.parse(messageStr);
        
        // ê¸°ë³¸ ?„ë“œ ?•ì¸
        if (progressData.elapsed_time && progressData.remaining_time) {
          // ê²½ê³¼ ?œê°„ê³??¨ì? ?œê°„??ì´??¨ìœ„ë¡??Œì‹±
          const elapsedStr = progressData.elapsed_time.replace('s', '');
          const remainingStr = progressData.remaining_time.replace('s', '');
          const elapsed = parseInt(elapsedStr, 10);
          const remaining = parseInt(remainingStr, 10);
          
          // ê¸°ë³¸ ?„ë¡œê·¸ë ˆ???•ë³´ ê°ì²´
          const progress: ProcessProgress = {
            mode: '',
            elapsed_time: elapsed,
            remaining_time: remaining,
            total_repeats: 1,
            current_repeat: 0,
            pump_id: undefined
          };
          
          // ëª¨ë“œ ?•ë³´ ?Œì‹±
          if (progressData.mode) {
            progress.mode = progressData.mode;
          } else if (messageStr.includes('?™ì‹œëª¨ë“œ')) {
            progress.mode = '?™ì‹œëª¨ë“œ';
          } else if (messageStr.includes('?œì°¨ëª¨ë“œ')) {
            progress.mode = '?œì°¨ëª¨ë“œ';
          } else if (messageStr.includes('?¤ë²„?©ëª¨??)) {
            progress.mode = '?¤ë²„?©ëª¨??;
          }
          
          // ë°˜ë³µ ?Ÿìˆ˜ ?•ë³´ ?Œì‹± - ?™ì‹œëª¨ë“œ
          if (progress.mode === '?™ì‹œëª¨ë“œ' && progressData.process_info) {
            const processMatch = progressData.process_info.match(/S\((\d+)\/(\d+)\)/);
            if (processMatch) {
              progress.current_repeat = parseInt(processMatch[1], 10);
              progress.total_repeats = parseInt(processMatch[2], 10) || 1; // 0?´ë©´ 1ë¡?ì²˜ë¦¬
            }
          }
          
          // ?Œí”„ ID ë°?ë°˜ë³µ ?Ÿìˆ˜ ?Œì‹± - ?œì°¨ëª¨ë“œ & ?¤ë²„?©ëª¨??          if ((progress.mode === '?œì°¨ëª¨ë“œ' || progress.mode === '?¤ë²„?©ëª¨??) && progressData.pump_id) {
            // ?•í™•???¨í„´ ë§¤ì¹­: "1(0/9)" ?•ì‹
            const pumpMatch = progressData.pump_id.match(/(\d+)\((\d+)\/(\d+)\)/);
            if (pumpMatch) {
              progress.pump_id = pumpMatch[1]; // ?Œí”„ ID (?? "1")
              
              // ?œì°¨ ëª¨ë“œ ê°œì„ : ?•í™•???„ì¬ ë°˜ë³µ ?Ÿìˆ˜?€ ì´?ë°˜ë³µ ?Ÿìˆ˜ ê³„ì‚°
              progress.current_repeat = parseInt(pumpMatch[2], 10); // ?„ì¬ ë°˜ë³µ ?Ÿìˆ˜ (?? 0)
              
              // ì´?ë°˜ë³µ ?Ÿìˆ˜ ì²˜ë¦¬ - 0ë¶€???œì‘?˜ë?ë¡?+1
              const totalRepeats = parseInt(pumpMatch[3], 10) + 1; // 0ë¶€???œì‘?˜ë?ë¡?+1
              progress.total_repeats = totalRepeats || 1; // ì´?ë°˜ë³µ ?Ÿìˆ˜ê°€ 0?´ë©´ 1ë¡??¤ì •
              
              console.log(`?Œí”„ ${progress.pump_id} ì§„í–‰ ?•ë³´ ?Œì‹±: ?„ì¬ ${progress.current_repeat+1}/${progress.total_repeats} ??(${((progress.current_repeat/progress.total_repeats)*100).toFixed(1)}% ì§„í–‰)`);
            }
          }
          
          return progress;
        }
      }
      
      // ?ìŠ¤???•ì‹?¼ë¡œ ??ë©”ì‹œì§€ ?Œì‹± ?œë„ (ë¹?JSON ?•ì‹)
      const elapsedMatch = messageStr.match(/ê²½ê³¼:\s*(\d+)s/) || messageStr.match(/elapsed_time":\s*"(\d+)s/);
      const remainingMatch = messageStr.match(/?¨ì?:\s*(\d+)s/) || messageStr.match(/remaining_time":\s*"(\d+)s/);
      
      if (elapsedMatch && remainingMatch) {
        const elapsed = parseInt(elapsedMatch[1], 10);
        const remaining = parseInt(remainingMatch[1], 10);
        
        // ê¸°ë³¸ ?„ë¡œê·¸ë ˆ???•ë³´ ê°ì²´
        const progress: ProcessProgress = {
          mode: '',
          elapsed_time: elapsed,
          remaining_time: remaining,
          total_repeats: 1,
          current_repeat: 0,
          pump_id: undefined
        };
        
        // ëª¨ë“œ ?•ë³´ ?Œì‹±
        if (messageStr.includes('?™ì‹œëª¨ë“œ')) {
          progress.mode = '?™ì‹œëª¨ë“œ';
          // ?™ì‹œëª¨ë“œ ë°˜ë³µ ?Ÿìˆ˜ ?•ë³´ ?Œì‹±
          const processMatch = messageStr.match(/S\((\d+)\/(\d+)\)/);
          if (processMatch) {
            progress.current_repeat = parseInt(processMatch[1], 10);
            progress.total_repeats = parseInt(processMatch[2], 10) || 1; // 0?´ë©´ 1ë¡?ì²˜ë¦¬
          }
        } else if (messageStr.includes('?œì°¨ëª¨ë“œ')) {
          progress.mode = '?œì°¨ëª¨ë“œ';
          
          // ?œì°¨ëª¨ë“œ ?Œí”„ ID ë°?ë°˜ë³µ ?Ÿìˆ˜ ?Œì‹± - ê°œì„ ???•ê·œ??          const pumpMatch = messageStr.match(/?Œí”„\s*(\d+)\s*\((\d+)\/(\d+)\)/) || 
                            messageStr.match(/(\d+)\((\d+)\/(\d+)\)/);
          
          if (pumpMatch) {
            progress.pump_id = pumpMatch[1]; // ?Œí”„ ID
            progress.current_repeat = parseInt(pumpMatch[2], 10); // ?„ì¬ ë°˜ë³µ ?Ÿìˆ˜
            
            // ì´?ë°˜ë³µ ?Ÿìˆ˜ ì²˜ë¦¬ - 0?´ë©´ 1ë¡??¤ì • (100% ì±„ì›Œì§?
            const totalRepeats = parseInt(pumpMatch[3], 10) + 1; // 0ë¶€???œì‘?˜ë?ë¡?+1
            progress.total_repeats = totalRepeats || 1;
            
            console.log(`[?ìŠ¤?? ?Œí”„ ${progress.pump_id} ?œì°¨ëª¨ë“œ ì§„í–‰ ?•ë³´: ${progress.current_repeat+1}/${progress.total_repeats} ??);
          }
        } else if (messageStr.includes('?¤ë²„?©ëª¨??)) {
          progress.mode = '?¤ë²„?©ëª¨??;
          
          // ?¤ë²„?©ëª¨???Œí”„ ID ë°?ë°˜ë³µ ?Ÿìˆ˜ ?Œì‹± - ê°œì„ ???•ê·œ??          const pumpMatch = messageStr.match(/?Œí”„\s*(\d+)\s*\((\d+)\/(\d+)\)/) || 
                            messageStr.match(/(\d+)\((\d+)\/(\d+)\)/);
                          
          if (pumpMatch) {
            progress.pump_id = pumpMatch[1]; // ?Œí”„ ID
            progress.current_repeat = parseInt(pumpMatch[2], 10); // ?„ì¬ ë°˜ë³µ ?Ÿìˆ˜
            
            // ì´?ë°˜ë³µ ?Ÿìˆ˜ ì²˜ë¦¬ - 0?´ë©´ 1ë¡??¤ì • (100% ì±„ì›Œì§?
            const totalRepeats = parseInt(pumpMatch[3], 10) + 1; // 0ë¶€???œì‘?˜ë?ë¡?+1
            progress.total_repeats = totalRepeats || 1;
            
            console.log(`[?ìŠ¤?? ?Œí”„ ${progress.pump_id} ?¤ë²„?©ëª¨??ì§„í–‰ ?•ë³´: ${progress.current_repeat+1}/${progress.total_repeats} ??);
          }
        }
        
        return progress;
      }
      
      return null;
    } catch (error) {
      console.error('ì§„í–‰ ?•ë³´ ?Œì‹± ?¤ë¥˜:', error);
      return null;
    }
  };

  // ? ë‹ˆë©”ì´?˜ì„ ?„í•œ ?íƒœ ì¶”ê?
  const [fillPercentage, setFillPercentage] = useState(0);
  
  // ê¸¸ê²Œ ?„ë¥´ê¸?ê°ì?ë¥??„í•œ ?€?´ë¨¸ ?íƒœ ì¶”ê?
  const [longPressTimer, setLongPressTimer] = useState<NodeJS.Timeout | null>(null);
  const [currentPressedPump, setCurrentPressedPump] = useState<number | null>(null);
  
  // ?´ë¼?´ì–¸??ID ?íƒœ ì¶”ê?
  const clientId = useRef(generateClientId());
  
  // ë§ˆì?ë§??íƒœ ?…ë°?´íŠ¸ ?œê°„
  const [lastStateUpdate, setLastStateUpdate] = useState<Date | null>(null);
  
  // ?°ê²° ?íƒœ ì¶”ê?
  const [connectionStatus, setConnectionStatus] = useState<ConnectionStatus>({
    connected: false,
    lastConnected: null,
    reconnecting: false
  });
  
  // ?íƒœ ë³€ê²??Œë¦¼???„í•œ ?íƒœ ?…ë°?´íŠ¸ - SystemNotification ?€???¬ìš©
  const [notifications, setNotifications] = useState<SystemNotification[]>([]);

  // ?Œë¦¼ ì¶”ê? ?¨ìˆ˜ 
  const addNotification = (message: string, type: 'info' | 'warning' | 'error' = 'info', pumpId?: number) => {
    const notification: SystemNotification = {
      message,
      timestamp: Date.now(),
      type,
      pumpId,
      source: '?œìŠ¤??
    };
    
"use client"
import { motion } from "framer-motion"
import { useEffect, useState, useRef, useCallback } from "react"
import { MqttClient } from "mqtt"
import { cn } from '@/lib/utils';
import "./tank-system.css"; // ?ˆë¡œ ?ì„±??CSS ?Œì¼ import
import { PROCESS_PROGRESS_TOPIC, AUTOMATION_STATUS_TOPIC } from "@/lib/mqtt-topics"; // MQTT ? í”½ import
import { Tank } from '@/interface/tank'; // Tank ?¸í„°?˜ì´?¤ë§Œ ?„í¬??
// ê³ ìœ  ?´ë¼?´ì–¸??ID ?ì„± ?¨ìˆ˜
const generateClientId = () => {
  if (typeof window === 'undefined') return 'server';
  return `client_${Math.random().toString(36).substring(2, 15)}`;
};

// ?œìŠ¤???íƒœ ?€??ë°?ë¶ˆëŸ¬?¤ê¸° ?¨ìˆ˜ ê°œì„ 
const saveState = async (stateToSave: any) => {
  try {
    // ë¡œì»¬ ?¤í† ë¦¬ì????íƒœ ?€??    if (typeof window !== 'undefined') {
      localStorage.setItem('tankSystemState', JSON.stringify(stateToSave));
      
      // API ?¸ì¶œ ë¹„í™œ?±í™” - ?œë²„ API ?€??ë¡œì»¬ ?¤í† ë¦¬ì?ë§??¬ìš©
      console.log('?œë²„ API ?¸ì¶œ ?€??ë¡œì»¬ ?¤í† ë¦¬ì??ë§Œ ?€?¥í•©?ˆë‹¤.');
      
      // IndexedDB?ë„ ?€??      if (typeof saveToIndexedDB === 'function') {
        saveToIndexedDB(stateToSave);
      }
      
      // ?¤ë¥¸ ??ì°½ì— ?íƒœ ë³€ê²??Œë¦¼
      localStorage.setItem('tankSystemStateUpdate', Date.now().toString());
    }
  } catch (error) {
    console.error('?íƒœ ?€???¤íŒ¨:', error);
  }
};

// IndexedDB???íƒœ ?€??const saveToIndexedDB = (state: any) => {
  if (typeof window === 'undefined' || !window.indexedDB) {
    console.warn('IndexedDBë¥??¬ìš©?????†ìŠµ?ˆë‹¤.');
    return;
  }
  
  try {
    const request = window.indexedDB.open('TankSystemDB', 1);
    
    request.onupgradeneeded = function(event) {
      try {
        const db = request.result;
        if (!db.objectStoreNames.contains('systemState')) {
          db.createObjectStore('systemState', { keyPath: 'id' });
        }
      } catch (error) {
        console.error('IndexedDB ?¤í‚¤ë§??…ê·¸?ˆì´??ì¤??¤ë¥˜:', error);
        // ?¤ë¥˜ê°€ ë°œìƒ?´ë„ ê³„ì† ì§„í–‰
      }
    };
    
    request.onsuccess = function(event) {
      try {
        const db = request.result;
        const transaction = db.transaction(['systemState'], 'readwrite');
        const store = transaction.objectStore('systemState');
        
        // ??ƒ ê°™ì? ?¤ë¡œ ?€?¥í•˜??ìµœì‹  ?íƒœë§?? ì?
        const putRequest = store.put({
          id: 'currentState',
          data: state,
          timestamp: Date.now()
        });
        
        putRequest.onsuccess = function() {
          console.log('IndexedDB???íƒœ ?€???±ê³µ');
        };
        
        putRequest.onerror = function(event) {
          console.warn('IndexedDB ?°ì´???€??ì¤??¤ë¥˜:', event);
        };
        
        transaction.oncomplete = function() {
          db.close();
        };
        
        transaction.onerror = function(event) {
          console.warn('IndexedDB ?¸ëœ??…˜ ?¤ë¥˜:', event);
        };
      } catch (error) {
        console.error('IndexedDB ?¸ëœ??…˜ ?ì„± ì¤??¤ë¥˜:', error);
      }
    };
    
    request.onerror = function(event) {
      console.warn('IndexedDB ?´ê¸° ?¤ë¥˜:', event);
    };
  } catch (error) {
    console.error('IndexedDB ?‘ê·¼ ì¤??ˆìƒì¹?ëª»í•œ ?¤ë¥˜:', error);
  }
};

// ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¨ìˆ˜ ê°œì„ 
const loadState = () => {
  if (typeof window !== 'undefined') {
    try {
      const storedState = localStorage.getItem('tankSystemState');
      
      if (storedState) {
        return JSON.parse(storedState);
      }
      
      return null;
    } catch (error) {
      console.error('?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', error);
      return null;
    }
  }
  
  return null;
};

// ?œë²„?ì„œ ì´ˆê¸° ?íƒœ ë¶ˆëŸ¬?¤ê¸°
const loadInitialState = async (): Promise<any> => {
  if (typeof window !== 'undefined') {
    try {
      // ?œë²„ API?ì„œ ?íƒœ ê°€?¸ì˜¤ê¸?      if (window.navigator.onLine) {
        try {
          console.log('?œë²„?ì„œ ìµœì‹  ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?œë„...');
          console.log('API ?¸ì¶œ ?€??ë¡œì»¬ ?¤í† ë¦¬ì?ë§??¬ìš©?©ë‹ˆ??');
        } catch (serverError) {
          console.error('?œë²„?ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', serverError);
          // ?œë²„ ?¤ë¥˜ ??ê³„ì† ì§„í–‰ - ë¡œì»¬ ?€?¥ì†Œ ?¬ìš©
        }
      }
      
      // ?œë²„?ì„œ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨ ??ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ë¶ˆëŸ¬?¤ê¸° ?œë„
      try {
        const localState = loadState();
        if (localState) {
          console.log('ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ?íƒœë¥?ë¶ˆëŸ¬?”ìŠµ?ˆë‹¤.');
          return localState;
        }
      } catch (localError) {
        console.error('ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', localError);
        // ë¡œì»¬ ?¤í† ë¦¬ì? ?¤ë¥˜ ??ê³„ì† ì§„í–‰ - IndexedDB ?¬ìš©
      }
      
      // IndexedDB?ì„œ ë¶ˆëŸ¬?¤ê¸° ?œë„
      try {
        const idbState = await loadFromIndexedDB();
        if (idbState) {
          console.log('IndexedDB?ì„œ ?íƒœë¥?ë¶ˆëŸ¬?”ìŠµ?ˆë‹¤.');
          return idbState;
        }
      } catch (idbError) {
        console.error('IndexedDB?ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?¤íŒ¨:', idbError);
        // IndexedDB ?¤ë¥˜ ??ê¸°ë³¸ê°??¬ìš©
      }
    } catch (error) {
      console.error('ì´ˆê¸° ?íƒœ ë¶ˆëŸ¬?¤ê¸° ?„ì²´ ?„ë¡œ?¸ìŠ¤ ?¤íŒ¨:', error);
      // ëª¨ë“  ?¤ë¥˜ ??ê¸°ë³¸ê°??¬ìš©
    }
  }
  
  console.log('?¬ìš© ê°€?¥í•œ ?€?¥ëœ ?íƒœê°€ ?†ìŠµ?ˆë‹¤. ê¸°ë³¸ê°??¬ìš©.');
  return null;
};

// IndexedDB?ì„œ ?íƒœ ë¶ˆëŸ¬?¤ê¸° (Promise ë°˜í™˜)
const loadFromIndexedDB = (): Promise<any> => {
  return new Promise((resolve, reject) => {
    if (typeof window === 'undefined' || !window.indexedDB) {
      console.warn('IndexedDBë¥??¬ìš©?????†ìŠµ?ˆë‹¤.');
      resolve(null);
      return;
    }
    
    try {
      const request = window.indexedDB.open('TankSystemDB', 1);
      
      request.onupgradeneeded = function(event) {
        try {
          const db = request.result;
          if (!db.objectStoreNames.contains('systemState')) {
            db.createObjectStore('systemState', { keyPath: 'id' });
          }
        } catch (error) {
          console.error('IndexedDB ?¤í‚¤ë§??…ê·¸?ˆì´??ì¤??¤ë¥˜:', error);
          // ?…ê·¸?ˆì´???¤ë¥˜ê°€ ë°œìƒ?´ë„ ê³„ì† ì§„í–‰ ê°€?¥í•˜?„ë¡ ??        }
      };
      
      request.onsuccess = function(event) {
        try {
          const db = request.result;
          const transaction = db.transaction(['systemState'], 'readonly');
          const store = transaction.objectStore('systemState');
          const getRequest = store.get('currentState');
          
          getRequest.onsuccess = function() {
            if (getRequest.result) {
              resolve(getRequest.result.data);
            } else {
              console.log('IndexedDB???€?¥ëœ ?íƒœê°€ ?†ìŠµ?ˆë‹¤.');
              resolve(null);
            }
          };
          
          getRequest.onerror = function(event) {
            console.warn('IndexedDB ?½ê¸° ?¤ë¥˜:', event);
            resolve(null); // ?¤ë¥˜ ë°œìƒ ?œì—??null??ë°˜í™˜?˜ì—¬ ?±ì´ ê³„ì† ?¤í–‰?˜ë„ë¡???          };
          
          transaction.oncomplete = function() {
            db.close();
          };
        } catch (error) {
          console.error('IndexedDB ?¸ëœ??…˜ ì¤??¤ë¥˜:', error);
          resolve(null);
        }
      };
      
      request.onerror = function(event) {
        console.warn('IndexedDB ?‘ê·¼ ?¤ë¥˜:', event);
        resolve(null); // reject ?€??resolve(null)???¬ìš©?˜ì—¬ ?±ì´ ê³„ì† ?¤í–‰?˜ë„ë¡???      };
    } catch (error) {
      console.error('IndexedDB ?¬ìš© ì¤??ˆìƒì¹?ëª»í•œ ?¤ë¥˜:', error);
      resolve(null); // ëª¨ë“  ?ˆì™¸ ?í™©?ì„œ???±ì´ ê³„ì† ?¤í–‰?˜ë„ë¡???    }
  });
};

interface TankSystemProps {
  tankData: {
    mainTank: {
      level: number
      status: string
    }
    tanks: Tank[]
    valveState: string
    valveStatusMessage?: string
    valveADesc?: string  // ë°¸ë¸Œ A ?¤ëª… ì¶”ê?
    valveBDesc?: string  // ë°¸ë¸Œ B ?¤ëª… ì¶”ê?
    tankMessages?: Record<number, string>
    mainTankMessage?: string
    progressInfo?: {
      step: string
      elapsedTime: string
      remainingTime: string
      totalRemainingTime: string
    }
  }
  onValveChange: (newState: string) => void
  onPumpToggle?: (pumpId: number) => void  // ?Œí”„ ? ê? ?¨ìˆ˜
  onPumpReset?: (pumpId: number) => void   // ?Œí”„ ë¦¬ì…‹ ?¨ìˆ˜
  onPumpKCommand?: (pumpId: number) => void // ?Œí”„ K ëª…ë ¹ ?¨ìˆ˜
  // onExtractionCommand ?ì„± ?œê±°??  pumpStateMessages?: Record<number, string> // ?Œí”„ ?íƒœ ë©”ì‹œì§€
  mqttClient?: MqttClient // MQTT ?´ë¼?´ì–¸??ì¶”ê?
  kButtonActive?: boolean // K ë²„íŠ¼ ?œì„±???¬ë?
  pumpMessages?: Record<number, string> // ?Œí”„ ë©”ì‹œì§€
  progressMessages?: Array<{timestamp: number, message: string, rawJson?: string | null}> // ì§„í–‰ ë©”ì‹œì§€ ì¶”ê?
  setProgressMessages?: (messages: Array<{timestamp: number, message: string, rawJson?: string | null}> | ((prev: Array<{timestamp: number, message: string, rawJson?: string | null}>) => Array<{timestamp: number, message: string, rawJson?: string | null}>)) => void // ì§„í–‰ ë©”ì‹œì§€ ?…ë°?´íŠ¸ ?¨ìˆ˜ ì¶”ê?
}

// ì¶”ì¶œ ì§„í–‰ ë©”ì‹œì§€ë¥??„í•œ ?¸í„°?˜ì´??interface ExtractionProgress {
  timestamp: number
  message: string
}

// ?°ê²° ?íƒœë¥??„í•œ ?¸í„°?˜ì´??interface ConnectionStatus {
  connected: boolean
  lastConnected: Date | null
  reconnecting: boolean
}

// ?„ìŠ¤ ? ë‹ˆë©”ì´?˜ì„ ?„í•œ ?¤í???ì¶”ê?
const pulseCss = `
  @keyframes pulse {
    0% {
      opacity: 0.6;
    }
    50% {
      opacity: 0.8;
    }
    100% {
      opacity: 0.6;
    }
  }
`;

export default function TankSystem({ 
  tankData, 
  onValveChange, 
  progressMessages = [], 
  onPumpToggle, 
  onPumpReset,
  onPumpKCommand,
  pumpStateMessages = {},
  mqttClient,
  // onExtractionCommand ?ì„± ?œê±°??  kButtonActive,
  pumpMessages,
  setProgressMessages
}: TankSystemProps) {
  // ê³ ìœ  ?´ë¼?´ì–¸??ID ?ì„± ?¨ìˆ˜
  const generateClientId = () => {
    if (typeof window === 'undefined') return 'server';
    return `client_${Math.random().toString(36).substring(2, 15)}`;
  };

  // MQTT ? í”½?ì„œ ì§„í–‰ ?•ë³´ ?Œì‹±???„í•œ ?¸í„°?˜ì´??ì¶”ê?
  interface ProcessProgress {
    mode: string;             // ?‘ë™ ëª¨ë“œ (?™ì‹œëª¨ë“œ, ?œì°¨ëª¨ë“œ, ?¤ë²„?©ëª¨??
    elapsed_time: number;     // ê²½ê³¼ ?œê°„ (ì´?
    remaining_time: number;   // ?¨ì? ?œê°„ (ì´?
    total_repeats: number;    // ì´?ë°˜ë³µ ?Ÿìˆ˜ 
    current_repeat: number;   // ?„ì¬ ë°˜ë³µ ?Ÿìˆ˜
    pump_id?: string;         // ?Œí”„ ID (?œì°¨ëª¨ë“œ, ?¤ë²„?©ëª¨?œì—???¬ìš©)
  }

  // ì§„í–‰ ?íƒœ ?•ë³´ ?€??(?Œí”„ IDë³?
  const [pumpProgressInfo, setPumpProgressInfo] = useState<Record<number, ProcessProgress>>({});
  const [isResetDragging, setIsResetDragging] = useState<Record<number, boolean>>({});
  const [dragStartPos, setDragStartPos] = useState<{x: number, y: number}>({x: 0, y: 0});
  const [isPumpDragging, setIsPumpDragging] = useState<Record<number, boolean>>({});
  const [pumpClickStatus, setPumpClickStatus] = useState<Record<number, boolean>>({});
  const [isPumpHolding, setIsPumpHolding] = useState<number | null>(null);
  const pumpHoldTimer = useRef<number | null>(null);
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [lastProcessedMessage, setLastProcessedMessage] = useState<string>('');
  const [extractionStarted, setExtractionStarted] = useState<boolean>(false);
  const [extractionCompleteMessage, setExtractionCompleteMessage] = useState<string>("");
  const [automationStatus, setAutomationStatus] = useState<string>("");
  const [automationProgress, setAutomationProgress] = useState<string>("");
  const [automationWaitTime, setAutomationWaitTime] = useState<{value: number, endTime?: number} | null>(null);
  const [lastProgressPercent, setLastProgressPercent] = useState<number>(0); // ì§„í–‰ë¥??íƒœ ì¶”ê?

  // ?Œì´???œì„±???íƒœ ê´€ë¦?  const [pipeActiveStatus, setPipeActiveStatus] = useState<Record<number, boolean>>({});

  // ì§„í–‰ ?•ë³´ ë©”ì‹œì§€ ?Œì‹± ?¨ìˆ˜ - extwork/extraction/progress ? í”½??  const parseProgressMessage = (messageStr: string): ProcessProgress | null => {
    try {
      // JSON ?Œì‹± ?œë„
      if (messageStr.startsWith('{') && messageStr.endsWith('}')) {
        const progressData = JSON.parse(messageStr);
        
        // ê¸°ë³¸ ?„ë“œ ?•ì¸
        if (progressData.elapsed_time && progressData.remaining_time) {
          // ê²½ê³¼ ?œê°„ê³??¨ì? ?œê°„??ì´??¨ìœ„ë¡??Œì‹±
          const elapsedStr = progressData.elapsed_time.replace('s', '');
          const remainingStr = progressData.remaining_time.replace('s', '');
          const elapsed = parseInt(elapsedStr, 10);
          const remaining = parseInt(remainingStr, 10);
          
          // ê¸°ë³¸ ?„ë¡œê·¸ë ˆ???•ë³´ ê°ì²´
          const progress: ProcessProgress = {
            mode: '',
            elapsed_time: elapsed,
            remaining_time: remaining,
            total_repeats: 1,
            current_repeat: 0,
            pump_id: undefined
          };
          
          // ëª¨ë“œ ?•ë³´ ?Œì‹±
          if (progressData.mode) {
            progress.mode = progressData.mode;
          } else if (messageStr.includes('?™ì‹œëª¨ë“œ')) {
            progress.mode = '?™ì‹œëª¨ë“œ';
          } else if (messageStr.includes('?œì°¨ëª¨ë“œ')) {
            progress.mode = '?œì°¨ëª¨ë“œ';
          } else if (messageStr.includes('?¤ë²„?©ëª¨??)) {
            progress.mode = '?¤ë²„?©ëª¨??;
          }
          
          // ë°˜ë³µ ?Ÿìˆ˜ ?•ë³´ ?Œì‹± - ?™ì‹œëª¨ë“œ
          if (progress.mode === '?™ì‹œëª¨ë“œ' && progressData.process_info) {
            const processMatch = progressData.process_info.match(/S\((\d+)\/(\d+)\)/);
            if (processMatch) {
              progress.current_repeat = parseInt(processMatch[1], 10);
              progress.total_repeats = parseInt(processMatch[2], 10) || 1; // 0?´ë©´ 1ë¡?ì²˜ë¦¬
            }
          }
          
          // ?Œí”„ ID ë°?ë°˜ë³µ ?Ÿìˆ˜ ?Œì‹± - ?œì°¨ëª¨ë“œ & ?¤ë²„?©ëª¨??          if ((progress.mode === '?œì°¨ëª¨ë“œ' || progress.mode === '?¤ë²„?©ëª¨??) && progressData.pump_id) {
            // ?•í™•???¨í„´ ë§¤ì¹­: "1(0/9)" ?•ì‹
            const pumpMatch = progressData.pump_id.match(/(\d+)\((\d+)\/(\d+)\)/);
            if (pumpMatch) {
              progress.pump_id = pumpMatch[1]; // ?Œí”„ ID (?? "1")
              
              // ?œì°¨ ëª¨ë“œ ê°œì„ : ?•í™•???„ì¬ ë°˜ë³µ ?Ÿìˆ˜?€ ì´?ë°˜ë³µ ?Ÿìˆ˜ ê³„ì‚°
              progress.current_repeat = parseInt(pumpMatch[2], 10); // ?„ì¬ ë°˜ë³µ ?Ÿìˆ˜ (?? 0)
              
              // ì´?ë°˜ë³µ ?Ÿìˆ˜ ì²˜ë¦¬ - 0ë¶€???œì‘?˜ë?ë¡?+1
              const totalRepeats = parseInt(pumpMatch[3], 10) + 1; // 0ë¶€???œì‘?˜ë?ë¡?+1
              progress.total_repeats = totalRepeats || 1; // ì´?ë°˜ë³µ ?Ÿìˆ˜ê°€ 0?´ë©´ 1ë¡??¤ì •
              
              console.log(`?Œí”„ ${progress.pump_id} ì§„í–‰ ?•ë³´ ?Œì‹±: ?„ì¬ ${progress.current_repeat+1}/${progress.total_repeats} ??(${((progress.current_repeat/progress.total_repeats)*100).toFixed(1)}% ì§„í–‰)`);
            }
          }
          
          return progress;
        }
      }
      
      // ?ìŠ¤???•ì‹?¼ë¡œ ??ë©”ì‹œì§€ ?Œì‹± ?œë„ (ë¹?JSON ?•ì‹)
      const elapsedMatch = messageStr.match(/ê²½ê³¼:\s*(\d+)s/) || messageStr.match(/elapsed_time":\s*"(\d+)s/);
      const remainingMatch = messageStr.match(/?¨ì?:\s*(\d+)s/) || messageStr.match(/remaining_time":\s*"(\d+)s/);
      
      if (elapsedMatch && remainingMatch) {
        const elapsed = parseInt(elapsedMatch[1], 10);
        const remaining = parseInt(remainingMatch[1], 10);
        
        // ê¸°ë³¸ ?„ë¡œê·¸ë ˆ???•ë³´ ê°ì²´
        const progress: ProcessProgress = {
          mode: '',
          elapsed_time: elapsed,
          remaining_time: remaining,
          total_repeats: 1,
          current_repeat: 0,
          pump_id: undefined
        };
        
        // ëª¨ë“œ ?•ë³´ ?Œì‹±
        if (messageStr.includes('?™ì‹œëª¨ë“œ')) {
          progress.mode = '?™ì‹œëª¨ë“œ';
          // ?™ì‹œëª¨ë“œ ë°˜ë³µ ?Ÿìˆ˜ ?•ë³´ ?Œì‹±
          const processMatch = messageStr.match(/S\((\d+)\/(\d+)\)/);
          if (processMatch) {
            progress.current_repeat = parseInt(processMatch[1], 10);
            progress.total_repeats = parseInt(processMatch[2], 10) || 1; // 0?´ë©´ 1ë¡?ì²˜ë¦¬
          }
        } else if (messageStr.includes('?œì°¨ëª¨ë“œ')) {
          progress.mode = '?œì°¨ëª¨ë“œ';
          
          // ?œì°¨ëª¨ë“œ ?Œí”„ ID ë°?ë°˜ë³µ ?Ÿìˆ˜ ?Œì‹± - ê°œì„ ???•ê·œ??          const pumpMatch = messageStr.match(/?Œí”„\s*(\d+)\s*\((\d+)\/(\d+)\)/) || 
                            messageStr.match(/(\d+)\((\d+)\/(\d+)\)/);
          
          if (pumpMatch) {
            progress.pump_id = pumpMatch[1]; // ?Œí”„ ID
            progress.current_repeat = parseInt(pumpMatch[2], 10); // ?„ì¬ ë°˜ë³µ ?Ÿìˆ˜
            
            // ì´?ë°˜ë³µ ?Ÿìˆ˜ ì²˜ë¦¬ - 0?´ë©´ 1ë¡??¤ì • (100% ì±„ì›Œì§?
            const totalRepeats = parseInt(pumpMatch[3], 10) + 1; // 0ë¶€???œì‘?˜ë?ë¡?+1
            progress.total_repeats = totalRepeats || 1;
            
            console.log(`[?ìŠ¤?? ?Œí”„ ${progress.pump_id} ?œì°¨ëª¨ë“œ ì§„í–‰ ?•ë³´: ${progress.current_repeat+1}/${progress.total_repeats} ??);
          }
        } else if (messageStr.includes('?¤ë²„?©ëª¨??)) {
          progress.mode = '?¤ë²„?©ëª¨??;
          
          // ?¤ë²„?©ëª¨???Œí”„ ID ë°?ë°˜ë³µ ?Ÿìˆ˜ ?Œì‹± - ê°œì„ ???•ê·œ??          const pumpMatch = messageStr.match(/?Œí”„\s*(\d+)\s*\((\d+)\/(\d+)\)/) || 
                            messageStr.match(/(\d+)\((\d+)\/(\d+)\)/);
                          
          if (pumpMatch) {
            progress.pump_id = pumpMatch[1]; // ?Œí”„ ID
            progress.current_repeat = parseInt(pumpMatch[2], 10); // ?„ì¬ ë°˜ë³µ ?Ÿìˆ˜
            
            // ì´?ë°˜ë³µ ?Ÿìˆ˜ ì²˜ë¦¬ - 0?´ë©´ 1ë¡??¤ì • (100% ì±„ì›Œì§?
            const totalRepeats = parseInt(pumpMatch[3], 10) + 1; // 0ë¶€???œì‘?˜ë?ë¡?+1
            progress.total_repeats = totalRepeats || 1;
            
            console.log(`[?ìŠ¤?? ?Œí”„ ${progress.pump_id} ?¤ë²„?©ëª¨??ì§„í–‰ ?•ë³´: ${progress.current_repeat+1}/${progress.total_repeats} ??);
          }
        }
        
        return progress;
      }
      
      return null;
    } catch (error) {
      console.error('ì§„í–‰ ?•ë³´ ?Œì‹± ?¤ë¥˜:', error);
      return null;
    }
  };

  // ? ë‹ˆë©”ì´?˜ì„ ?„í•œ ?íƒœ ì¶”ê?
  const [fillPercentage, setFillPercentage] = useState(0);
  
  // ê¸¸ê²Œ ?„ë¥´ê¸?ê°ì?ë¥??„í•œ ?€?´ë¨¸ ?íƒœ ì¶”ê?
  const [longPressTimer, setLongPressTimer] = useState<NodeJS.Timeout | null>(null);
  const [currentPressedPump, setCurrentPressedPump] = useState<number | null>(null);
  
  // ?´ë¼?´ì–¸??ID ?íƒœ ì¶”ê?
  const clientId = useRef(generateClientId());
  
  // ë§ˆì?ë§??íƒœ ?…ë°?´íŠ¸ ?œê°„
  const [lastStateUpdate, setLastStateUpdate] = useState<Date | null>(null);
  
  // ?°ê²° ?íƒœ ì¶”ê?
  const [connectionStatus, setConnectionStatus] = useState<ConnectionStatus>({
    connected: false,
    lastConnected: null,
    reconnecting: false
  });
  
  // ?íƒœ ë³€ê²??Œë¦¼???„í•œ ?íƒœ ?…ë°?´íŠ¸
  const [notifications, setNotifications] = useState<Array<{
    message: string,
    timestamp: number,
    source?: string,
    type?: 'info' | 'warning' | 'error', // ?Œë¦¼ ? í˜• ì¶”ê?
    pumpId?: number // ?Œí”„ ID ì¶”ê?
  }>>([]);

  // ?Œë¦¼ ì¶”ê? ?¨ìˆ˜ 
  const addNotification = (message: string, type: 'info' | 'warning' | 'error' = 'info', pumpId?: number) => {
    const notification = {
      message,
      timestamp: Date.now(),
      type,
      pumpId,
      source: '?œìŠ¤??
    };
    
    // ?Œë¦¼ ëª©ë¡??ì¶”ê?
    setNotifications(prev => [...prev, notification]);
    
    // 15ì´????Œë¦¼ ?ë™ ?œê±°
    setTimeout(() => {
      setNotifications(prev => 
        prev.filter(n => n.timestamp !== notification.timestamp)
      );
    }, 15000);
    
    // MQTTë¥??µí•´ ?Œë¦¼ ê³µìœ  (?¤ë¥¸ ?´ë¼?´ì–¸?¸ì—ê²Œë„ ?Œë¦¼)
    if (mqttClient) {
      mqttClient.publish('tank-system/notifications', JSON.stringify({
        ...notification,
        clientId: clientId.current
      }));
    }
  };

  // ?Œí”„ ?¤ìœ„ì¹??œë˜ê·??íƒœ
  const [pumpSwitchPosition, setPumpSwitchPosition] = useState<Record<number, number>>({
    1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 // ëª¨ë“  ?Œí”„???€??ì´ˆê¸° ?¤ìœ„ì¹??„ì¹˜ ?¤ì •
  });
  const [draggingPump, setDraggingPump] = useState<number | null>(null);
  const [resetTimers, setResetTimers] = useState<Record<number, NodeJS.Timeout | null>>({});
  const [resetSwitchPosition, setResetSwitchPosition] = useState<Record<number, number>>({});
  // ?Œí”„ ë¦¬ì…‹ ?œë˜ê·??íƒœ ì¶”ê?
  const [resetDragState, setResetDragState] = useState<Record<number, { dragging: boolean, position: number, timer: NodeJS.Timeout | null }>>({});
  
  // MQTT ?´ë¼?´ì–¸???°ê²° ?íƒœ ëª¨ë‹ˆ?°ë§
  useEffect(() => {
    if (!mqttClient) return;
    
    const subscribeTankTopics = () => {
      console.log('?±í¬ ? í”½ êµ¬ë… ì¤?..');
      
      // ?„ìš”??? í”½ êµ¬ë…
      for (let i = 1; i <= 6; i++) {
        // ?±í¬ ?˜ìœ„ ? í”½ êµ¬ë…
        mqttClient.subscribe(`extwork/inverter${i}/tank${i}_level`);
        
        // 2ë²??±í¬ ?˜ìœ„ ë¬¸ì œ ?´ê²°: ëª¨ë“  ?±í¬-?¸ë²„??ì¡°í•© êµ¬ë…
        for (let j = 1; j <= 6; j++) {
          if (i !== j) { // ?„ì—???´ë? êµ¬ë…???™ì¼ ë²ˆí˜¸ ì¡°í•©?€ ?œì™¸
            mqttClient.subscribe(`extwork/inverter${i}/tank${j}_level`);
            console.log(`ì¶”ê? êµ¬ë…: extwork/inverter${i}/tank${j}_level`);
          }
        }
        
        // ?¸ë²„???íƒœ ? í”½ êµ¬ë… (?Œí”„ ?íƒœ)
        mqttClient.subscribe(`extwork/inverter${i}/state`);
        
        // ?¸ë²„???°ê²° ?íƒœ ? í”½ êµ¬ë…
        mqttClient.subscribe(`extwork/inverter${i}/overallstate`);
      }
      
      // ë³¸íƒ±???˜ìœ„ ? í”½ êµ¬ë…
      mqttClient.subscribe('extwork/tank/level');
      
      // ?ë™??ê³µì • ê´€??? í”½ êµ¬ë…
      mqttClient.subscribe(AUTOMATION_STATUS_TOPIC);
      mqttClient.subscribe(PROCESS_PROGRESS_TOPIC);
      
      // ì¶”ì¶œ ëª…ë ¹ ?…ë ¥ ? í”½ êµ¬ë… ì¶”ê?
      mqttClient.subscribe('extwork/extraction/input');
      
      // STATUS ?”ì²­ ?œê±° - Redis?ì„œ ?íƒœë¥?ê°€?¸ì˜¤?„ë¡ ë³€ê²?      // ë°¸ë¸Œ, ?Œí”„ ?íƒœ??MQTT ë©”ì‹œì§€ë¥??µí•´ ?…ë°?´íŠ¸
      console.log('Redisë¥??µí•´ ?œìŠ¤???íƒœë¥?ê´€ë¦¬í•©?ˆë‹¤.');
    };
    
    // MQTT ?´ë¼?´ì–¸???°ê²° ??êµ¬ë… ?¤ì •
    mqttClient.on('connect', () => {
      console.log('MQTT ?°ê²°?? ?±í¬ ? í”½ êµ¬ë…');
      setConnectionStatus({
        connected: true,
        lastConnected: new Date(),
        reconnecting: false
      });
      
      subscribeTankTopics();
    });
    
    // ?°ê²° ?Šê? ì²˜ë¦¬
    mqttClient.on('disconnect', () => {
      console.log('MQTT ?°ê²° ?Šê?');
      setConnectionStatus(prev => ({
        ...prev,
        connected: false
      }));
    });
    
    // ?´ë? ?°ê²°?˜ì–´ ?ˆëŠ” ê²½ìš° êµ¬ë… ?¤í–‰
    if (mqttClient.connected) {
      subscribeTankTopics();
    }
    
    // ?°ê²° ?´ë²¤??ë¦¬ìŠ¤???±ë¡
    mqttClient.on('connect', subscribeTankTopics);
    
    const handleMessage = (topic: string, message: Buffer) => {
      const messageStr = message.toString();
      console.log(`MQTT ë©”ì‹œì§€ ?˜ì‹ : ${topic} - ${messageStr}`);
      
      try {
        // extwork/extraction/input ? í”½ ì²˜ë¦¬ ì¶”ê?
        if (topic === 'extwork/extraction/input') {
          console.log(`ì¶”ì¶œ ?…ë ¥ ëª…ë ¹ ?˜ì‹ : ${messageStr}`);
          
          try {
            // JSON ?°ì´???Œì‹± ?œë„
            const jsonData = JSON.parse(messageStr);
            
            // ë°›ì? ëª…ë ¹ ?€?¥í•˜ê¸?(?œê°„ ì¶”ê??˜ì—¬ ë©”ì‹œì§€ ë³´ê?)
            const timeStr = formatTimeStr();
            const displayMessage = `??ê³µì • ëª…ë ¹ ?˜ì‹ : ${jsonData.name || jsonData.sequences?.[0]?.name || 'JSON ëª…ë ¹'} (${timeStr})`;
            
            // ?Œë¦¼ ì¶”ê?
            addNotification(`??ê³µì • ëª…ë ¹???˜ì‹ ?˜ì—ˆ?µë‹ˆ?? ${jsonData.name || jsonData.sequences?.[0]?.name || 'JSON ëª…ë ¹'}`, 'info');
            
            // progress ë©”ì‹œì§€ ?…ë°?´íŠ¸ - rawJson ?„ë“œ???ë³¸ JSON ?°ì´???€??            if (setProgressMessages) {
              setProgressMessages(prev => [{
                timestamp: Date.now(),
                message: displayMessage,
                rawJson: messageStr
              }, ...prev]);
            }
            
            // ë¡œê·¸ ì¶œë ¥
            console.log(`ì¶”ì¶œ ëª…ë ¹ ì²˜ë¦¬?? ${displayMessage}`);
          } catch (parseError) {
            console.error('ì¶”ì¶œ ?…ë ¥ ëª…ë ¹ ?Œì‹± ?¤ë¥˜:', parseError);
            
            // ?Œì‹± ?¤íŒ¨?´ë„ ?Œë¦¼?€ ?„ì›Œì¤?            addNotification('ì¶”ì¶œ ëª…ë ¹???˜ì‹ ?ˆì?ë§?ì²˜ë¦¬?????†ìŠµ?ˆë‹¤. ?•ì‹???•ì¸?´ì£¼?¸ìš”.', 'error');
            
            // ?Œì‹± ?¤íŒ¨ ë©”ì‹œì§€ ì¶”ê?
            if (setProgressMessages) {
              setProgressMessages(prev => [{
                timestamp: Date.now(),
                message: `?¤ë¥˜: ?˜ì‹ ??ëª…ë ¹??JSON ?•ì‹???˜ëª»?˜ì—ˆ?µë‹ˆ??`,
                rawJson: null
              }, ...prev]);
            }
          }
          return; // ?¤ë¥¸ ?¸ë“¤???¸ì¶œ?˜ì? ?Šê³  ì¢…ë£Œ
        }
        // ? í”½???°ë¥¸ ì²˜ë¦¬
        else if (topic === 'tank-system/notifications') {
          const notification = JSON.parse(messageStr);
          
          // ?ì‹ ??ë°œìƒ?œí‚¨ ?Œë¦¼???„ë‹Œ ê²½ìš°?ë§Œ ì²˜ë¦¬
          if (notification.clientId !== clientId.current) {
            setNotifications(prev => [
              ...prev,
              {
                message: notification.message,
                timestamp: notification.timestamp,
                source: notification.clientId,
                type: notification.type || 'info',
                pumpId: notification.pumpId
              }
            ]);
            
            // 15ì´????Œë¦¼ ?œê±°
            setTimeout(() => {
              setNotifications(prev => 
                prev.filter(n => n.timestamp !== notification.timestamp)
              );
            }, 15000);
          }
        } else if (topic === 'extwork/tankMain/level') {
          // ë³¸íƒ±???˜ìœ„ ?•ë³´ ?…ë°?´íŠ¸
          console.log(`ë³¸íƒ±??ë©”ì‹œì§€ ?˜ì‹ : ${messageStr}`);
          
          // ?œê°„ ë¬¸ì???ì„±
          const timeStr = formatTimeStr();
          
          // ?ŒìŠ¤??ë©”ì‹œì§€ ì²˜ë¦¬ (ë³¸íƒ±?¬ìš©)
          if (messageStr.includes("?ŒìŠ¤??ë©”ì‹œì§€")) {
            // ?ŒìŠ¤??ë©”ì‹œì§€???œê°„ ì¶”ê?
            const displayMessage = `ë³¸íƒ±???ŒìŠ¤??(${timeStr})`;
            console.log(`ë³¸íƒ±???ŒìŠ¤??ë©”ì‹œì§€ ë³€?? ${messageStr} -> ${displayMessage}`);
            setMainTankLevelMessage(displayMessage);
          } else {
            // ?¼ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬ - ?œê°„ ?•ë³´ ì¶”ê?
            const displayMessage = `${messageStr} (${timeStr})`;
            setMainTankLevelMessage(displayMessage);
            
            // ë©”ì‹œì§€???°ë¼ ?œì‹œë§?ë³€ê²½í•˜ê³??±í¬ ?íƒœ??ë³€ê²½í•˜ì§€ ?ŠìŒ
            // ì¤‘ìš”: ?¬ê¸°??tankData.mainTankë¥??˜ì •?˜ë©´ ?ˆë¨
          }
          
          console.log(`ë³¸íƒ±??ë©”ì‹œì§€ ?…ë°?´íŠ¸ ?„ë£Œ: ${messageStr}`);
          
          // ?íƒœ ì§€?ì„ ?„í•´ ë¡œì»¬ ?¤í† ë¦¬ì????€??          localStorage.setItem('mainTankLevelMessage', messageStr);
        } else if (topic.match(/extwork\/inverter(\d+)\/tank(\d+)_level/)) {
          // ?±í¬ ?˜ìœ„ ? í”½ ì²˜ë¦¬
          const tankLevelMatch = topic.match(/extwork\/inverter(\d+)\/tank(\d+)_level/);
          if (tankLevelMatch) {
            const inverterId = Number.parseInt(tankLevelMatch[1]);
            const tankId = Number.parseInt(tankLevelMatch[2]);
            
            console.log(`?±í¬ ?˜ìœ„ ë©”ì‹œì§€ ì²˜ë¦¬ - ?¸ë²„??ID: ${inverterId}, ?±í¬ ID: ${tankId}, ë©”ì‹œì§€: ${messageStr}`);
            
            // ?Œí”„ ?íƒœ ?•ì¸
            const isPumpRunning = tankData?.tanks && tankData?.tanks[inverterId - 1]?.pumpStatus === "ON";
            console.log(`?Œí”„ ?íƒœ: ${isPumpRunning ? "ON" : "OFF"}`);
            
            // ?œê°„ ë¬¸ì???ì„±
            const timeStr = formatTimeStr();
            
            // ì¤‘ìš” ë©”ì‹œì§€ ?¬ë? ?•í™•?˜ê²Œ ì²´í¬ (?•í™•??ë©”ì‹œì§€ë§?ë§¤ì¹­)
            const isImportantMessage = (msg: string, tankId: number): boolean => {
              // 1ë²??±í¬?€ ?˜ë¨¸ì§€ ?±í¬ë¥?êµ¬ë¶„
              if (tankId === 1) {
                // 1ë²??±í¬??ì¤‘ìš” ë©”ì‹œì§€
                return (
                  msg.includes("?˜ìœ„:5%?´ìƒ") || 
                  msg.includes("?˜ìœ„ë¶€ì¡?5%ë¯¸ë§Œ") || 
                  msg.includes("ê°€?ì±„?Œì§") ||
                  msg.includes("ì±„ì?ê°€??)
                );
            } else {
                // 2~6ë²??±í¬??ì¤‘ìš” ë©”ì‹œì§€
                return (
                  msg.includes("?˜ìœ„ë¶€ì¡?) || 
                  msg.includes("?˜ìœ„?•ìƒ") || 
                  msg.includes("ê°€?ì±„?Œì§") || 
                  msg.includes("?•ìƒ?˜ìœ„")
                );
              }
            };
            
            // ë©”ì‹œì§€ ì²˜ë¦¬ - ?ìŠ¤??ë°•ìŠ¤???œì‹œ???„ì²´ ë©”ì‹œì§€
            let displayMessage = `${messageStr} (${timeStr})`;
            
            // ?±í¬ ?´ë????œì‹œ??ë©”ì‹œì§€ (ì¤‘ìš” ë©”ì‹œì§€ë§?
            let tankDisplayMessage = "";
            
            // ì¤‘ìš” ë©”ì‹œì§€ ?¬ë? ?•ì¸
            if (isImportantMessage(messageStr, tankId)) {
              // ì¤‘ìš” ?íƒœ ë©”ì‹œì§€???±í¬ ?´ë? ?œì‹œ?©ìœ¼ë¡??€??              tankDisplayMessage = messageStr;
              console.log(`ì¤‘ìš” ?íƒœ ë©”ì‹œì§€ ê°ì?: "${messageStr}" (?±í¬ ${tankId})`);
            }
            
            // ?”ë²„ê¹? ?±í¬ ë©”ì‹œì§€ ?…ë°?´íŠ¸ ???„ì¬ ?íƒœ ?•ì¸
            console.log(`?±í¬ ${tankId} ë©”ì‹œì§€ ?…ë°?´íŠ¸ ???„ì¬ ?íƒœ:`, {
              ?„ì¬ë©”ì‹œì§€: tankMessages[tankId],
              ?ˆë©”?œì?: displayMessage
            });
            
            // ?±í¬ ë©”ì‹œì§€ ?íƒœ ?…ë°?´íŠ¸ - ??ì¢…ë¥˜??ë©”ì‹œì§€ ëª¨ë‘ ?…ë°?´íŠ¸
            setTankMessages(prev => {
              const updated = {
                ...prev,
                [tankId]: displayMessage
              };
              console.log(`?±í¬ ${tankId} ë©”ì‹œì§€ ?…ë°?´íŠ¸: "${displayMessage}"`);
              
              // ?ìŠ¤??ë°•ìŠ¤??ë©”ì‹œì§€ ?€??              localStorage.setItem(`tank_${tankId}_message`, displayMessage);
              
              // ì¤‘ìš” ë©”ì‹œì§€??ë³„ë„ë¡??€??(?±í¬ ?´ë? ?œì‹œ??
              if (tankDisplayMessage) {
                localStorage.setItem(`tank_${tankId}_important_message`, tankDisplayMessage);
                console.log(`ì¤‘ìš” ë©”ì‹œì§€ ?€??(?±í¬ ?´ë? ?œì‹œ??: tank_${tankId}_important_message = "${tankDisplayMessage}"`);
              }
              
              return updated;
            });
            
            // ?”ë²„ê¹? ?„ì¬ ?íƒœ ì¶œë ¥
            setTimeout(() => {
              console.log(`?±í¬ ${tankId} ë©”ì‹œì§€ ?íƒœ ?…ë°?´íŠ¸ ?„ë£Œ: "${displayMessage}"`);
              if (tankDisplayMessage) {
                console.log(`?±í¬ ${tankId} ?´ë? ?œì‹œ ë©”ì‹œì§€: "${tankDisplayMessage}"`);
              }
            }, 100);
          }
        } 
        // ?¤ë¥¸ ? í”½ ì²˜ë¦¬...
        else if (topic.match(/extwork\/inverter(\d+)\/state/)) {
          // ?¸ë²„???íƒœ ? í”½ ì²˜ë¦¬ - ?Œí”„ ?íƒœë§?ë³€ê²? ?‰ìƒ?€ getTankColor ?¨ìˆ˜ê°€ ì²˜ë¦¬
          const inverterId = parseInt(topic.match(/extwork\/inverter(\d+)\/state/)![1]);
          console.log(`?¸ë²„???íƒœ ë©”ì‹œì§€ ?˜ì‹  - ?¸ë²„??ID: ${inverterId}, ë©”ì‹œì§€: ${messageStr}`);
          
          // ë©”ì‹œì§€???°ë¼ ?Œí”„ ?íƒœ ?…ë°?´íŠ¸ (?‰ìƒ ë³€ê²½ì? getTankColor ?¨ìˆ˜ê°€ ?´ë‹¹)
          // ë©”ì‹œì§€ê°€ "ON"???¬í•¨?˜ë©´ ?Œí”„ ON, ê·¸ë ‡ì§€ ?Šìœ¼ë©?OFF
          const isOn = messageStr.toUpperCase().includes("ON");
          
          // ?Œí”„ ?íƒœê°€ ON?ì„œ OFFë¡?ë³€ê²½ëœ ê²½ìš° ?Œë¦¼ ì¶”ê?
          if (tankData?.tanks && tankData?.tanks[inverterId - 1]?.pumpStatus === "ON" && !isOn) {
            const timeStr = formatTimeStr();
            const pumpOffMessage = `?Œí”„ ${inverterId} OFF: ${messageStr} (${timeStr})`;
            addNotification(pumpOffMessage, 'info', inverterId);
          }
        }
        // ì¹´ë©”???íƒœ ? í”½ ì²˜ë¦¬ ì¶”ê?
        else if (topic.match(/extwork\/cam(\d+)\/state/)) {
          const camNumber = parseInt(topic.match(/extwork\/cam(\d+)\/state/)![1]);
          console.log(`ì¹´ë©”??${camNumber} ?íƒœ ë©”ì‹œì§€ ?˜ì‹ : ${messageStr}`);
          
          // ??ì»´í¬?ŒíŠ¸?ì„œ??ì¹´ë©”???íƒœ ì²˜ë¦¬ë¥??˜ì? ?Šê³ ,
          // ?ìœ„ ì»´í¬?ŒíŠ¸(Dashboard)?ì„œ ì²˜ë¦¬?˜ë„ë¡??©ë‹ˆ??
          // ?¬ê¸°?œëŠ” ë¡œê·¸ë§?ì¶œë ¥?©ë‹ˆ??
        }
        // ?ë™??ê³µì • ?íƒœ ? í”½ ì²˜ë¦¬
        else if (topic === AUTOMATION_STATUS_TOPIC) {
          try {
            const automationStatus = JSON.parse(messageStr);
            if (automationStatus.status === "sequence_started") {
              setAutomationProgress(`${automationStatus.sequenceName} ?œí€€???œì‘??);
            }
          } catch (error) {
            console.error('?ë™???íƒœ ë©”ì‹œì§€ ?Œì‹± ?¤ë¥˜:', error);
            // JSON ?Œì‹± ?¤íŒ¨ ???ë³¸ ë©”ì‹œì§€ ê·¸ë?ë¡??€??            setAutomationProgress(messageStr);
          }
        }
        // ê³µì • ì§„í–‰ ?íƒœ ? í”½ ì²˜ë¦¬
        else if (topic === PROCESS_PROGRESS_TOPIC) {
          try {
            // ê³µì • ì§„í–‰ ?íƒœ ë©”ì‹œì§€ ì²˜ë¦¬
            console.log(`ê³µì • ì§„í–‰ ?íƒœ ë©”ì‹œì§€: ${messageStr}`);
            
            // JSON ?Œì‹± ?œë„
            let jsonData: any;
            let isJsonFormat = false;
            
            try {
              if (messageStr.trim().startsWith('{') && messageStr.trim().endsWith('}')) {
                jsonData = JSON.parse(messageStr);
                isJsonFormat = true;
                console.log('JSON ?•ì‹ ì§„í–‰ ?°ì´???•ì¸:', jsonData);
              }
            } catch (jsonError) {
              console.log('JSON ?Œì‹± ?¤íŒ¨, ?ìŠ¤???•ì‹?¼ë¡œ ì²˜ë¦¬:', jsonError);
            }
            
            // ì§„í–‰ ?•ë³´ ?Œì‹± (JSON ?ëŠ” ?ìŠ¤???•ì‹)
            let progressInfo: ProcessProgress | null = null;
            
            if (isJsonFormat && jsonData) {
              // JSON ?•ì‹ ì²˜ë¦¬ - ?”ì²­???•ì‹??ë§ì¶˜ ëª…ì‹œ??ì²˜ë¦¬
              progressInfo = {
                mode: jsonData.mode || '',
                elapsed_time: 0,
                remaining_time: 0,
                total_repeats: 1,
                current_repeat: 0,
                pump_id: undefined
              };
              
              // ê²½ê³¼ ?œê°„ ì¶”ì¶œ (?«ì ?ëŠ” ë¬¸ì??s ?•ì‹)
              if (jsonData.elapsed_time !== undefined) {
                if (typeof jsonData.elapsed_time === 'number') {
                  progressInfo.elapsed_time = jsonData.elapsed_time;
                } else if (typeof jsonData.elapsed_time === 'string') {
                  const match = String(jsonData.elapsed_time).match(/(\d+)/);
                  if (match) {
                    progressInfo.elapsed_time = parseInt(match[1], 10);
                  }
                }
              }
              
              // ?¨ì? ?œê°„ ì¶”ì¶œ (?«ì ?ëŠ” ë¬¸ì??s ?•ì‹)
              if (jsonData.remaining_time !== undefined) {
                if (typeof jsonData.remaining_time === 'number') {
                  progressInfo.remaining_time = jsonData.remaining_time;
                } else if (typeof jsonData.remaining_time === 'string') {
                  const match = String(jsonData.remaining_time).match(/(\d+)/);
                  if (match) {
                    progressInfo.remaining_time = parseInt(match[1], 10);
                  }
                }
              }
              
              // ?Œí”„ ID ì¶”ì¶œ (?? "1(10/11)" ?•ì‹)
              if (jsonData.pump_id) {
                progressInfo.pump_id = String(jsonData.pump_id);
                
                // ë°˜ë³µ ?•ë³´ ?Œì‹± (?? "1(10/11)" ???Œí”„ 1, ?„ì¬ 10?? ì´?11??
                const pumpMatch = String(jsonData.pump_id).match(/(\d+)\((\d+)\/(\d+)\)/);
                if (pumpMatch) {
                  // ?„ì¬ ë°˜ë³µ ?Ÿìˆ˜?€ ì´?ë°˜ë³µ ?Ÿìˆ˜ ?¤ì •
                  progressInfo.current_repeat = parseInt(pumpMatch[2], 10);
                  progressInfo.total_repeats = parseInt(pumpMatch[3], 10);
                  
                  console.log(`[JSON] ?Œí”„ ${pumpMatch[1]} ì§„í–‰ ?•ë³´: ${progressInfo.current_repeat}/${progressInfo.total_repeats} ??);
                }
              }
              
              // process_info ?„ë“œ?ì„œ ë°˜ë³µ ?•ë³´ ?Œì‹± (?? "C(6/10)")
              if (jsonData.process_info) {
                const processMatch = String(jsonData.process_info).match(/\w+\((\d+)\/(\d+)\)/);
                if (processMatch) {
                  if (!progressInfo.pump_id) {
                    // ?™ì‹œëª¨ë“œ??ê²½ìš° ?ëŠ” pump_idê°€ ?†ëŠ” ê²½ìš°?ë§Œ ?¤ì •
                    progressInfo.current_repeat = parseInt(processMatch[1], 10);
                    progressInfo.total_repeats = parseInt(processMatch[2], 10);
                  }
                }
              }
              
              console.log('?Œì‹±??JSON ì§„í–‰ ?•ë³´:', progressInfo);
            } else {
              // ê¸°ì¡´ ?ìŠ¤??ê¸°ë°˜ ?Œì‹± ?¬ìš©
              progressInfo = parseProgressMessage(messageStr);
            }
            
            // ì§„í–‰ ?•ë³´ê°€ ?ˆìœ¼ë©??íƒœ ?…ë°?´íŠ¸
            if (progressInfo) {
              console.log('ìµœì¢… ?Œì‹±??ì§„í–‰ ?•ë³´:', progressInfo);
              
              // ?Œí”„ IDê°€ ?ˆëŠ” ê²½ìš° (?œì°¨ëª¨ë“œ, ?¤ë²„?©ëª¨??
              if (progressInfo.pump_id) {
                // ?Œí”„ ID ì¶”ì¶œ ("1(10/11)" ??"1")
                const pumpIdMatch = String(progressInfo.pump_id).match(/^(\d+)/);
                const pumpId = pumpIdMatch ? parseInt(pumpIdMatch[1], 10) : 0;
                
                if (pumpId > 0) {
                // ì§„í–‰ ?•ë³´ ?íƒœ ?…ë°?´íŠ¸ ??ë¡œê·¸
                console.log(`?Œí”„ ${pumpId} ì§„í–‰ ?•ë³´ ?…ë°?´íŠ¸ ??`, {
                  ?„ì¬ê°? pumpProgressInfo[pumpId],
                  ?ˆê°’: progressInfo
                });
                
                // ?Œí”„ ID???´ë‹¹?˜ëŠ” ì§„í–‰ ?•ë³´ ?…ë°?´íŠ¸
                setPumpProgressInfo(prev => {
                  const updated = { 
                    ...prev, 
                    [pumpId]: progressInfo 
                  };
                  
                  // ?…ë°?´íŠ¸ ??ê°?ê¸°ë¡
                  setTimeout(() => {
                    console.log(`?Œí”„ ${pumpId} ì§„í–‰ ?•ë³´ ?…ë°?´íŠ¸ ??`, updated[pumpId]);
                  }, 10);
                  
                  return updated;
                });
                
                // JSON?¼ë¡œ ì§ë ¬?”í•˜??ë¡œì»¬ ?¤í† ë¦¬ì??ë„ ?€??(?”ë²„ê¹…ìš©)
                try {
                  localStorage.setItem(`pump_progress_${pumpId}`, JSON.stringify(progressInfo));
                    
                    // ì§„í–‰ë¥?ê³„ì‚°?˜ì—¬ ?€??(? ë‹ˆë©”ì´?˜ìš©)
                    const totalTime = progressInfo.elapsed_time + progressInfo.remaining_time;
                    if (totalTime > 0) {
                      const fillPercent = 5 + (progressInfo.elapsed_time / totalTime) * 90;
                      localStorage.setItem(`pump_${pumpId}_fill_percent`, fillPercent.toString());
                    }
                } catch (e) {
                  console.error('ì§„í–‰ ?•ë³´ ë¡œì»¬ ?¤í† ë¦¬ì? ?€???¤íŒ¨:', e);
                  }
                } else {
                  console.log('?Œí”„ IDë¥?ì¶”ì¶œ?????†ê±°??? íš¨?˜ì? ?ŠìŒ:', progressInfo.pump_id);
                }
              } else if (progressInfo.mode === '?™ì‹œëª¨ë“œ') {
                // ?™ì‹œëª¨ë“œ??ê²½ìš° ëª¨ë“  ?œì„± ?Œí”„???™ì¼??ì§„í–‰ ?•ë³´ ?ìš©
                const activePumps = tankData?.tanks?.filter(t => t.pumpStatus === "ON").map(t => t.id) || [];
                
                if (activePumps.length > 0) {
                  console.log(`?™ì‹œëª¨ë“œ: ${activePumps.length}ê°??œì„± ?Œí”„??ì§„í–‰ ?•ë³´ ?ìš©`, activePumps);
                  
                  setPumpProgressInfo(prev => {
                    const updated = { ...prev };
                    
                    activePumps.forEach(pumpId => {
                      updated[pumpId] = progressInfo;
                      
                      // ë¡œì»¬ ?¤í† ë¦¬ì??ë„ ?€??(?”ë²„ê¹…ìš©)
                      try {
                        localStorage.setItem(`pump_progress_${pumpId}`, JSON.stringify(progressInfo));
                        
                        // ì§„í–‰ë¥?ê³„ì‚°?˜ì—¬ ?€??(? ë‹ˆë©”ì´?˜ìš©)
                        const totalTime = progressInfo.elapsed_time + progressInfo.remaining_time;
                        if (totalTime > 0) {
                          const fillPercent = 5 + (progressInfo.elapsed_time / totalTime) * 90;
                          localStorage.setItem(`pump_${pumpId}_fill_percent`, fillPercent.toString());
                        }
                      } catch (e) {
                        console.error('ì§„í–‰ ?•ë³´ ë¡œì»¬ ?¤í† ë¦¬ì? ?€???¤íŒ¨:', e);
                      }
                    });
                    
                    return updated;
                  });
                } else {
                  console.log('?™ì‹œëª¨ë“œ?´ì?ë§??œì„±?”ëœ ?Œí”„ê°€ ?†ìŠµ?ˆë‹¤.');
                }
              } else {
                console.log('ì²˜ë¦¬???Œí”„ IDê°€ ?†ê±°??ëª¨ë“œê°€ ì§€?•ë˜ì§€ ?Šì•˜?µë‹ˆ??');
              }
              
              // progress ë©”ì‹œì§€ ?…ë°?´íŠ¸
              if (setProgressMessages) {
                setProgressMessages(prev => [{
                  timestamp: Date.now(),
                  message: `ì§„í–‰ ?íƒœ: ${messageStr}`,
                  rawJson: isJsonFormat ? messageStr : null
                }, ...prev]);
              }
              
            // ?ìŠ¤??ë©”ì‹œì§€ ì²˜ë¦¬ (?„ì¬ ?œí€€???•ë³´ ?Œì‹±)
            if (messageStr.includes("?„ì¬ ?œí€€??")) {
              setCurrentSequenceInfo(messageStr.split('\n')[0]?.trim() || null);
            }
            
            // ?¤ìŒ ?œí€€???•ë³´ ?Œì‹±
            if (messageStr.includes("?¤ìŒ ?œí€€??")) {
              const lines = messageStr.split('\n');
              for (const line of lines) {
                if (line.trim().startsWith("?¤ìŒ ?œí€€??")) {
                  setNextSequenceInfo(line.trim());
                  break;
                }
              }
            }
            
            // ?œí€€???µê³„ ?•ë³´ ?Œì‹± (nê°??„ë£Œ / nê°??¤í–‰ì¤?/ nê°??€ê¸°ì¤‘ / nê°??¤ë¥˜)
            if (messageStr.includes("ê°??„ë£Œ") && messageStr.includes("ê°??¤í–‰ì¤?)) {
              const lines = messageStr.split('\n');
              for (const line of lines) {
                if (line.includes("ê°??„ë£Œ") && line.includes("ê°??¤í–‰ì¤?)) {
                  setSequenceStatsInfo(line.trim());
                  break;
                }
              }
            }
            
              // ?„ì²´ ë©”ì‹œì§€ë¥??ë™??ì§„í–‰ ?íƒœ ?œì‹œ???€??            setAutomationProgress(messageStr);
            } else {
              console.log('ì§„í–‰ ?•ë³´ë¥??Œì‹±?????†ìŠµ?ˆë‹¤. ?ë³¸ ë©”ì‹œì§€:', messageStr);
              // ?Œì‹± ?¤íŒ¨ ?œì—???ë³¸ ë©”ì‹œì§€ ?€??              setAutomationProgress(messageStr);
            }
          } catch (error) {
            console.error('ê³µì • ì§„í–‰ ?íƒœ ë©”ì‹œì§€ ì²˜ë¦¬ ?¤ë¥˜:', error);
            setAutomationProgress(messageStr); // ?¤ë¥˜ ë°œìƒ ???ë³¸ ë©”ì‹œì§€ ê·¸ë?ë¡??€??          }
        }
      } catch (error) {
        console.error('ë©”ì‹œì§€ ì²˜ë¦¬ ?¤ë¥˜:', error);
      }
    };
    
    // ë©”ì‹œì§€ ?´ë²¤??ë¦¬ìŠ¤???±ë¡
    mqttClient.on('message', handleMessage);
    
    // ì»´í¬?ŒíŠ¸ ?¸ë§ˆ?´íŠ¸ ???´ë²¤??ë¦¬ìŠ¤???œê±°
    return () => {
      mqttClient.off('message', handleMessage);
      mqttClient.off('connect', subscribeTankTopics);
    };
  }, [mqttClient, tankData]);
  
  // ì»´í¬?ŒíŠ¸ ë§ˆìš´?????€?¥ëœ ?íƒœ ë³µì› - IndexedDB ì¶”ê?
  useEffect(() => {
    // ë¡œì»¬/?¸ì…˜ ?¤í† ë¦¬ì??ì„œ ë¨¼ì? ë¶ˆëŸ¬?¤ê¸°
    const savedState = loadState();
    if (savedState && savedState.timestamp) {
      setLastStateUpdate(new Date(savedState.timestamp));
    }
    
    // IndexedDB?ì„œ???•ì¸ (??ìµœì‹ ?????ˆìŒ)
    loadFromIndexedDB()
      .then(indexedDBState => {
        if (indexedDBState && 
            indexedDBState.timestamp > (savedState?.timestamp || 0)) {
          // IndexedDB???íƒœê°€ ??ìµœì‹ ?´ë©´ ?¬ìš©
          setLastStateUpdate(new Date(indexedDBState.timestamp));
          
          // localStorage?€ sessionStorage ?…ë°?´íŠ¸
          localStorage.setItem('tankSystemState', JSON.stringify(indexedDBState));
          sessionStorage.setItem('tankSystemState', JSON.stringify(indexedDBState));
        }
      })
      .catch(error => {
        console.error('IndexedDB ?íƒœ ë¡œë“œ ?¤íŒ¨:', error);
      });
    
    // ?¨ë¼???íƒœ ë³€??ê°ì?
    const handleOnlineStatusChange = () => {
      if (window.navigator.onLine && mqttClient) {
        // ?¨ë¼?¸ìœ¼ë¡?ë³µê? ??Redis?ì„œ ìµœì‹  ?íƒœ ì¡°íšŒ
        console.log('?¤íŠ¸?Œí¬ ?°ê²°??ë³µêµ¬?˜ì—ˆ?µë‹ˆ?? ?œìŠ¤???íƒœë¥??…ë°?´íŠ¸?©ë‹ˆ??');
        
        // ?íƒœ ?…ë°?´íŠ¸ ?Œë¦¼
        mqttClient.publish('tank-system/notification', JSON.stringify({
          clientId: clientId.current,
          timestamp: Date.now(),
          message: '?¤íŠ¸?Œí¬ ?°ê²°??ë³µêµ¬?˜ì—ˆ?µë‹ˆ?? ?œìŠ¤???íƒœê°€ ?…ë°?´íŠ¸?©ë‹ˆ??'
        }));
      }
    };
    
    window.addEventListener('online', handleOnlineStatusChange);
    
    return () => {
      window.removeEventListener('online', handleOnlineStatusChange);
    };
  }, [mqttClient]);
  
  // ë¦¬ì…‹ ?œë˜ê·??œì‘
  const handleResetDragStart = (pumpId: number, e: React.MouseEvent | React.TouchEvent) => {
    e.preventDefault();
    e.stopPropagation();
    
    setResetDragState(prev => ({
      ...prev,
      [pumpId]: { 
        dragging: true, 
        position: 0, 
        timer: null 
      }
    }));
    
    document.addEventListener('mousemove', (e) => handleResetDragMove(e, pumpId));
    document.addEventListener('touchmove', (e) => handleResetDragMove(e, pumpId));
    document.addEventListener('mouseup', () => handleResetDragEnd(pumpId));
    document.addEventListener('touchend', () => handleResetDragEnd(pumpId));
  };
  
  // ë¦¬ì…‹ ?œë˜ê·??´ë™
  const handleResetDragMove = (e: MouseEvent | TouchEvent, pumpId: number) => {
    if (!resetDragState[pumpId]?.dragging) return;
    
    // ë§ˆìš°???ëŠ” ?°ì¹˜ X ì¢Œí‘œ
    const clientX = 'touches' in e ? e.touches[0].clientX : e.clientX;
    
    // ë¦¬ì…‹ ë²„íŠ¼ ?”ì†Œ???„ì¹˜ êµ¬í•˜ê¸?    const resetButton = document.getElementById(`reset-btn-${pumpId}`);
    if (!resetButton) return;
    
    const rect = resetButton.getBoundingClientRect();
    const buttonWidth = rect.width;
    const maxDrag = 50; // ìµœë? ?œë˜ê·?ê±°ë¦¬
    
    // ?œë˜ê·??„ì¹˜ ê³„ì‚° (0~1 ?¬ì´ ê°?
    const dragStartX = rect.left + buttonWidth / 2; // ë²„íŠ¼ ì¤‘ì•™
    const dragDistance = Math.max(0, Math.min(maxDrag, clientX - dragStartX)); // 0 ~ maxDrag
    const position = dragDistance / maxDrag; // 0 ~ 1
    
    setResetDragState(prev => {
      const currentState = prev[pumpId] || { dragging: true, position: 0, timer: null };
      
      // ?´ë? ?€?´ë¨¸ê°€ ?ˆê³ , ?„ì¹˜ê°€ 0.8(80%) ?´ìƒ?´ë©´ ?€?´ë¨¸ ? ì?
      if (currentState.timer && position >= 0.8) {
        return prev;
      }
      
      // ?€?´ë¨¸ê°€ ?ˆì?ë§??„ì¹˜ê°€ 0.8 ë¯¸ë§Œ?´ë©´ ?€?´ë¨¸ ì·¨ì†Œ
      if (currentState.timer && position < 0.8) {
        clearTimeout(currentState.timer);
        return {
          ...prev,
          [pumpId]: { 
            ...currentState,
            position,
            timer: null
          }
        };
      }
      
      // ?€?´ë¨¸ê°€ ?†ê³  ?„ì¹˜ê°€ 0.8 ?´ìƒ?´ë©´ ?€?´ë¨¸ ?œì‘
      if (!currentState.timer && position >= 0.8) {
        const timer = setTimeout(() => {
          console.log(`?Œí”„ ${pumpId} ë¦¬ì…‹ ëª…ë ¹ ?¤í–‰ (2ì´???`);
          if (onPumpReset) {
            onPumpReset(pumpId);
            
            // "3" ëª…ë ¹ ë°œí–‰
            if (mqttClient) {
              const pumpTopic = `extwork/pump${pumpId}/cmd`;
              mqttClient.publish(pumpTopic, "3");
              
              // ?Œë¦¼ ë°œí–‰
              const notification = {
                type: 'pump-reset',
                pumpId: pumpId,
                timestamp: Date.now(),
                clientId: clientId.current,
                message: `?Œí”„ ${pumpId} ë¦¬ì…‹ ëª…ë ¹(3)???¤í–‰?˜ì—ˆ?µë‹ˆ??`
              };
              
              mqttClient.publish('tank-system/notifications', JSON.stringify(notification));
            }
          }
          
          // ?€?´ë¨¸ ë¦¬ì…‹ ë°??íƒœ ì´ˆê¸°??          setResetDragState(prev => ({
            ...prev,
            [pumpId]: {
              dragging: false,
              position: 0,
              timer: null
            }
          }));
        }, 2000); // 2ì´????¤í–‰
        
        return {
          ...prev,
          [pumpId]: {
            ...currentState,
            position,
            timer
          }
        };
      }
      
      // ê·??¸ì˜ ê²½ìš° ?„ì¹˜ë§??…ë°?´íŠ¸
      return {
        ...prev,
        [pumpId]: {
          ...currentState,
          position
        }
      };
    });
  };

  // ë¦¬ì…‹ ?œë˜ê·?ì¢…ë£Œ
  const handleResetDragEnd = (pumpId: number) => {
    const currentState = resetDragState[pumpId];
    if (!currentState?.dragging) return;
    
    // ?´ë²¤??ë¦¬ìŠ¤???œê±°
    document.removeEventListener('mousemove', (e) => handleResetDragMove(e, pumpId));
    document.removeEventListener('touchmove', (e) => handleResetDragMove(e, pumpId));
    document.removeEventListener('mouseup', () => handleResetDragEnd(pumpId));
    document.removeEventListener('touchend', () => handleResetDragEnd(pumpId));
    
    // ?€?´ë¨¸ê°€ ?ˆê³ , ?„ì¹˜ê°€ 0.8 ?´ìƒ?´ë©´ ?€?´ë¨¸ ? ì? (ê³„ì† ?¤í–‰)
    if (currentState.timer && currentState.position >= 0.8) {
      return;
    }
    
    // ?€?´ë¨¸ê°€ ?ˆì?ë§??„ì¹˜ê°€ 0.8 ë¯¸ë§Œ?´ë©´ ?€?´ë¨¸ ì·¨ì†Œ
    if (currentState.timer) {
      clearTimeout(currentState.timer);
    }
    
    // ?íƒœ ì´ˆê¸°??    setResetDragState(prev => ({
      ...prev,
      [pumpId]: {
        dragging: false,
        position: 0,
        timer: null
      }
    }));
  };
  
  // ë°¸ë¸Œ ?íƒœ ë³€ê²??¸ë“¤??- MQTT ?Œë¦¼ ì¶”ê?
  const handleValveChange = (newState: string) => {
    // ?íƒœ ë³€ê²??”ì²­
    onValveChange(newState);
    
    // MQTTë¥??µí•œ ?Œë¦¼ ë°œí–‰
    if (mqttClient) {
      const notification = {
        type: 'valve-change',
        valveState: newState,
        timestamp: Date.now(),
        clientId: clientId.current,
        message: `ë°¸ë¸Œ ?íƒœê°€ ë³€ê²½ë˜?ˆìŠµ?ˆë‹¤: ${newState}`
      };
      
      mqttClient.publish('tank-system/notifications', JSON.stringify(notification));
    }
    
    // ?íƒœ ë³€ê²??œê°„ ?…ë°?´íŠ¸
    setLastStateUpdate(new Date());
    
    // ?íƒœ ?€??    saveState({
      ...tankData,
      valveState: newState
    });
  };
  
  // ?Œí”„ ë²„íŠ¼ ë§ˆìš°???¤ìš´ ?¸ë“¤??- MQTT ?Œë¦¼ ì¶”ê?
  const handlePumpMouseDown = (pumpId: number) => {
    setCurrentPressedPump(pumpId);
    
    // ê¸¸ê²Œ ?„ë¥´ê¸?ê°ì? ?€?´ë¨¸ ?¤ì • (3ì´???ë¦¬ì…‹ ëª…ë ¹ ë°œìƒ)
    const timer = setTimeout(() => {
      console.log(`?Œí”„ ${pumpId} ê¸¸ê²Œ ?„ë¦„ ê°ì? - ë¦¬ì…‹ ëª…ë ¹ ?¤í–‰`);
      if (onPumpReset) {
        onPumpReset(pumpId);
        
        // MQTTë¥??µí•œ ?Œë¦¼ ë°œí–‰
        if (mqttClient) {
          const notification = {
            type: 'pump-reset',
            pumpId,
            timestamp: Date.now(),
            clientId: clientId.current,
            message: `?Œí”„ ${pumpId} ë¦¬ì…‹ ëª…ë ¹???¤í–‰?˜ì—ˆ?µë‹ˆ??`
          };
          
          mqttClient.publish('tank-system/notifications', JSON.stringify(notification));
        }
      }
      setCurrentPressedPump(null);
    }, 3000);
    
    setLongPressTimer(timer);
  };
  
  // ?Œí”„ ë²„íŠ¼ ë§ˆìš°?????¸ë“¤??- MQTT ?Œë¦¼ ì¶”ê?
  const handlePumpMouseUp = (pumpId: number) => {
    // ?€?´ë¨¸ê°€ ?ˆìœ¼ë©?ì·¨ì†Œ (ê¸¸ê²Œ ?„ë¥´ê¸?ì·¨ì†Œ)
    if (longPressTimer) {
      clearTimeout(longPressTimer);
      setLongPressTimer(null);
    }
    
    // ?„ì¬ ?„ë¥¸ ?Œí”„ê°€ ?ˆê³ , ë§ˆìš°?????´ë²¤?¸ê? ë°œìƒ???Œí”„?€ ê°™ìœ¼ë©??´ë¦­?¼ë¡œ ê°„ì£¼
    if (currentPressedPump === pumpId) {
      console.log(`?Œí”„ ${pumpId} ?´ë¦­ - ? ê? ëª…ë ¹ ?¤í–‰`);
      if (onPumpToggle) {
        onPumpToggle(pumpId);
        
        // MQTTë¥??µí•œ ?Œë¦¼ ë°œí–‰
        if (mqttClient) {
          const notification = {
            type: 'pump-toggle',
            pumpId,
            timestamp: Date.now(),
            clientId: clientId.current,
            message: `?Œí”„ ${pumpId} ?íƒœê°€ ? ê??˜ì—ˆ?µë‹ˆ??`
          };
          
          mqttClient.publish('tank-system/notifications', JSON.stringify(notification));
        }
      }
    }
    
    setCurrentPressedPump(null);
  };
  
  // ë§ˆìš°?¤ê? ?Œí”„ ë°–ìœ¼ë¡??˜ê°”?????¸ë“¤??  const handlePumpMouseLeave = () => {
    // ?€?´ë¨¸ê°€ ?ˆìœ¼ë©?ì·¨ì†Œ
    if (longPressTimer) {
      clearTimeout(longPressTimer);
      setLongPressTimer(null);
    }
    setCurrentPressedPump(null);
  };
  
  // ?°ì¹˜ ?´ë²¤???¸ë“¤??(ëª¨ë°”??
  const handlePumpTouchStart = (pumpId: number) => {
    handlePumpMouseDown(pumpId);
  };
  
  const handlePumpTouchEnd = (pumpId: number) => {
    handlePumpMouseUp(pumpId);
  };
  
  const handlePumpTouchCancel = () => {
    handlePumpMouseLeave();
  };

  // ì¶”ì¶œ ì§„í–‰ ?í™©?ì„œ ?±í¬ ì±„ì? ë¹„ìœ¨ ê³„ì‚° - ë¡œì§ ê°œì„ 
  useEffect(() => {
    if (progressMessages.length > 0) {
      const latestProgress = progressMessages[0]; // ê°€??ìµœì‹  ë©”ì‹œì§€ ?¬ìš© (ë°°ì—´ ì²?ë²ˆì§¸ ?”ì†Œ)
      const latestMessage = latestProgress.message || '';
      console.log('ìµœì‹  ì§„í–‰ ë©”ì‹œì§€:', latestMessage);
      
      // ?¤ì–‘???•ì‹??ì§„í–‰ ë©”ì‹œì§€ ì²˜ë¦¬ ê°œì„ 
      try {
        // 1. "?¨ì?: XXs | ê²½ê³¼: YYs" ?•ì‹ ?¨í„´ ?•ì¸
        const remainingMatch = latestMessage.match(/?¨ì?:\s*(\d+)s/) || latestMessage.match(/?¨ìŒ:\s*(\d+)s/) || latestMessage.match(/remaining:\s*(\d+)s/);
        const elapsedMatch = latestMessage.match(/ê²½ê³¼:\s*(\d+)s/) || latestMessage.match(/ì§„í–‰:\s*(\d+)s/) || latestMessage.match(/elapsed:\s*(\d+)s/);
        
        // 2. ì§ì ‘?ì¸ ?«ì ?¨í„´ ?•ì¸ ("50/100ì´? ê°™ì? ?•ì‹)
        const directProgressMatch = latestMessage.match(/(\d+)\/(\d+)(ì´?s)/);
      
      if (remainingMatch && elapsedMatch) {
        const remaining = parseInt(remainingMatch[1], 10);
        const elapsed = parseInt(elapsedMatch[1], 10);
        const total = remaining + elapsed;
        
        if (!isNaN(remaining) && !isNaN(elapsed) && total > 0) {
          // ?„ì¬ ê²½ê³¼ ?œê°„ê³??„ì²´ ?œê°„??ë¹„ìœ¨ ê³„ì‚° (ìµœë? 100%)
          const percentage = Math.min((elapsed / total) * 100, 100);
          setFillPercentage(percentage);
          console.log(`ì±„ì? ? ë‹ˆë©”ì´??ì§„í–‰ë¥??…ë°?´íŠ¸: ${percentage.toFixed(1)}% (ê²½ê³¼: ${elapsed}s, ?„ì²´: ${total}s)`);
        }
        } else if (directProgressMatch) {
          // ì§ì ‘?ì¸ ì§„í–‰ ?•ë³´ ?Œì‹± (?? "50/100ì´?)
          const current = parseInt(directProgressMatch[1], 10);
          const total = parseInt(directProgressMatch[2], 10);
          
          if (!isNaN(current) && !isNaN(total) && total > 0) {
            const percentage = Math.min((current / total) * 100, 100);
            setFillPercentage(percentage);
            console.log(`ì±„ì? ? ë‹ˆë©”ì´??ì§„í–‰ë¥??…ë°?´íŠ¸(ì§ì ‘ ?•ì‹): ${percentage.toFixed(1)}% (?„ì¬: ${current}, ?„ì²´: ${total})`);
          }
        } else {
          // 3. JSON ?•ì‹??ê²½ìš° ?Œì‹± ?œë„
          try {
            if (latestProgress.rawJson) {
              const jsonData = JSON.parse(latestProgress.rawJson);
              
              // process_timeê³?total_remaining???¬ìš©??ì§„í–‰ë¥?ê³„ì‚° ì¶”ê?
              if (jsonData.process_time !== undefined && jsonData.total_remaining !== undefined) {
                const processTime = parseInt(jsonData.process_time.toString().replace('s', ''), 10);
                const totalRemaining = parseInt(jsonData.total_remaining.toString().replace('s', ''), 10);
                
                if (!isNaN(processTime) && !isNaN(totalRemaining)) {
                  // ?„ì²´ ì²˜ë¦¬ ?œê°„ - ?´ë? ì²˜ë¦¬???œê°„ê³??¨ì? ?œê°„????                  const totalTime = processTime;
                  // ì§„í–‰ë¥?= ((?„ì²´ ì²˜ë¦¬ ?œê°„ - ?¨ì? ?œê°„) / ?„ì²´ ì²˜ë¦¬ ?œê°„) * 100
                  const completedTime = Math.max(0, processTime - totalRemaining);
                  const percentage = Math.min((completedTime / processTime) * 100, 100);
                  setFillPercentage(percentage);
                  console.log(`ì±„ì? ? ë‹ˆë©”ì´??ì§„í–‰ë¥??…ë°?´íŠ¸(process_time): ${percentage.toFixed(1)}% (ì²˜ë¦¬ ?œê°„: ${processTime}s, ?„ë£Œ ?œê°„: ${completedTime}s, ?¨ì? ?œê°„: ${totalRemaining}s)`);
                }
              } else if (jsonData.elapsedTime !== undefined && jsonData.totalTime !== undefined) {
                const elapsed = parseInt(jsonData.elapsedTime, 10);
                const total = parseInt(jsonData.totalTime, 10);
                
                if (!isNaN(elapsed) && !isNaN(total) && total > 0) {
                  const percentage = Math.min((elapsed / total) * 100, 100);
                  setFillPercentage(percentage);
                  console.log(`ì±„ì? ? ë‹ˆë©”ì´??ì§„í–‰ë¥??…ë°?´íŠ¸(JSON): ${percentage.toFixed(1)}% (ê²½ê³¼: ${elapsed}s, ?„ì²´: ${total}s)`);
                }
              } else if (jsonData.percent !== undefined) {
                // ?¼ì„¼??ì§ì ‘ ?Œì‹±
                const percentStr = jsonData.percent.toString().replace('%', '');
                const percentage = parseFloat(percentStr);
                
                if (!isNaN(percentage)) {
                  setFillPercentage(percentage);
                  console.log(`ì±„ì? ? ë‹ˆë©”ì´??ì§„í–‰ë¥??…ë°?´íŠ¸(?¼ì„¼??: ${percentage.toFixed(1)}%`);
                }
              }
            }
          } catch (jsonError) {
            // JSON ?Œì‹± ?¤íŒ¨?´ë„ ë¬´ì‹œ
          }
        }
      } catch (error) {
        console.error('ì§„í–‰ ë©”ì‹œì§€ ?Œì‹± ?¤ë¥˜:', error);
      }
      
      // 4. ?Œí”„ê°€ ON ?íƒœ?´ë©´ ê¸°ë³¸ê°?50%ë¡??¤ì • (ì±„ì? ? ë‹ˆë©”ì´?˜ì? ë³´ì´ì§€ë§??•í™•??ì§„í–‰ë¥ ì? ?????†ìŒ)
      const anyPumpActive = tankData?.tanks?.some(tank => tank.pumpStatus === "ON");
      if (anyPumpActive && fillPercentage === 0) {
        setFillPercentage(50);
        console.log('?Œí”„ ?œì„±??ê°ì?, ê¸°ë³¸ ì±„ì? ? ë‹ˆë©”ì´???ìš© (50%)');
      }
    }
  }, [progressMessages, tankData?.tanks]);

  // ?±í¬ ?íƒœ???°ë¥¸ ?‰ìƒ ë°˜í™˜ - ?Œí”„ ?íƒœ ìµœìš°???ìš©
  const getTankColor = (status: string | undefined, tankId: number) => {
    // statusê°€ undefined??ê²½ìš° ê¸°ë³¸ê°??¤ì •
    if (status === undefined) {
      console.log(`getTankColor - ?±í¬ ${tankId}, ?íƒœ: undefined, ê¸°ë³¸ê°?'empty' ?¬ìš©`);
      status = 'empty';
    }
    
    // ?´ë‹¹ ?±í¬?€ ?°ê²°???Œí”„???íƒœ ?•ì¸
    let pumpStatus = "OFF";
    if (tankId >= 1 && tankId <= 6 && tankData?.tanks && tankData?.tanks.length >= tankId) {
      const tank = tankData?.tanks[tankId - 1];
      pumpStatus = tank?.pumpStatus || "OFF";
    }
    
    console.log(`getTankColor - ?±í¬ ${tankId}, ?íƒœ: ${status}, ?Œí”„: ${pumpStatus}`);
    
    // 1. ?Œí”„ê°€ ì¼œì ¸ ?ˆìœ¼ë©??¸ë????Œë‘ë¦¬ë¡œ ë³€ê²?- ??ë¡œì§??ìµœìš°??    if (pumpStatus === "ON") {
      return "fill-white stroke-yellow-400 stroke-[3]";
    }
    
    // 2. ?Œí”„ê°€ êº¼ì ¸ ?ˆìœ¼ë©??íƒœ???°ë¼ ?‰ìƒ ê²°ì • (ë©”ì‹œì§€ê°€ ?€???‰ìƒ ë³€ê²½í•˜ì§€ ?ŠìŒ)
    switch (status) {
      case "full":
        return "fill-red-50 stroke-red-500 stroke-[3]";
      case "filling":
        return "fill-blue-50 stroke-blue-400 stroke-[3]"; 
      case "empty":
      default:
        return "fill-white stroke-gray-400 stroke-2";
    }
  };

  // ?±í¬ ?íƒœ???°ë¥¸ ?ì„¸ ë©”ì‹œì§€ ë°˜í™˜
  const getStatusMessage = (status: string, level: number, tankId?: number) => {
    // ë³¸íƒ±??tankIdê°€ 0)??ê²½ìš° mainTankMessage ?°ì„  ?œì‹œ
    if (tankId === 0 && mainTankMessage) {
      return mainTankMessage;
    }
    // ê¸°ë³¸ ?±í¬ ?íƒœ ë©”ì‹œì§€ ë¡œì§
    switch (status) {
      case "full":
        return "ê°€?ì±„?Œì§";
      case "empty":
        return level <= 5 ? "ë¹„ì–´?ˆìŒ(5%ë¯¸ë§Œ)" : "5% ?´ìƒ ?”ì—¬";
      case "filling":
        return `ì±„ì›Œì§€??ì¤?(${Math.round(fillPercentage)}%)`;
      default:
        return `5% ?´ìƒ ?”ì—¬`;
    }
  };

  // ì±„ì›Œì§€??? ë‹ˆë©”ì´?˜ì„ ?„í•œ ?¤í???ê³„ì‚° ?¨ìˆ˜ ê°œì„ 
  const getFillingStyle = (status: string, tankId: number, operationTime?: number) => {
    // ?”ë²„ê¹? ?¨ìˆ˜ ?¸ì¶œ ?•ë³´ ì¶”ê?
    console.log(`[getFillingStyle] ?¸ì¶œ: ?±í¬ ${tankId}, ?íƒœ=${status}, ?‘ë™?œê°„=${operationTime || 'N/A'}`);

    // ?Œí”„ê°€ êº¼ì ¸ ?ˆìœ¼ë©?? ë‹ˆë©”ì´???†ìŒ
    if (status !== "ON") {
      console.log(`[getFillingStyle] ?±í¬ ${tankId}???Œí”„ê°€ êº¼ì ¸ ?ˆì–´ ì±„ì? ?†ìŒ`);
      return {};
    }

    // ?´ë‹¹ ?±í¬?€ ?°ê²°???Œí”„???íƒœ ?•ì¸
    const pumpStatus = tankData?.tanks && tankData?.tanks[tankId - 1]?.pumpStatus || "OFF";
    console.log(`[getFillingStyle] ?±í¬ ${tankId}???Œí”„ ?íƒœ: ${pumpStatus}`);
    
    // ?Œí”„ ì§„í–‰ ?•ë³´ ê°€?¸ì˜¤ê¸?      const pumpProgress = pumpProgressInfo[tankId];
    console.log(`[getFillingStyle] ?Œí”„ ${tankId}??pumpProgressInfo:`, pumpProgress);
      
      if (pumpProgress) {
      // ê°„ë‹¨??? ë‹ˆë©”ì´??ë¡œì§ ?ìš© - elapsed_timeê³?remaining_time??ë¹„ìœ¨ë¡?ê³„ì‚°
      let elapsedTime = 0;
      let totalTime = 0;
      
      // elapsed_time ê°?ì¶”ì¶œ
      if (pumpProgress.elapsed_time !== undefined) {
        if (typeof pumpProgress.elapsed_time === 'number') {
          elapsedTime = pumpProgress.elapsed_time;
        } else if (typeof pumpProgress.elapsed_time === 'string') {
          // ë¬¸ì?´ì—???«ì ì¶”ì¶œ (?? "54s" -> 54)
          const matchElapsed = String(pumpProgress.elapsed_time).match(/(\d+)/);
          if (matchElapsed) {
            elapsedTime = parseInt(matchElapsed[1], 10);
          }
        }
      }
      
      // remaining_time ê°?ì¶”ì¶œ
      if (pumpProgress.remaining_time !== undefined) {
        if (typeof pumpProgress.remaining_time === 'number') {
          totalTime = elapsedTime + pumpProgress.remaining_time;
        } else if (typeof pumpProgress.remaining_time === 'string') {
          // ë¬¸ì?´ì—???«ì ì¶”ì¶œ (?? "6s" -> 6)
          const matchRemaining = String(pumpProgress.remaining_time).match(/(\d+)/);
          if (matchRemaining) {
            const remainingTime = parseInt(matchRemaining[1], 10);
            totalTime = elapsedTime + remainingTime;
          }
        }
      }
      
      console.log(`[getFillingStyle] ?Œí”„ ${tankId} ?œê°„ ê³„ì‚°: elapsedTime=${elapsedTime}, totalTime=${totalTime}`);
      
      // ?°ì´?°ê? ?†ê±°??totalTime??0?´ë©´ ê¸°ë³¸ê°??¬ìš©
      if (totalTime <= 0) {
        console.log(`[getFillingStyle] ?±í¬ ${tankId}???œê°„ ?°ì´?°ê? ?†ê±°??0?…ë‹ˆ?? ê¸°ë³¸ê°??¬ìš©`);
        return {
          clipPath: 'inset(95% 0 0 0)', // ê¸°ë³¸ 5% ì±„ì?
          transition: 'clip-path 1s linear',
          backgroundColor: 'rgba(59, 130, 246, 0.3)'
        };
      }
      
      // ì§„í–‰ë¥?ê³„ì‚° (ë°±ë¶„??
      let fillPercent = Math.min((elapsedTime / totalTime) * 100, 100);
      
      // ìµœì†Œ 5% ì±„ì? ë³´ì¥ (?œê°???¼ë“œë°?
      fillPercent = Math.max(fillPercent, 5);
      
      console.log(`[ê°„ë‹¨??ì±„ì? ê³„ì‚°] ?±í¬ ${tankId}: ${fillPercent.toFixed(1)}% (ê²½ê³¼:${elapsedTime}ì´? ?„ì²´:${totalTime}ì´?`);
      
      // ì£¼ì˜: ?¬ê¸°??ì§ì ‘ ?íƒœë¥??…ë°?´íŠ¸?˜ë©´ ë¬´í•œ ?Œë”ë§ì´ ë°œìƒ?©ë‹ˆ??
      // ?„ì—­ ?íƒœ ?…ë°?´íŠ¸??useEffect?ì„œ ?˜í–‰?´ì•¼ ?©ë‹ˆ??
      
        return {
          clipPath: `inset(${100 - fillPercent}% 0 0 0)`,
          transition: 'clip-path 1s linear',
        backgroundColor: 'rgba(59, 130, 246, 0.3)',
        fillPercent: fillPercent // ë°±ë¶„??ê°’ë„ ?¨ê»˜ ë°˜í™˜
        };
      }
      
      // pumpProgressInfoê°€ ?†ì„ ?Œë§Œ operationTime ?¬ìš© (fallback)
      if (operationTime && operationTime > 0) {
        console.log(`?Œí”„ ${tankId}??ì§„í–‰ ?•ë³´ê°€ ?†ì–´ operationTime ?¬ìš©: ${operationTime}ì´?);
        
        // ?„ì¬ ê²½ê³¼ ?œê°„ ê³„ì‚° (ì²?ë©”ì‹œì§€ ?œê°„ë¶€???„ì¬ê¹Œì?)
        const startTime = tankData?.tanks?.[tankId - 1]?.startTime || Date.now();
        const elapsedTime = (Date.now() - startTime) / 1000; // ì´??¨ìœ„
        
        // ê°€???œê°„??100%ë¡??˜ì—¬ ê²½ê³¼ ?œê°„??ë¹„ë???ì±„ì? ë¹„ìœ¨ ê³„ì‚°
      let fillPercent = Math.min((elapsedTime / operationTime) * 100, 100);
      // ìµœì†Œ 5%??ì±„ì›Œì§€?„ë¡ (?œê°???¼ë“œë°?
      fillPercent = Math.max(fillPercent, 5);
            
      console.log(`[?€ì²?ë°©ì‹] ?±í¬ ${tankId} ì±„ì?ë¥? ${fillPercent.toFixed(1)}%`);
              
              return {
                clipPath: `inset(${100 - fillPercent}% 0 0 0)`,
                transition: 'clip-path 1s linear',
        backgroundColor: 'rgba(59, 130, 246, 0.3)',
        fillPercent: fillPercent // ë°±ë¶„??ê°’ë„ ?¨ê»˜ ë°˜í™˜
              };
      }
      
    // ?Œí”„ê°€ ì¼œì ¸ ?ˆì?ë§?ì§„í–‰ ?•ë³´ê°€ ?†ëŠ” ê²½ìš° ê¸°ë³¸ ì±„ì? (?œê°???¼ë“œë°?
    if (pumpStatus === "ON") {
      console.log(`[ê¸°ë³¸ ì±„ì?] ?±í¬ ${tankId}??ì¼œì ¸ ?ˆì?ë§?ì§„í–‰ ?•ë³´ ?†ìŒ - 10% ì±„ì? ?ìš©`);
      
      return {
        clipPath: 'inset(90% 0 0 0)', // ê¸°ë³¸ 10% ì±„ì?
        transition: 'clip-path 1s linear',
        backgroundColor: 'rgba(59, 130, 246, 0.3)',
        fillPercent: 10 // ë°±ë¶„??ê°’ë„ ?¨ê»˜ ë°˜í™˜
      };
    }
    
    // ê·???ê²½ìš°(?Œí”„ êº¼ì ¸ ?ˆìŒ)
    return { fillPercent: 0 };
  };

  // ë°¸ë¸Œ ?íƒœ ?Œì‹± (4?ë¦¬ ë¬¸ì?´ì—??ì²????ë¦¬ë§??¬ìš©) - ê°œì„ 
  const parseValveState = () => {
    // ?”ë²„ê¹…ìš© ë¡œê·¸ ì¶”ê?
    console.log('[?”ë²„ê¹? parseValveState ?¸ì¶œ??);
    console.log('[?”ë²„ê¹? ?„ì¬ tankData:', tankData);
    console.log('[?”ë²„ê¹? ?„ì¬ ë°¸ë¸Œ ?íƒœ:', tankData.valveState);
    console.log('[?”ë²„ê¹? ë°¸ë¸Œ ?íƒœ ë©”ì‹œì§€:', tankData.valveStatusMessage);
    
    // tankData??? íš¨??ê²€??    if (!tankData || !tankData.valveState) {
      console.log('[?”ë²„ê¹? tankData ?ëŠ” valveStateê°€ ? íš¨?˜ì? ?ŠìŒ, ?€?¥ëœ ?íƒœ ?•ì¸');
      // ?€?¥ëœ ?íƒœ ?•ì¸
      const savedState = loadState();
      if (savedState && savedState.valveState) {
        console.log('?€?¥ëœ ë°¸ë¸Œ ?íƒœ ë°œê²¬:', savedState.valveState);
        return {
          valve1: parseInt(savedState.valveState[0]) || 0,
          valve2: parseInt(savedState.valveState[1]) || 0,
          valve1Desc: savedState.valveADesc || (parseInt(savedState.valveState[0]) === 1 ? 'ì¶”ì¶œ?œí™˜' : '?„ì²´?œí™˜'),
          valve2Desc: savedState.valveBDesc || (parseInt(savedState.valveState[1]) === 1 ? 'ON' : 'OFF')
        };
      }
      
      // ê¸°ë³¸ê°?ë°˜í™˜
      return { valve1: 0, valve2: 0, valve1Desc: '?„ì²´?œí™˜', valve2Desc: 'OFF' };
    }
    
    // ?¹ìˆ˜ ì¼€?´ìŠ¤: 0100 (ë°¸ë¸Œ2 OFF, ë°¸ë¸Œ1 ON)
    if (tankData.valveState === '0100') {
      console.log('?¹ìˆ˜ ì¼€?´ìŠ¤ ê°ì?: 0100 - ë°¸ë¸Œ2 OFF, ë°¸ë¸Œ1 ON');
      // localStorage??ë°¸ë¸Œ ?íƒœ ?€??(?˜í¼ ?¨ìˆ˜ ?¬ìš©)
      saveState(tankData);
      return {
        valve1: 0, // ë°¸ë¸Œ2 OFF (3way)
        valve2: 1, // ë°¸ë¸Œ1 ON (2way)
        valve1Desc: tankData.valveADesc || 'ë³¸íƒ±???˜ì§‘',
        valve2Desc: tankData.valveBDesc || 'ON'
      };
    }
    
    // valveStatusMessageë¥??°ì„ ?ìœ¼ë¡??•ì¸?˜ì—¬ ?íƒœ ?Œì‹±
    if (tankData.valveStatusMessage) {
      console.log('[?”ë²„ê¹? valveStatusMessageë¡??íƒœ ?Œì‹±:');
      // 'valveA=ON' ?ëŠ” 'valveA=OFF' ?¬í•¨ ?¬ë? ?•í™•??ì²´í¬
      const valveAState = tankData.valveStatusMessage.includes('valveA=ON') ? 1 : 0;
      const valveBState = tankData.valveStatusMessage.includes('valveB=ON') ? 1 : 0;
      
      // ë°¸ë¸Œ ?¤ëª… ?ìŠ¤??- dashboard.tsx?ì„œ ?Œì‹±??ê°??¬ìš©
      let valveADesc = tankData.valveADesc || '';
      let valveBDesc = tankData.valveBDesc || '';
      
      // ?¤ëª…???†ìœ¼ë©??íƒœ???°ë¼ ê¸°ë³¸ê°??¤ì •
      if (!valveADesc) {
        valveADesc = valveAState === 1 ? 'ì¶”ì¶œ?œí™˜' : '?„ì²´?œí™˜';
      }
      if (!valveBDesc) {
        valveBDesc = valveBState === 1 ? 'ON' : 'OFF';
      }
      
      // ?”ë²„ê¹…ì„ ?„í•œ ë¡œê·¸
      console.log(`ë°¸ë¸Œ ?íƒœ ?Œì‹± ê²°ê³¼: valveA=${valveAState} (${valveADesc}), valveB=${valveBState} (${valveBDesc})`);
      
      // ë°¸ë¸Œ ?íƒœë¥?ë¡œì»¬ ?¤í† ë¦¬ì????€??(?˜í¼ ?¨ìˆ˜ ?¬ìš©)
      saveState({
        ...tankData,
        valveADesc,
        valveBDesc
      });
      
      return {
        valve1: valveAState,
        valve2: valveBState,
        valve1Desc: valveADesc,
        valve2Desc: valveBDesc
      };
    }
    
    // valveState??ê¸¸ì´ ?•ì¸
    if (typeof tankData.valveState !== 'string' || tankData.valveState.length < 2) {
      console.warn('valveState ?•ì‹ ?¤ë¥˜:', tankData.valveState);
      
      // localStorage???€?¥ëœ ?íƒœ ?•ì¸
      const savedState = loadState();
      if (savedState && savedState.valveState && typeof savedState.valveState === 'string' && savedState.valveState.length >= 2) {
        console.log('localStorage?ì„œ ë°¸ë¸Œ ?íƒœ ë³µì›:', savedState.valveState);
        const v1 = parseInt(savedState.valveState[0]) || 0;
        const v2 = parseInt(savedState.valveState[1]) || 0;
        return {
          valve1: v1,
          valve2: v2,
          valve1Desc: v1 === 1 ? 'ì¶”ì¶œ?œí™˜' : '?„ì²´?œí™˜',
          valve2Desc: v2 === 1 ? 'ON' : 'OFF'
        };
      }
      
      // ê¸°ë³¸ê°?ë°˜í™˜
      return { valve1: 0, valve2: 0, valve1Desc: '?„ì²´?œí™˜', valve2Desc: 'OFF' };
    }
    
    // ê¸°ì¡´ ë¡œì§ ? ì? (fallback)
    if (tankData.valveState.length !== 4) {
      // localStorage???€?¥ëœ ?íƒœê°€ ?ˆìœ¼ë©??¬ìš© (?˜í¼ ?¨ìˆ˜ ?¬ìš©)
      const savedState = loadState();
      if (savedState && savedState.valveState && savedState.valveState.length === 4) {
        console.log('localStorage?ì„œ ë°¸ë¸Œ ?íƒœ ë³µì›:', savedState.valveState);
        const v1 = parseInt(savedState.valveState[0]);
        const v2 = parseInt(savedState.valveState[1]);
        return {
          valve1: v1,
          valve2: v2,
          valve1Desc: v1 === 1 ? 'ì¶”ì¶œ?œí™˜' : '?„ì²´?œí™˜',
          valve2Desc: v2 === 1 ? 'ON' : 'OFF'
        };
      }
      
      // localStorage???€?¥ëœ ë°¸ë¸Œ ?íƒœ ë©”ì‹œì§€ê°€ ?ˆìœ¼ë©??¬ìš© (?˜í¼ ?¨ìˆ˜ ?¬ìš©)
      const savedValveStatusMessage = loadState()?.valveStatusMessage;
      if (savedValveStatusMessage) {
        console.log('localStorage?ì„œ ë°¸ë¸Œ ?íƒœ ë©”ì‹œì§€ ë³µì›:', savedValveStatusMessage);
        const valveAState = savedValveStatusMessage.includes('valveA=ON') ? 1 : 0;
        const valveBState = savedValveStatusMessage.includes('valveB=ON') ? 1 : 0;
        return {
          valve1: valveAState,
          valve2: valveBState,
          valve1Desc: valveAState === 1 ? 'ì¶”ì¶œ?œí™˜' : '?„ì²´?œí™˜',
          valve2Desc: valveBState === 1 ? 'ON' : 'OFF'
        };
      }
      
      // ìµœì†Œ ?ˆì „ ê¸¸ì´ ë³´ì¥
      const safeValveState = (tankData.valveState + '0000').slice(0, 4);
      console.log('?ˆì „?˜ê²Œ ë³´ì •??ë°¸ë¸Œ ?íƒœ:', safeValveState);
      
      const v1 = parseInt(safeValveState[0]) || 0;
      const v2 = parseInt(safeValveState[1]) || 0;
      
      return {
        valve1: v1, 
        valve2: v2,
        valve1Desc: v1 === 1 ? 'ì¶”ì¶œ?œí™˜' : '?„ì²´?œí™˜',
        valve2Desc: v2 === 1 ? 'ON' : 'OFF'
      };
    }

    const v1 = parseInt(tankData.valveState[0]);
    const v2 = parseInt(tankData.valveState[1]);

    // ?„ì¬ ?íƒœë¥?localStorage???€??(?˜í¼ ?¨ìˆ˜ ?¬ìš©)
    saveState(tankData);

    const result = {
      valve1: v1,
      valve2: v2,
      valve1Desc: v1 === 1 ? 'ì¶”ì¶œ?œí™˜' : '?„ì²´?œí™˜',
      valve2Desc: v2 === 1 ? 'ON' : 'OFF'
    };
    
    console.log('[?”ë²„ê¹? parseValveState ê²°ê³¼:', result);
    return result;
  };

  const { valve1, valve2, valve1Desc, valve2Desc } = parseValveState();

  // ê²½ë¡œ ?œì„±???¬ë? ?•ì¸
  const isPathActive = (path: "tank6ToMain" | "tank6ToTank1" | "mainToTank1") => {
    console.log(`[?”ë²„ê¹? isPathActive ?¸ì¶œ: ${path}, valve1=${valve1}, valve2=${valve2}`);
    if (path === "tank6ToMain") return valve1 === 0;
    if (path === "tank6ToTank1") return valve1 === 1;
    if (path === "mainToTank1") return valve2 === 1;
    return false;
  };

  // ë°¸ë¸Œ ?íƒœ???°ë¼ ?¼ì¸ ?œì‹œ ?¬ë? ê²°ì •?˜ëŠ” ?¨ìˆ˜ ì¶”ê?
  const shouldShowLine = (path: "tank6ToMain" | "tank6ToTank1" | "mainToTank1") => {
    console.log(`[?”ë²„ê¹? shouldShowLine ?¸ì¶œ: ${path}, valve1=${valve1}, valve2=${valve2}`);
    if (path === "tank6ToMain") {
      const result = valve1 === 0;
      console.log(`[?”ë²„ê¹? tank6ToMain ?¼ì¸ ?œì‹œ ?¬ë?: ${result}`);
      return result;
    }
    if (path === "tank6ToTank1") {
      const result = valve1 === 1;
      console.log(`[?”ë²„ê¹? tank6ToTank1 ?¼ì¸ ?œì‹œ ?¬ë?: ${result}`);
      return result;
    }
    if (path === "mainToTank1") {
      const result = valve2 === 1;
      console.log(`[?”ë²„ê¹? mainToTank1 ?¼ì¸ ?œì‹œ ?¬ë?: ${result}`);
      return result;
    }
    return false;
  };

  // ë°¸ë¸Œ ?íƒœ???°ë¥¸ ?Œì´???‰ìƒ ê°€?¸ì˜¤ê¸?  const getValvePipeColor = (path: "tank6ToMain" | "tank6ToTank1" | "mainToTank1") => {
    const isActive = isPathActive(path);
    console.log(`[?”ë²„ê¹? getValvePipeColor: ${path}, ?œì„±??${isActive}`);
    return isActive ? "stroke-blue-500" : "stroke-gray-300";
  };

  // ?Œí”„ ?íƒœ???°ë¥¸ ?Œì´???‰ìƒ ê°€?¸ì˜¤ê¸?  const getPipeColor = (fromTank: number, toTank: number) => {
    // 1-based ?¸ë±?¤ë? 0-basedë¡?ë³€??    const fromIndex = fromTank - 1;
    const toIndex = toTank - 1;

    // ?´ë‹¹ êµ¬ê°„???°ê²°???Œí”„???íƒœ ?•ì¸
    // ?? 2-3 êµ¬ê°„?€ 3ë²??Œí”„???°ê²° (?¸ë±??2)
    const pumpIndex = toIndex >= 0 && toIndex < tankData?.tanks?.length ? toIndex : fromIndex;
    const pumpStatus = tankData?.tanks?.[pumpIndex]?.pumpStatus || "OFF";

    return pumpStatus === "ON" ? "stroke-blue-500" : "stroke-gray-300";
  };

  // ë°¸ë¸Œ ?íƒœ???°ë¥¸ ?ìŠ¤??ë°˜í™˜
  const getValveStateText = () => {
    const { valve1, valve2 } = parseValveState();
    
    if (valve1 === 1) {
      return "ì¶”ì¶œ ?œí™˜";
    } else if (valve2 === 1) {
      return "?„ì²´ ?œí™˜ (?´ë¦¼)";
    } else {
      return "ë°¸ë¸Œ ?«í˜";
    }
  };

  // ?¤ìŒ ë°¸ë¸Œ ?íƒœ ê°€?¸ì˜¤ê¸?(?œí™˜)
  const getNextValveState = () => {
    console.log('?„ì¬ ë°¸ë¸Œ ?íƒœ:', tankData.valveState);
    let nextState = '';
    
    // 0100 ?íƒœ?ì„œ ?´ë¦­?˜ë©´ 1000 ?íƒœë¡?ë³€ê²?    if (tankData.valveState === "0100") nextState = "1000";
    // 1000 ?íƒœ?ì„œ ?´ë¦­?˜ë©´ 0000 ?íƒœë¡?ë³€ê²?    else if (tankData.valveState === "1000") nextState = "0000";
    // 0000 ?íƒœ?ì„œ ?´ë¦­?˜ë©´ 0100 ?íƒœë¡?ë³€ê²?    else if (tankData.valveState === "0000") nextState = "0100";
    else nextState = "0100"; // ê¸°ë³¸ê°?    
    // ë³€ê²½ëœ ?íƒœë¥?localStorage???€??(?˜í¼ ?¨ìˆ˜ ?¬ìš©)
    saveState({
      ...tankData,
      valveState: nextState
    });
    console.log('?¤ìŒ ë°¸ë¸Œ ?íƒœ localStorage???€??', nextState);
    
    return nextState;
  };

  // ?í˜• ?ˆì´?„ì›ƒ???„í•œ ê³„ì‚°
  const centerX = 500;
  const centerY = 350; // ë³¸íƒ±???„ì¹˜ë¥??„ë¡œ ì¡°ì •
  const mainTankRadius = 70;
  const circleRadius = 250;
  const tankWidth = 100;
  const tankHeight = 100;
  const pumpRadius = 30;
  const pumpDistance = 60;

  // ?í˜•?¼ë¡œ ë°°ì¹˜???±í¬ ?„ì¹˜ ê³„ì‚°
  const calculatePosition = (index: number, total: number) => {
    // ?œì‘ ê°ë„ë¥?ì¡°ì •?˜ì—¬ 1ë²??±í¬ê°€ ?ë‹¨???¤ë„ë¡???    const startAngle = -Math.PI / 2;
    const angle = startAngle + (index * 2 * Math.PI) / total;
    return {
      x: centerX + circleRadius * Math.cos(angle),
      y: centerY + circleRadius * Math.sin(angle),
      angle: angle,
    };
  };

  // ?±í¬ ?„ì¹˜ ê³„ì‚°
  const tankPositions = Array(6)
    .fill(0)
    .map((_, i) => {
      const pos = calculatePosition(i, 6);
      return {
        ...pos,
        label: `${i + 1}ë²??±í¬`,
      };
    });

  // ë³¸íƒ±???„ì¹˜ - ?¬ê°?•ìœ¼ë¡?ë³€ê²½í•˜ê³??¬ê¸° ?•ë?, ?ˆë¹„ ?•ë?/?’ì´ ê°ì†Œ
  const mainTankPosition = { x: centerX, y: centerY, label: "ë³¸íƒ±??, width: 220, height: 150 };

  // ë°¸ë¸Œ ?„ì¹˜ ê³„ì‚° ?˜ì •
  // 2way ë°¸ë¸Œ(ë°¸ë¸Œ1) ?„ì¹˜ ê³„ì‚° ?˜ì • - ë³¸íƒ±?¬ì—????ë©€?´ì?ê²? 1ë²??±í¬ ?ìŠ¤?¸ë°•?¤ê? ë³´ì´?„ë¡ ?„ë˜ë¡?  const valve2Position = {
    x: centerX,
    y: centerY - 100, // ë³¸íƒ±???„ìª½??ë°°ì¹˜?˜ë˜ ???„ë˜ë¡?ì¡°ì • (ê¸°ì¡´ -150?ì„œ -100?¼ë¡œ)
  };

  // 3way ë°¸ë¸Œ(ë°¸ë¸Œ2) ?„ì¹˜ ê³„ì‚° - 6ë²??±í¬ ë°”ë¡œ ?°ì¸¡??ë°°ì¹˜?˜ê³  ?½ê°„ ?„ë˜ë¡??´ë¦¼
  const valve3wayPosition = {
    x: tankPositions[5].x + tankWidth / 2 + 50, // 6ë²??±í¬ ë°”ë¡œ ?°ì¸¡?¼ë¡œ ?´ë™
    y: tankPositions[5].y + 20, // 6ë²??±í¬?€ ?™ì¼???’ì´?ì„œ ?½ê°„ ?„ë˜ë¡?ì¡°ì •
  };

  // ?Œí”„ ?„ì¹˜ ê³„ì‚° ?¨ìˆ˜ ?˜ì • - ?„ì¬ ?±í¬?€ ?¤ìŒ ?±í¬ ?¬ì´???„ì¹˜?˜ë„ë¡?  const calculatePumpPosition = (currentTankIndex: number, nextTankIndex: number) => {
    const currentTank = tankPositions[currentTankIndex];
    const nextTank = tankPositions[nextTankIndex];

    // ???±í¬ ê°„ì˜ ì¤‘ê°„ ì§€?ì— ?Œí”„ ë°°ì¹˜
    return {
      x: (currentTank.x + nextTank.x) / 2,
      y: (currentTank.y + nextTank.y) / 2,
      angle: currentTank.angle
    };
  };

  // ?±í¬ ê°??Œì´??ê²½ë¡œ ê³„ì‚°
  const calculatePipePath = (fromIndex: number, toIndex: number) => {
    const from = tankPositions[fromIndex];
    const to = tankPositions[toIndex];

    // ì§ì„  ê²½ë¡œ
    return `M ${from.x} ${from.y} L ${to.x} ${to.y}`;
  };

  // 6ë²??±í¬?ì„œ 3way ë°¸ë¸Œ(ë°¸ë¸Œ2)ë¡œì˜ ê²½ë¡œ - ?°ì¸¡?¼ë¡œ ì§§ê²Œ ?°ê²°
  const calculate6ToValvePath = () => {
    // 6ë²??±í¬?ì„œ ?°ì¸¡?¼ë¡œ ì§§ê²Œ ?˜ì˜¨ ??3way ë°¸ë¸Œë¡??°ê²°
    const startX = tankPositions[5].x + tankWidth / 2;
    const startY = tankPositions[5].y;
    
    // 6ë²??±í¬?€ ë°¸ë¸Œ2ê°€ ê°™ì? ?’ì´???ˆìœ¼ë¯€ë¡?ì§ì„ ?¼ë¡œ ?°ê²°
    return `M ${startX} ${startY} H ${valve3wayPosition.x - 30}`;
  };

  // 3way ë°¸ë¸Œ(ë°¸ë¸Œ2)?ì„œ ë³¸íƒ±?¬ë¡œ??ê²½ë¡œ - ?„ì²´?œí™˜???Œë§Œ ?œì‹œ
  const calculate3wayToMainPath = () => {
    // ë°¸ë¸Œ2?ì„œ ë³¸íƒ±???¼ìª½ ê°€?¥ìë¦¬ê¹Œì§€ ì§ì„  ?°ê²°
    const tankLeft = mainTankPosition.x - mainTankPosition.width / 2;
    const tankMid = mainTankPosition.y;
    
    // ê²½ë¡œ ì¡°ì •: ë°¸ë¸Œ2?ì„œ ?˜ì???ì¤‘ê°„ ì§€?ì—??êº¾ì—¬ ë³¸íƒ±?¬ë¡œ
    return `M ${valve3wayPosition.x} ${valve3wayPosition.y} 
            H ${(valve3wayPosition.x + tankLeft) / 2}
            L ${tankLeft + 20} ${tankMid}`;
  };

  // ë³¸íƒ±?¬ì—??2way ë°¸ë¸Œ(ë°¸ë¸Œ1)ë¡œì˜ ê²½ë¡œ - ??ƒ ?œì‹œ
  const calculateMainToTank1Path = () => {
    // ë³¸íƒ±???„ìª½ ê°€?¥ìë¦¬ì—???œì‘?˜ì—¬ 2way ë°¸ë¸Œê¹Œì? ?˜ì§ ?°ê²° - ì§§ê²Œ ?˜ë˜ ë³´ì´?„ë¡
    const tankEdgeY = mainTankPosition.y - mainTankPosition.height / 2;
    // ë³¸íƒ±???ë‹¨?ì„œ ë°¸ë¸Œ1ê¹Œì???ê±°ë¦¬??30%ë§??°ê²°?˜ì—¬ ?ˆì— ë³´ì´ê²???    const lineLength = Math.abs(valve2Position.y - tankEdgeY) * 0.3;
    return `M ${mainTankPosition.x} ${tankEdgeY} V ${tankEdgeY - lineLength}`;
  };

  // 2way ë°¸ë¸Œ(ë°¸ë¸Œ1)?ì„œ ?Œí”„1 ?…êµ¬ ìª½ìœ¼ë¡œì˜ ê²½ë¡œ - ??ƒ ?œì‹œ
  const calculate2wayToPump1Path = () => {
    const pump1Pos = calculatePumpPosition(5, 0);
    
    // ë°¸ë¸Œ1?ì„œ ì¶œë°œ?˜ì—¬ ?Œí”„1 ë°©í–¥?¼ë¡œ ê°€??ê²½ë¡œ - ë°¸ë¸Œ1 ?„ì¹˜ê°€ ë³€ê²½ë˜?ˆìœ¼ë¯€ë¡?ê²½ë¡œ??ì¡°ì •
    return `M ${valve2Position.x} ${valve2Position.y} 
            V ${(valve2Position.y + pump1Pos.y) / 2}
            L ${pump1Pos.x} ${pump1Pos.y}`;
  };

  // 3way ë°¸ë¸Œ(ë°¸ë¸Œ2)?ì„œ ?Œí”„ 1ë¡œì˜ ê²½ë¡œ - ì¶”ì¶œ?œí™˜???Œë§Œ ?œì‹œ
  const calculate3wayToPump1Path = () => {
    const pump1Pos = calculatePumpPosition(5, 0);
    
    // ?œì‘?ê³¼ ?ì  ?¬ì´ ë²¡í„° ê³„ì‚°
    const dx = pump1Pos.x - valve3wayPosition.x;
    const dy = pump1Pos.y - valve3wayPosition.y;
    
    // ë²¡í„° ê¸¸ì´
    const length = Math.sqrt(dx*dx + dy*dy);
    
    // ë°¸ë¸Œ2?ì„œ ?Œí”„1 ë°©í–¥?¼ë¡œ 85% ?•ë„ ?´ë™??ì§€?ìœ¼ë¡??°ê²° (ê¸°ì¡´ 50%?ì„œ ì¦ê?)
    const endX = valve3wayPosition.x + dx * 0.85;
    const endY = valve3wayPosition.y + dy * 0.85;
    
    return `M ${valve3wayPosition.x} ${valve3wayPosition.y} L ${endX} ${endY}`;
  };

  // ?©ë¥˜ ì§€?ì—???Œí”„1ë¡œì˜ ê²½ë¡œ
  const calculateMergeToPump1Path = () => {
    const pump1Pos = calculatePumpPosition(5, 0);
    return `M ${pump1Pos.x} ${pump1Pos.y} L ${pump1Pos.x} ${pump1Pos.y}`; // ë³€ê²??†ëŠ” ê²½ë¡œ
  };

  // 1ë²??Œí”„?ì„œ 1ë²??±í¬ë¡œì˜ ê²½ë¡œ (ì§ì„  ?°ê²°)
  const calculatePump1To1Path = () => {
    const pump1Pos = calculatePumpPosition(5, 0);
    return `M ${pump1Pos.x} ${pump1Pos.y} L ${tankPositions[0].x} ${tankPositions[0].y}`;
  };

  // 1ë²??±í¬?ì„œ 2ë²??Œí”„ë¡œì˜ ê²½ë¡œ
  const calculate1ToPump2Path = () => {
    const pump2Pos = calculatePumpPosition(0, 1);
    return `M ${tankPositions[0].x} ${tankPositions[0].y} L ${pump2Pos.x} ${pump2Pos.y}`;
  };

  // 2ë²??Œí”„?ì„œ 2ë²??±í¬ë¡œì˜ ê²½ë¡œ
  const calculatePump2To2Path = () => {
    const pump2Pos = calculatePumpPosition(0, 1);
    return `M ${pump2Pos.x} ${pump2Pos.y} L ${tankPositions[1].x} ${tankPositions[1].y}`;
  };

  // ë°¸ë¸Œ ?íƒœ ë©”ì‹œì§€?ì„œ ?„ìš”??ë¶€ë¶„ë§Œ ì¶”ì¶œ
  const extractValveStatus = (message: string) => {
    if (!message) return "";
    
    // valveA?€ valveB ë¶€ë¶„ë§Œ ì¶”ì¶œ?˜ëŠ” ?•ê·œ??    const valveAMatch = message.match(/valveA=[^,]+/);
    const valveBMatch = message.match(/valveB=[^,]+/);
    
    const valveA = valveAMatch ? valveAMatch[0] : "";
    const valveB = valveBMatch ? valveBMatch[0] : "";
    
    if (valveA && valveB) {
      return `${valveA}, ${valveB}`;
    } else if (valveA) {
      return valveA;
    } else if (valveB) {
      return valveB;
    }
    
    return "";
  };

  // ?”ì‚´???„ì¹˜ ê³„ì‚°
  const calculateArrowPosition = (path: string, progress = 0.5) => {
    // SVG ê²½ë¡œ ê°ì²´ ?ì„±
    const dummySvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    const pathElement = document.createElementNS("http://www.w3.org/2000/svg", "path");
    pathElement.setAttribute("d", path);
    dummySvg.appendChild(pathElement);
    
    // ê²½ë¡œ??ê¸¸ì´ êµ¬í•˜ê¸?    const pathLength = pathElement.getTotalLength();
    
    // ?¹ì • ?„ì¹˜????êµ¬í•˜ê¸?(ê¸°ë³¸ê°? ê²½ë¡œ??ì¤‘ê°„??
    const point = pathElement.getPointAtLength(pathLength * progress);
    
    return { x: point.x, y: point.y };
  };

  // ?Œì´?„ê? ?œì„±???íƒœ?¸ì? ?•ì¸
  const isPipeActive = (pumpIndex: number, valveCondition: boolean = true) => {
    return tankData?.tanks && 
           tankData?.tanks[pumpIndex] && 
           tankData?.tanks[pumpIndex].pumpStatus === "ON" && 
           valveCondition;
  };

  // ì¶”ì¶œ ëª…ë ¹ ì¤‘ë³µ ?¤í–‰ ë°©ì?ë¥??„í•œ ?íƒœ
  const [commandLock, setCommandLock] = useState<Record<string, boolean>>({});

  // ì¶”ì¶œ ?œì–´ ëª…ë ¹ ë°œí–‰ ?¨ìˆ˜ (?”ë°”?´ì‹± ?ìš©)
  const handleExtractionCommand = (command: string) => {
    if (!mqttClient || commandLock[command]) return;
    
    // ?°ì† ?´ë¦­ ë°©ì?ë¥??„í•œ ???¤ì •
    setCommandLock(prev => ({ ...prev, [command]: true }));
    
      mqttClient.publish("extwork/extraction/input", command);
      
      // MQTT ?Œë¦¼ ë°œí–‰
      const notification = {
        type: 'extraction-command',
        command,
        timestamp: Date.now(),
        clientId: clientId.current,
        message: `ì¶”ì¶œ ëª…ë ¹??ë°œí–‰?˜ì—ˆ?µë‹ˆ?? ${command}`
      };
      
      mqttClient.publish('tank-system/notifications', JSON.stringify(notification));
      
      // ?´ë¦­ ?¨ê³¼
      const commandElement = document.getElementById(`extraction-command-${command}`);
      if (commandElement) {
        commandElement.classList.add('bg-blue-200');
        setTimeout(() => {
          commandElement?.classList.remove('bg-blue-200');
        }, 300);
      }
    
    // ?¼ì • ?œê°„ ?????´ì œ (500ms)
    setTimeout(() => {
      setCommandLock(prev => ({ ...prev, [command]: false }));
    }, 500);
  };
  
  // ?¤ìœ„ì¹??œë˜ê·??œì‘
  const handlePumpSwitchStart = (pumpId: number, e: React.MouseEvent | React.TouchEvent) => {
    setDraggingPump(pumpId);
    document.addEventListener('mousemove', handlePumpSwitchMove);
    document.addEventListener('touchmove', handlePumpSwitchMove);
    document.addEventListener('mouseup', handlePumpSwitchEnd);
    document.addEventListener('touchend', handlePumpSwitchEnd);
  };
  
  // ?¤ìœ„ì¹??œë˜ê·??´ë™
  const handlePumpSwitchMove = (e: MouseEvent | TouchEvent) => {
    if (!draggingPump) return;
    
    // ë§ˆìš°???ëŠ” ?°ì¹˜ Y ì¢Œí‘œ
    const clientY = 'touches' in e ? e.touches[0].clientY : e.clientY;
    
    // ?Œí”„ ?”ì†Œ???„ì¹˜ êµ¬í•˜ê¸?    const pumpElement = document.getElementById(`pump-${draggingPump}`);
    if (!pumpElement) return;
    
    const rect = pumpElement.getBoundingClientRect();
    const switchHeight = 40; // ?¤ìœ„ì¹??’ì´
    
    // ?¤ìœ„ì¹??„ì¹˜ ê³„ì‚° (0: ê¸°ë³¸, -1: ?„ë¡œ ?´ë™)
    let position = 0;
    if (clientY < rect.top - switchHeight/2) {
      position = -1; // ?„ë¡œ ?´ë™
      
      // ë¦¬ì…‹ ?€?´ë¨¸ ?¤ì • (3ì´???ë¦¬ì…‹ ëª…ë ¹)
      if (!resetTimers[draggingPump]) {
        console.log(`?Œí”„ ${draggingPump} ?¤ìœ„ì¹??„ë¡œ ?´ë™ - ë¦¬ì…‹ ?€?´ë¨¸ ?œì‘`);
        const timer = setTimeout(() => {
          console.log(`?Œí”„ ${draggingPump} ë¦¬ì…‹ ëª…ë ¹ ?¤í–‰`);
          if (onPumpReset) {
            onPumpReset(draggingPump);
            
            // "3" ëª…ë ¹ ë°œí–‰ - ë¦¬ì…‹?ëŠ” 3 ì½”ë“œ ?¬ìš©
            if (mqttClient) {
              const pumpTopic = `extwork/pump${draggingPump}/cmd`;
              mqttClient.publish(pumpTopic, "3");
              
              // ?Œë¦¼ ë°œí–‰
              const notification = {
                type: 'pump-reset',
                pumpId: draggingPump,
                timestamp: Date.now(),
                clientId: clientId.current,
                message: `?Œí”„ ${draggingPump} ë¦¬ì…‹ ëª…ë ¹(3)???¤í–‰?˜ì—ˆ?µë‹ˆ??`
              };
              
              mqttClient.publish('tank-system/notifications', JSON.stringify(notification));
            }
          }
          
          // ?€?´ë¨¸ ë¦¬ì…‹ ë°??íƒœ ì´ˆê¸°??          setResetDragState(prev => ({
            ...prev,
            [draggingPump]: {
              dragging: false,
              position: 0,
              timer: null
            }
          }));
        }, 2000); // 2ì´????¤í–‰
        
        setResetTimers(prev => ({...prev, [draggingPump]: timer}));
      }
    } else {
      // ?€?´ë¨¸ ì·¨ì†Œ
      if (resetTimers[draggingPump]) {
        clearTimeout(resetTimers[draggingPump]!);
        setResetTimers(prev => ({...prev, [draggingPump]: null}));
      }
    }
    
    setPumpSwitchPosition(prev => ({...prev, [draggingPump]: position}));
  };
  
  // ?¤ìœ„ì¹??œë˜ê·?ì¢…ë£Œ
  const handlePumpSwitchEnd = (e: MouseEvent | TouchEvent) => {
    if (!draggingPump) return;
    
    // ?´ë²¤??ë¦¬ìŠ¤???œê±°
    document.removeEventListener('mousemove', handlePumpSwitchMove);
    document.removeEventListener('touchmove', handlePumpSwitchMove);
    document.removeEventListener('mouseup', handlePumpSwitchEnd);
    document.removeEventListener('touchend', handlePumpSwitchEnd);
    
    // ?€?´ë¨¸ ì·¨ì†Œ
    if (resetTimers[draggingPump]) {
      clearTimeout(resetTimers[draggingPump]!);
      setResetTimers(prev => ({...prev, [draggingPump]: null}));
    }
    
    // ëª¨ë“  ?Œí”„???€???™ì¼?˜ê²Œ ì²˜ë¦¬
    if (onPumpToggle) {
      // ?„ì¬ ?„ì¹˜ê°€ 0?´ë©´ ? ê?
      if (pumpSwitchPosition[draggingPump] === 0) {
        onPumpToggle(draggingPump);
      }
    }
    
    // ?„ì¹˜ ì´ˆê¸°??    setPumpSwitchPosition(prev => ({...prev, [draggingPump]: 0}));
    setDraggingPump(null);
  };

  // ìµœì´ˆ ë¡œë“œ ë°??€?¥ëœ ?íƒœ ë³µì›
  useEffect(() => {
    // ì¤‘ìš”: ë¹„ë™ê¸??¨ìˆ˜ë¥?ë³„ë„ë¡?? ì–¸?˜ì—¬ ?¤í–‰
    const loadSavedState = async () => {
      try {
        if (mqttClient) {
          // ?œë²„ ë°?ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ?íƒœ ë¡œë“œ ?œë„
          const savedState = await loadInitialState();
          
          if (savedState) {
            console.log('?€?¥ëœ ?íƒœë¥?ë³µì›?©ë‹ˆ??');
            
            try {
              // ?€?¥ëœ ?íƒœë¡??…ë°?´íŠ¸ ë¡œì§ (?? onValveChange ?¸ì¶œ ??
              if (savedState.valveState && onValveChange) {
                onValveChange(savedState.valveState);
              }
              
              // ?„ìš”??ê²½ìš° ?íƒœ ?…ë°?´íŠ¸ë¥?MQTTë¡?ë¸Œë¡œ?œìº?¤íŠ¸
              if (mqttClient.connected) {
                mqttClient.publish('tank-system/state-loaded', JSON.stringify({
                  clientId: clientId.current,
                  timestamp: Date.now(),
                  source: 'localStorage'
                }));
              }
            } catch (updateError) {
              console.error('?íƒœ ë³µì› ì¤??¤ë¥˜ ë°œìƒ:', updateError);
              // ?¤ë¥˜ê°€ ë°œìƒ?´ë„ ì»´í¬?ŒíŠ¸ ì´ˆê¸°?”ë? ê³„ì† ì§„í–‰?©ë‹ˆ??
            }
          }
        }
      } catch (error) {
        console.error('?íƒœ ë¡œë“œ ì¤??ˆìƒì¹?ëª»í•œ ?¤ë¥˜:', error);
        // ?¤ë¥˜ê°€ ë°œìƒ?´ë„ ?±ì´ ê³„ì† ?¤í–‰?˜ë„ë¡??©ë‹ˆ??
      }
    };
    
    // ?ˆì „?˜ê²Œ ì´ˆê¸°???¨ìˆ˜ ?¸ì¶œ
    loadSavedState().catch(error => {
      console.error('?íƒœ ë¡œë“œ ?„ë¡œ?¸ìŠ¤ ?„ì²´ ?¤íŒ¨:', error);
    });
  }, [mqttClient, onValveChange]);

  const [mainTankLevelMessage, setMainTankLevelMessage] = useState<string>("");
  const [tankMessages, setTankMessages] = useState<Record<number, string>>({});
  const [mainTankMessage, setMainTankMessage] = useState<string>("");
  const [errorMessage, setErrorMessage] = useState<string>("");
  const [processRunning, setProcessRunning] = useState<boolean>(false);

  // ì»´í¬?ŒíŠ¸ ë§ˆìš´????ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ?„ë¡œ?¸ìŠ¤ ?¤í–‰ ?íƒœ ?•ì¸
  useEffect(() => {
    const savedProcessState = localStorage.getItem('process-running-state');
    if (savedProcessState) {
      try {
        const state = JSON.parse(savedProcessState);
        setProcessRunning(state.running);
      } catch (error) {
        console.error('?€?¥ëœ ?„ë¡œ?¸ìŠ¤ ?íƒœ ?Œì‹± ?¤ë¥˜:', error);
      }
    }
  }, []);

  // ì»´í¬?ŒíŠ¸ ë§ˆìš´?????±í¬ ë©”ì‹œì§€ ì´ˆê¸°??  useEffect(() => {
    console.log('TankSystem ì»´í¬?ŒíŠ¸ ë§ˆìš´??- tankData:', tankData);
    
    // tankData?ì„œ ?±í¬ ë©”ì‹œì§€ ?…ë°?´íŠ¸
    if (tankData.tankMessages) {
      setTankMessages(tankData.tankMessages);
    }
    
    // ë©”ì¸ ?±í¬ ë©”ì‹œì§€ ?…ë°?´íŠ¸
    if (tankData?.mainTankMessage) {
      console.log('ë©”ì¸ ?±í¬ ë©”ì‹œì§€ ?…ë°?´íŠ¸ ê°ì?:', tankData?.mainTankMessage);
      setMainTankMessage(tankData?.mainTankMessage);
    }
  }, [tankData]);

  // ?ëŸ¬ ë©”ì‹œì§€ êµ¬ë… ì²˜ë¦¬
  useEffect(() => {
    if (!mqttClient) return;

    const handleErrorMessage = (topic: string, message: Buffer) => {
      if (topic === 'extwork/extraction/error') {
        const messageStr = message.toString();
        console.log('?ëŸ¬ ë©”ì‹œì§€ ?˜ì‹ :', messageStr);
        
        // ?œê°„ ì¶”ê?
        const timeStr = formatTimeStr();
        setErrorMessage(`${messageStr} (${timeStr})`);
        
        // 5ì´???ë©”ì‹œì§€ ?œê±°
        setTimeout(() => {
          setErrorMessage('');
        }, 10000);
      }
    };

    mqttClient.subscribe('extwork/extraction/error');
    mqttClient.on('message', handleErrorMessage);

    return () => {
      mqttClient.unsubscribe('extwork/extraction/error');
      mqttClient.off('message', handleErrorMessage);
    };
  }, [mqttClient]);

  // ?„ë¡œ?¸ìŠ¤ ?„ë£Œ ê°ì? ë°?ë²„íŠ¼ ?íƒœ ?…ë°?´íŠ¸
  useEffect(() => {
    if (!mqttClient) return;

    const handleProcessCompletion = (topic: string, message: Buffer) => {
      if (topic === 'extwork/extraction/output') {
        const messageStr = message.toString();
        
        // ?„ë£Œ ë©”ì‹œì§€ ?•ì¸
        if (messageStr.includes("ê³µì • ì¢…ë£Œ") || 
            messageStr.includes("?¬ì´???„ë£Œ") || 
            messageStr.includes("JSON ëª…ë ¹???±ê³µ?ìœ¼ë¡?ì²˜ë¦¬")) {
          // ?„ë¡œ?¸ìŠ¤ ì¢…ë£Œ ?íƒœë¡?ë³€ê²?          setProcessRunning(false);
          localStorage.setItem('process-running-state', JSON.stringify({ running: false }));
          console.log('?„ë¡œ?¸ìŠ¤ ?„ë£Œ ê°ì?, ?íƒœ ì´ˆê¸°??);
        }
      } else if (topic === 'extwork/automation/control') {
        const messageStr = message.toString();
        
        try {
          const command = JSON.parse(messageStr);
          if (command.command === 'start' || command.command === 'play') {
            // ?„ë¡œ?¸ìŠ¤ ?œì‘ ?íƒœë¡?ë³€ê²?            setProcessRunning(true);
            localStorage.setItem('process-running-state', JSON.stringify({ running: true }));
            console.log('?„ë¡œ?¸ìŠ¤ ?œì‘ ê°ì?, ?íƒœ ?œì„±??);
          } else if (command.command === 'stop' || command.command === 'reset') {
            // ?„ë¡œ?¸ìŠ¤ ì¢…ë£Œ ?íƒœë¡?ë³€ê²?            setProcessRunning(false);
            localStorage.setItem('process-running-state', JSON.stringify({ running: false }));
            console.log('?„ë¡œ?¸ìŠ¤ ì¤‘ì? ê°ì?, ?íƒœ ì´ˆê¸°??);
          }
        } catch (e) {
          console.error('?ë™??ëª…ë ¹ ?Œì‹± ?¤ë¥˜:', e);
        }
      }
    };

    mqttClient.subscribe('extwork/extraction/output');
    mqttClient.subscribe('extwork/automation/control');
    mqttClient.on('message', handleProcessCompletion);

    return () => {
      mqttClient.unsubscribe('extwork/extraction/output');
      mqttClient.unsubscribe('extwork/automation/control');
      mqttClient.off('message', handleProcessCompletion);
    };
  }, [mqttClient]);

  // ?¹ìˆ˜ extraction ? í”½ ë©”ì‹œì§€ ì²˜ë¦¬ ì¶”ê?
  useEffect(() => {
    if (!mqttClient) return;

    const handleExtractionMessage = (topic: string, message: Buffer) => {
      if (topic === 'extwork/extraction/output') {
        const messageStr = message.toString();
        console.log('ì¶”ì¶œ ë©”ì‹œì§€ ?˜ì‹ :', messageStr);
        
        // ?¹ì • ?„ë£Œ ë©”ì‹œì§€ ?•ì¸
        if (messageStr.includes("ê³µì • ì¢…ë£Œ") || 
            messageStr.includes("?¬ì´???„ë£Œ") || 
            messageStr.includes("JSON ëª…ë ¹???±ê³µ?ìœ¼ë¡?ì²˜ë¦¬?˜ì—ˆ?µë‹ˆ??)) {
          // ?œê°„ ì¶”ê?
          const timeStr = formatTimeStr();
          setExtractionCompleteMessage(`${messageStr} (${timeStr})`);
        }
      }
    };

    mqttClient.subscribe('extwork/extraction/output');
    mqttClient.on('message', handleExtractionMessage);

    return () => {
      mqttClient.unsubscribe('extwork/extraction/output');
      mqttClient.off('message', handleExtractionMessage);
    };
  }, [mqttClient]);

  // ?œê°„ ?¬ë§· ?¨ìˆ˜ ì¶”ê?
  const formatTimeStr = () => {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const seconds = now.getSeconds();
    const ampm = hours >= 12 ? '?¤í›„' : '?¤ì „';
    const hour12 = hours % 12 || 12; // 12?œê°„??ë³€??    return `${ampm} ${hour12}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  };

  // MQTT ë©”ì‹œì§€ ?Œì‹± ë°?ì²˜ë¦¬ë¥??„í•œ ì¶”ê? ?íƒœ
  const [extractionCompleteMessage, setExtractionCompleteMessage] = useState<string>("");
  const [automationStatus, setAutomationStatus] = useState<string>("");
  const [automationWaitTime, setAutomationWaitTime] = useState<{value: number, endTime: number} | null>(null);

  // ?ë™??ê³µì • ?íƒœ ë°??€ê¸°ì‹œê°?ëª¨ë‹ˆ?°ë§ MQTT ë©”ì‹œì§€ ì²˜ë¦¬ ì¶”ê?
  useEffect(() => {
    if (!mqttClient) return;

    const handleAutomationMessage = (topic: string, message: Buffer) => {
      // ?ë™??ê³µì • ê´€??ë©”ì‹œì§€ ì²˜ë¦¬
      if (topic === 'extwork/extraction/output') {
        const messageStr = message.toString();
        console.log('?ë™??ë©”ì‹œì§€ ?˜ì‹ :', messageStr);
        
        // JSON ëª…ë ¹ ?±ê³µ ë©”ì‹œì§€ ì²˜ë¦¬
        if (messageStr.includes("JSON ëª…ë ¹???±ê³µ?ìœ¼ë¡?ì²˜ë¦¬?˜ì—ˆ?µë‹ˆ??)) {
          const timeStr = formatTimeStr();
          setAutomationStatus(`ê³µì • ì§„í–‰ì¤?(${timeStr})`);
        }
        // ê³µì • ì¢…ë£Œ ë©”ì‹œì§€ ì²˜ë¦¬
        else if (messageStr.includes("ê³µì • ì¢…ë£Œ") || 
                messageStr.includes("ê³µì •ì¢…ë£Œ") || 
                messageStr.includes("?„ë£Œ") || 
                messageStr.includes("process completed") || 
                messageStr.includes("extraction complete")) {
          const timeStr = formatTimeStr();
          setExtractionCompleteMessage(`ê³µì • ì¢…ë£Œ (${timeStr})`);
          setAutomationStatus(`ê³µì • ì¢…ë£Œ??(${timeStr})`);
        }
      }
      
      // ?ë™??ê³µì • ?€ê¸°ì‹œê°?ë©”ì‹œì§€ ì²˜ë¦¬
      if (topic === 'extwork/automation/status') {
        try {
          const data = JSON.parse(message.toString());
          if (data.waiting && data.waitTime) {
            const waitTime = parseInt(data.waitTime);
            const endTime = Date.now() + (waitTime * 1000);
            setAutomationWaitTime({value: waitTime, endTime: endTime});
            
            // ?€ê¸°ì‹œê°?ì¹´ìš´?¸ë‹¤??            const countdownInterval = setInterval(() => {
              const now = Date.now();
              const remaining = Math.max(0, Math.ceil((endTime - now) / 1000));
              
              if (remaining <= 0) {
                clearInterval(countdownInterval);
                setAutomationWaitTime(null);
              } else {
                setAutomationWaitTime({value: remaining, endTime: endTime});
              }
            }, 1000);
            
            return () => clearInterval(countdownInterval);
          }
        } catch (e) {
          console.error('?ë™???íƒœ ë©”ì‹œì§€ ?Œì‹± ?¤ë¥˜:', e);
        }
      }
    };

    mqttClient.subscribe('extwork/extraction/output');
    mqttClient.subscribe('extwork/automation/status');
    mqttClient.on('message', handleAutomationMessage);

    return () => {
      mqttClient.unsubscribe('extwork/automation/status');
      mqttClient.off('message', handleAutomationMessage);
    };
  }, [mqttClient]);

  // ?Œí”„ ?°ê²° ?íƒœ ê´€ë¦?ì¶”ê?
  const [pumpConnectionStates, setPumpConnectionStates] = useState<{[key: number]: {ble: boolean, mqtt: boolean}}>({
    1: { ble: false, mqtt: false },
    2: { ble: false, mqtt: false },
    3: { ble: false, mqtt: false },
    4: { ble: false, mqtt: false },
    5: { ble: false, mqtt: false },
    6: { ble: false, mqtt: false }
  });
  
  // ?Œí”„ ?°ê²° ?íƒœ êµ¬ë… ?¤ì •
  useEffect(() => {
    if (!mqttClient) return;
    
    // ê°??Œí”„??overallstate ? í”½ êµ¬ë…
    for (let i = 1; i <= 6; i++) {
      mqttClient.subscribe(`extwork/inverter${i}/overallstate`);
    }
    
    // ë©”ì‹œì§€ ?¸ë“¤??ì¶”ê?
    const handleConnectionStateMessage = (topic: string, message: Buffer) => {
      try {
        const pumpMatch = topic.match(/extwork\/inverter(\d+)\/overallstate/);
        if (!pumpMatch) return;
        
        const pumpId = parseInt(pumpMatch[1]);
        const messageStr = message.toString();
        
        // ?°ê²° ?íƒœ ê°ì?
        if (messageStr.includes("MQTT ë°?BLE ëª¨ë‘ ?°ê²°??)) {
          setPumpConnectionStates(prev => ({
            ...prev,
            [pumpId]: { ble: true, mqtt: true }
          }));
        } else if (messageStr.includes("MQTTë§??°ê²°??) || messageStr.includes("MQTT ?˜ê²½?¼ë¡œ ?„í™˜??) || messageStr.includes("MQTT ?˜ê²½?ì„œ ?™ì‘ ì¤?)) {
          setPumpConnectionStates(prev => ({
            ...prev,
            [pumpId]: { ...prev[pumpId], mqtt: true, ble: false }
          }));
        } else if (messageStr.includes("BLEë§??°ê²°??) || messageStr.includes("BLE ?˜ê²½?¼ë¡œ ?„í™˜??) || messageStr.includes("ì§‘ë‹¨ì§€???¤íŠ¸?Œí¬")) {
          setPumpConnectionStates(prev => ({
            ...prev,
            [pumpId]: { ...prev[pumpId], mqtt: false, ble: true }
          }));
        } else if (messageStr.includes("MQTT ë°?BLE ëª¨ë‘ ?°ê²° ?Šê?")) {
          setPumpConnectionStates(prev => ({
            ...prev,
            [pumpId]: { mqtt: false, ble: false }
          }));
        } else if (messageStr.includes("BLE ?´ë¼?´ì–¸???°ê²°??)) {
          setPumpConnectionStates(prev => ({
            ...prev,
            [pumpId]: { ...prev[pumpId], ble: true }
          }));
        } else if (messageStr.includes("BLE ?´ë¼?´ì–¸???°ê²° ?Šê?")) {
          setPumpConnectionStates(prev => ({
            ...prev,
            [pumpId]: { ...prev[pumpId], ble: false }
          }));
        }

        // Dashboard?ì„œ ?¤ì •??connectionType ê¸°ë°˜ ?íƒœ ?…ë°?´íŠ¸
        if (tankData?.tanks && tankData.tanks[pumpId - 1]) {
          const connectionType = tankData.tanks[pumpId - 1].connectionType;
          if (connectionType === "BLE") {
            setPumpConnectionStates(prev => ({
              ...prev,
              [pumpId]: { ...prev[pumpId], mqtt: false, ble: true }
            }));
          } else if (connectionType === "WiFi") {
            setPumpConnectionStates(prev => ({
              ...prev,
              [pumpId]: { ...prev[pumpId], mqtt: true, ble: false }
            }));
          }
        }
      } catch (error) {
        console.error("Error handling connection state message:", error);
      }
    };
    
    mqttClient.on('message', handleConnectionStateMessage);
    
    return () => {
      // êµ¬ë… ?´ì œ
      for (let i = 1; i <= 6; i++) {
        mqttClient.unsubscribe(`extwork/inverter${i}/overallstate`);
      }
      mqttClient.off('message', handleConnectionStateMessage);
    };
  }, [mqttClient, tankData]);
  
  // ?°ê²° ?íƒœ ?„ì´ì½??Œë”ë§??¨ìˆ˜
  const renderConnectionIcons = (pumpId: number, x: number, y: number) => {
    const connections = pumpConnectionStates[pumpId] || { ble: false, mqtt: false };
    
    // ?ì˜ ê°€?¥ìë¦¬ì— 10?œì? 2??ë°©í–¥?¼ë¡œ ?„ì¹˜ ê³„ì‚°
    const radius = pumpRadius - 2; // ???´ë????´ì§ ?¤ì–´?¤ê²Œ
    
    // WiFi 10??ë°©í–¥, ë¸”ë£¨?¬ìŠ¤ 2??ë°©í–¥
    // Math.PI * 5/6?€ 150?? Math.PI * 1/6?€ 30??    const wifiX = x + radius * Math.cos(Math.PI * 7/6); // 10??ë°©í–¥?¼ë¡œ ?˜ì • (210??
    const wifiY = y + radius * Math.sin(Math.PI * 7/6);
    const bleX = x + radius * Math.cos(Math.PI * 11/6); // 2??ë°©í–¥?¼ë¡œ ?˜ì • (330??
    const bleY = y + radius * Math.sin(Math.PI * 11/6);

  return (
      <g className="connection-icons">
        {/* WiFi/MQTT ?„ì´ì½?- 10??ë°©í–¥ */}
        <g transform={`translate(${wifiX}, ${wifiY})`} opacity={connections.mqtt ? 1 : 0.6}>
          <circle cx="0" cy="0" r="5" fill={connections.mqtt ? "#0ea5e9" : "#d1d5db"} stroke={connections.mqtt ? "#0284c7" : "#9ca3af"} strokeWidth="0.5" />
          <path 
            d="M-2.5,1.5 C-2.5,0.25 -1.25,-0.75 0,-0.75 C1.25,-0.75 2.5,0.25 2.5,1.5" 
            fill="none" 
            stroke={connections.mqtt ? "#ffffff" : "#9ca3af"}
            strokeWidth="0.5"
          />
          <path 
            d="M-1.25,1.5 C-1.25,0.75 -0.5,0.25 0,0.25 C0.5,0.25 1.25,0.75 1.25,1.5" 
            fill="none" 
            stroke={connections.mqtt ? "#ffffff" : "#9ca3af"}
            strokeWidth="0.5"
          />
          <circle cx="0" cy="1.5" r="0.5" fill={connections.mqtt ? "#ffffff" : "#9ca3af"} />
        </g>
        
        {/* ë¸”ë£¨?¬ìŠ¤ ?„ì´ì½?- 2??ë°©í–¥ - ?‰ìƒ???¸ë??‰ìœ¼ë¡?ë³€ê²?*/}
        <g transform={`translate(${bleX}, ${bleY})`} opacity={connections.ble ? 1 : 0.6}>
          <circle cx="0" cy="0" r="5" fill={connections.ble ? "#FFCC00" : "#d1d5db"} stroke={connections.ble ? "#f59e0b" : "#9ca3af"} strokeWidth="0.5" />
          <path 
            d="M0,-1.5 L0,1.5 L1.5,0 L0,-1.5 L1.5,-3 L0,-1.5 L-1.5,-3 L0,-1.5 L-1.5,0 L0,1.5 L1.5,3 L0,1.5 L-1.5,3 L0,1.5" 
            fill="none" 
            stroke={connections.ble ? "#ffffff" : "#9ca3af"}
            strokeWidth="0.5"
          />
        </g>
      </g>
    );
  };

  // ?ë™??ê³µì • ì§„í–‰ ?•ë³´ ?íƒœ
  const [automationProgress, setAutomationProgress] = useState<string | null>(null);
  const [currentSequenceInfo, setCurrentSequenceInfo] = useState<string | null>(null);
  const [nextSequenceInfo, setNextSequenceInfo] = useState<string | null>(null);
  const [sequenceStatsInfo, setSequenceStatsInfo] = useState<string | null>(null);

  // MQTT êµ¬ë… ë°?ë©”ì‹œì§€ ì²˜ë¦¬ - ?ë™??ê³µì • ì§„í–‰ ?•ë³´ ì¶”ê?
  useEffect(() => {
    if (!mqttClient) return;
    
    const subscribeTankTopics = () => {
      // ê¸°ì¡´ êµ¬ë…
      mqttClient.subscribe('extwork/+/state');
      mqttClient.subscribe('extwork/+/temp');
      mqttClient.subscribe('extwork/+/alert');
      mqttClient.subscribe('extwork/+/temp');
      mqttClient.subscribe('extwork/+/message');
      
      // ?ë™??ê³µì • ê´€??? í”½ êµ¬ë…
      mqttClient.subscribe(AUTOMATION_STATUS_TOPIC); 
      mqttClient.subscribe(PROCESS_PROGRESS_TOPIC);
      
      console.log('MQTT ? í”½ êµ¬ë… ?„ë£Œ');
    };
    
    // ?°ê²° ??? í”½ êµ¬ë…
    if (mqttClient.connected) {
      subscribeTankTopics();
    } else {
      mqttClient.on('connect', subscribeTankTopics);
    }
    
    // ë©”ì‹œì§€ ì²˜ë¦¬ ?¸ë“¤??    const handleMessage = (topic: string, message: Buffer) => {
      try {
        const messageStr = message.toString();
        
        // ê¸°ì¡´ ? í”½ ì²˜ë¦¬ ë¡œì§...
        
        // ?ë™??ê³µì • ?íƒœ ? í”½ ì²˜ë¦¬
        if (topic === AUTOMATION_STATUS_TOPIC) {
          try {
            const automationStatus = JSON.parse(messageStr);
            if (automationStatus.status === "sequence_started") {
              setAutomationProgress(`${automationStatus.sequenceName} ?œí€€???œì‘??);
            }
          } catch (error) {
            console.error('?ë™???íƒœ ë©”ì‹œì§€ ?Œì‹± ?¤ë¥˜:', error);
            // JSON ?Œì‹± ?¤íŒ¨ ???ë³¸ ë©”ì‹œì§€ ê·¸ë?ë¡??€??            setAutomationProgress(messageStr);
          }
        }
        
        // ê³µì • ì§„í–‰ ?íƒœ ? í”½ ì²˜ë¦¬
        if (topic === PROCESS_PROGRESS_TOPIC) {
          try {
            // ?ìŠ¤??ë©”ì‹œì§€ ì²˜ë¦¬ (?„ì¬ ?œí€€???•ë³´ ?Œì‹±)
            if (messageStr.includes("?„ì¬ ?œí€€??")) {
              setCurrentSequenceInfo(messageStr.split('\n')[0]?.trim() || null);
            }
            
            // ?¤ìŒ ?œí€€???•ë³´ ?Œì‹±
            if (messageStr.includes("?¤ìŒ ?œí€€??")) {
              const lines = messageStr.split('\n');
              for (const line of lines) {
                if (line.trim().startsWith("?¤ìŒ ?œí€€??")) {
                  setNextSequenceInfo(line.trim());
                  break;
                }
              }
            }
            
            // ?œí€€???µê³„ ?•ë³´ ?Œì‹± (nê°??„ë£Œ / nê°??¤í–‰ì¤?/ nê°??€ê¸°ì¤‘ / nê°??¤ë¥˜)
            if (messageStr.includes("ê°??„ë£Œ") && messageStr.includes("ê°??¤í–‰ì¤?)) {
              const lines = messageStr.split('\n');
              for (const line of lines) {
                if (line.includes("ê°??„ë£Œ") && line.includes("ê°??¤í–‰ì¤?)) {
                  setSequenceStatsInfo(line.trim());
                  break;
                }
              }
            }
            
            // ?„ì²´ ë©”ì‹œì§€ë¥??ë™??ì§„í–‰ ?íƒœ ?œì‹œ???€??            setAutomationProgress(messageStr);
          } catch (error) {
            console.error('ê³µì • ì§„í–‰ ?íƒœ ë©”ì‹œì§€ ?Œì‹± ?¤ë¥˜:', error);
            setAutomationProgress(messageStr); // ?¤ë¥˜ ë°œìƒ ???ë³¸ ë©”ì‹œì§€ ê·¸ë?ë¡??€??          }
        }
        
        // ... ê¸°ì¡´ ? í”½ ì²˜ë¦¬ ë¡œì§ ê³„ì†
        
      } catch (error) {
        console.error('ë©”ì‹œì§€ ì²˜ë¦¬ ?¤ë¥˜:', error);
      }
    };
    
    // ë©”ì‹œì§€ ?´ë²¤??ë¦¬ìŠ¤???±ë¡
    mqttClient.on('message', handleMessage);
    
    // ì»´í¬?ŒíŠ¸ ?¸ë§ˆ?´íŠ¸ ???´ë²¤??ë¦¬ìŠ¤???œê±°
    return () => {
      mqttClient.off('message', handleMessage);
      mqttClient.off('connect', subscribeTankTopics);
    };
  }, [mqttClient, tankData]);

  // ?ë™??ê³µì • ?íƒœ ê´€ë¦?ë¶€ë¶??…ë°?´íŠ¸
  const [automationProcessList, setAutomationProcessList] = useState<any[]>([]);
  const [currentAutomationProcess, setCurrentAutomationProcess] = useState<any>(null);

  // ?ë™??ê³µì • ëª©ë¡ ë°?ì§„í–‰ ?íƒœ ê°€?¸ì˜¤ê¸?  useEffect(() => {
    // ?ë™??ê³µì • ëª©ë¡ ê°€?¸ì˜¤ê¸?    const fetchAutomationProcesses = async () => {
      try {
        const response = await fetch('/api/automation');
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data) {
            setAutomationProcessList(data.data);
            
            // ?¤í–‰ ì¤‘ì¸ ê³µì •???ˆëŠ”ì§€ ?•ì¸
            const runningProcess = data.data.find((p: any) => p.isRunning);
            if (runningProcess) {
              setCurrentAutomationProcess(runningProcess);
              
              // ?ë™??ê³µì • ?íƒœ ?…ë°?´íŠ¸
              const timeStr = formatTimeStr();
              setAutomationStatus(`ê³µì • ì§„í–‰ì¤? ${runningProcess.name} (${timeStr})`);
            }
          }
        }
      } catch (error) {
        console.error('?ë™??ê³µì • ëª©ë¡ ê°€?¸ì˜¤ê¸??¤ë¥˜:', error);
      }
    };
    
    // ì´ˆê¸° ë¡œë“œ ë°?ì£¼ê¸°???…ë°?´íŠ¸
    fetchAutomationProcesses();
    const intervalId = setInterval(fetchAutomationProcesses, 30000); // 30ì´ˆë§ˆ???…ë°?´íŠ¸
    
    return () => clearInterval(intervalId);
  }, []);

  // ?œìŠ¤???íƒœ ?•ë³´ ?ì—­ ?Œë”ë§??¨ìˆ˜ (ì»´í¬?ŒíŠ¸ ?Œë”ë§?ë¶€ë¶?ê·¼ì²˜??ì¶”ê?)
  const renderSystemStatusInfo = () => {
    return (
      <div className="bg-white border border-gray-200 rounded-lg shadow-sm mb-2">
        <div className="bg-indigo-50 py-1 px-2 text-xs font-semibold text-indigo-700 rounded-t-lg border-b border-gray-200">
          ?œìŠ¤???íƒœ ?•ë³´
        </div>
        <div className="p-2 text-xs max-h-[120px] overflow-y-auto">
          {tankData.valveStatusMessage && (
            <div className="bg-yellow-50 p-1 rounded text-[9px] border border-yellow-100 mb-1 overflow-x-auto whitespace-nowrap">
              <span className="font-semibold">ë°¸ë¸Œ ?ì„¸:</span> {tankData.valveStatusMessage}
            </div>
          )}
          
          {/* ?ë™??ê³µì • ?íƒœ ?œì‹œ */}
          {(automationStatus || extractionCompleteMessage || currentAutomationProcess) && (
            <div className={`p-1 rounded text-[9px] border mb-1 overflow-x-auto whitespace-nowrap ${
              extractionCompleteMessage ? 'bg-green-50 border-green-100' : 'bg-blue-50 border-blue-100'
            }`}>
              <span className="font-semibold">?ë™??ê³µì •:</span> {
                currentAutomationProcess ? 
                `${currentAutomationProcess.name} (${currentAutomationProcess.isRunning ? '?¤í–‰ì¤? : '?€ê¸°ì¤‘'})` : 
                (extractionCompleteMessage || automationStatus)
              }
            </div>
          )}
          
          {/* ?ë™???‘ì—… ëª©ë¡ ?œì‹œ */}
          {automationProcessList.length > 0 && (
            <div className="bg-blue-50 p-1 rounded text-[9px] border border-blue-100 mb-1 overflow-x-auto">
              <span className="font-semibold">?‘ì—… ëª©ë¡:</span> {
                automationProcessList.slice(0, 3).map((process, index) => (
                  <span key={process.id} className={`${process.isRunning ? 'text-green-700 font-semibold' : ''}`}>
                    {process.name}{index < Math.min(automationProcessList.length, 3) - 1 ? ', ' : ''}
                  </span>
                ))
              }
              {automationProcessList.length > 3 ? ` ??${automationProcessList.length - 3}ê°? : ''}
            </div>
          )}
          
          {/* ?€ê¸°ì‹œê°??œì‹œ */}
          {automationWaitTime && (
            <div className="bg-indigo-50 p-1 rounded text-[9px] border border-indigo-100 overflow-x-auto whitespace-nowrap">
              <span className="font-semibold">?¤ìŒ ?‘ì—… ?€ê¸?ì¤?</span> {automationWaitTime.value}ì´??¨ìŒ
            </div>
          )}
        </div>
      </div>
    );
  }

  // ?±í¬ë³?ì¤‘ìš” ë©”ì‹œì§€ ?¨í„´ ?•ì˜
  const getTankImportantMessagePattern = (tankId: number): RegExp => {
    if (tankId === 1) {
      // 1ë²??±í¬??ì¤‘ìš” ë©”ì‹œì§€ ?¨í„´
      return /(?˜ìœ„:5%?´ìƒ|?˜ìœ„ë¶€ì¡?5%ë¯¸ë§Œ|ê°€?ì±„?Œì§|ì±„ì?ê°€??/;
    } else {
      // 2~6ë²??±í¬??ì¤‘ìš” ë©”ì‹œì§€ ?¨í„´
      return /(?˜ìœ„ë¶€ì¡??˜ìœ„?•ìƒ|ê°€?ì±„?Œì§|?•ìƒ?˜ìœ„)/;
    }
  };

  // ê°??±í¬ ?Œë”ë§?- ë¬?ì±„ì? ? ë‹ˆë©”ì´?˜ì„ ?¬í•¨???±í¬ë¥?ê·¸ë¦½?ˆë‹¤
  const renderTank = (tankId: number, x: number, y: number, label: string) => {
    const tankData1 = tankData?.tanks?.find(t => t.id === tankId);
    const status = tankData1?.status || "empty";
    const level = tankData1?.level || 0;
    const isPumpOn = tankData1?.pumpStatus === "ON";
    
    // ?±í¬ ë©”ì‹œì§€ ê°€?¸ì˜¤ê¸?- ëª¨ë“  ë©”ì‹œì§€ (?ìŠ¤??ë°•ìŠ¤??
    const tankMessage = tankData?.tankMessages?.[tankId];
    
    // ?€???ˆì „?˜ê²Œ operationTime ?‘ê·¼
    const operationTime = tankData1 ? (tankData1 as any).operationTime : undefined;
    
    // ?Œí”„ ?íƒœ ?•ì¸ ë°?ì±„ì›Œì§?ë¹„ìœ¨ ê³„ì‚° (ì§ì ‘ ê³„ì‚°)
    let fillPercent = 0;
    // ?¨ì? ë°˜ë³µ ?Ÿìˆ˜ ì¶”ì  (?? 1???¨ìŒ)
    let remainingRepeats = "";
    
    // 1. ?Œí”„ê°€ ì¼œì ¸ ?ˆëŠ” ê²½ìš°?ë§Œ ì±„ì? ? ë‹ˆë©”ì´???œì‹œ
    if (isPumpOn) {
      // 2. ?Œí”„ ì§„í–‰ ?•ë³´ ê°€?¸ì˜¤ê¸?      const pumpProgress = pumpProgressInfo[tankId];
      
      // 3. ì§„í–‰ ?•ë³´ê°€ ?ˆìœ¼ë©?ì±„ì? ë¹„ìœ¨ ê³„ì‚°
      if (pumpProgress) {
        console.log(`[renderTank] ?±í¬ ${tankId} ì§„í–‰ ?•ë³´:`, pumpProgress);
        
        // 3.1 ê²½ê³¼ ?œê°„ê³??¨ì? ?œê°„ ?Œì‹±
        let elapsedTime = 0;
        let remainingTime = 0;
        
        // ê²½ê³¼ ?œê°„ ì¶”ì¶œ (?«ì ?ëŠ” ë¬¸ì??s ?•ì‹)
        if (pumpProgress.elapsed_time !== undefined) {
          if (typeof pumpProgress.elapsed_time === 'number') {
            elapsedTime = pumpProgress.elapsed_time;
          } else if (typeof pumpProgress.elapsed_time === 'string') {
            const match = String(pumpProgress.elapsed_time).match(/(\d+)/);
            if (match) {
              elapsedTime = parseInt(match[1], 10);
            }
          }
        }
        
        // ?¨ì? ?œê°„ ì¶”ì¶œ (?«ì ?ëŠ” ë¬¸ì??s ?•ì‹)
        if (pumpProgress.remaining_time !== undefined) {
          if (typeof pumpProgress.remaining_time === 'number') {
            remainingTime = pumpProgress.remaining_time;
          } else if (typeof pumpProgress.remaining_time === 'string') {
            const match = String(pumpProgress.remaining_time).match(/(\d+)/);
            if (match) {
              remainingTime = parseInt(match[1], 10);
            }
          }
        }
        
        // 3.2 ?„ì²´ ?œê°„ ê³„ì‚° (ê²½ê³¼ ?œê°„ + ?¨ì? ?œê°„)
        const totalTime = elapsedTime + remainingTime;
        
        // 3.3 ì§„í–‰ë¥?ê³„ì‚° - 5%~95% ë²”ìœ„ë¡?ë§¤í•‘
        if (totalTime > 0) {
          // 5%-95% ë²”ìœ„ ?´ì—??? ë‹ˆë©”ì´??(ê²½ê³¼ ?œê°„ ë¹„ìœ¨???°ë¼)
          fillPercent = 5 + (elapsedTime / totalTime) * 90;
          console.log(`[renderTank] ?±í¬ ${tankId} ì±„ì?ë¥? ${fillPercent.toFixed(1)}% (${elapsedTime}s/${totalTime}s)`);
        } else {
          // ?œê°„ ?•ë³´ê°€ ?†ìœ¼ë©?ê¸°ë³¸ê°?          fillPercent = isPumpOn ? 10 : 0;
        }
        
        // 3.4 ?¨ì? ë°˜ë³µ ?Ÿìˆ˜ ê³„ì‚° (pump_id ?Œì‹±)
        if (pumpProgress.pump_id && typeof pumpProgress.pump_id === 'string') {
          const pumpMatch = pumpProgress.pump_id.match(/(\d+)\((\d+)\/(\d+)\)/);
          if (pumpMatch) {
            const currentRepeat = parseInt(pumpMatch[2], 10);
            const totalRepeat = parseInt(pumpMatch[3], 10);
            const repeatsLeft = totalRepeat - currentRepeat;
            
            if (repeatsLeft > 0) {
              remainingRepeats = `${repeatsLeft}???¨ìŒ`;
            } else {
              remainingRepeats = "?„ë£Œ";
            }
            
            console.log(`[renderTank] ?±í¬ ${tankId} ?¨ì? ë°˜ë³µ: ${remainingRepeats}`);
          }
        } else if (pumpProgress.total_repeats !== undefined && pumpProgress.current_repeat !== undefined) {
          // ì§„í–‰ ?•ë³´?ì„œ ì§ì ‘ ë°˜ë³µ ?Ÿìˆ˜ ?•ì¸
          const repeatsLeft = pumpProgress.total_repeats - pumpProgress.current_repeat;
          if (repeatsLeft > 0) {
            remainingRepeats = `${repeatsLeft}???¨ìŒ`;
          } else {
            remainingRepeats = "?„ë£Œ";
          }
        }
      } else {
        // ì§„í–‰ ?•ë³´ê°€ ?†ìœ¼ë©?ê¸°ë³¸ê°?(ë¡œì»¬ ?¤í† ë¦¬ì??ì„œ ê°€?¸ì˜¤ê¸??œë„)
        const savedFillPercent = localStorage.getItem(`pump_${tankId}_fill_percent`);
        
        if (savedFillPercent) {
          fillPercent = parseFloat(savedFillPercent);
        } else if (tankId === 4) {
          // 4ë²??±í¬ê°€ 10%?ì„œ ë©ˆì¶°?ˆëŠ” ë¬¸ì œ ?´ê²° - ì§„í–‰ë¥ ì´ ?†ëŠ” ê²½ìš° ê³„ì‚°
          fillPercent = 44; // ì§„í–‰ ?íƒœ???œì‹œ??ê°’ê³¼ ?™ì¼?˜ê²Œ ?¤ì •
        } else {
          // ?¤ë¥¸ ?Œí”„??ê¸°ë³¸ê°?10% ?¤ì •
          fillPercent = 10;
        }
      }
      
      // ìµœì†Œ 5%, ìµœë? 95%ë¡??œí•œ (? ë‹ˆë©”ì´??ë²”ìœ„)
      fillPercent = Math.max(5, Math.min(fillPercent, 95));
    }
    
    // ?¤ì œ ì±„ì? ?¤í???ê°ì²´ ?ì„±
    const fillingStyle = isPumpOn ? {
      clipPath: `inset(${100 - fillPercent}% 0 0 0)`,
      transition: 'clip-path 1s linear',
      backgroundColor: 'rgba(59, 130, 246, 0.3)'
    } : {};
    
    // ì±„ì? ?¤í????”ë²„ê¹?ë¡œê·¸
    if (isPumpOn) {
      console.log(`[renderTank] ?±í¬ ${tankId} ì±„ì? ?¤í???`, fillingStyle);
    }
    
    // ì±„ì? ?¤í??¼ì´ ?ˆëŠ”ì§€ ?•ì¸ (empty objectê°€ ?„ë‹Œì§€)
    const hasFilling = fillingStyle && Object.keys(fillingStyle).length > 0;
    
    // ì¤‘ìš” ë©”ì‹œì§€ë§??•í™•???ë³„?˜ëŠ” ?¨ìˆ˜
    const isImportantStatusMessage = (msg: string | undefined, tankId: number): boolean => {
      if (!msg) return false;
      
      // 1ë²??±í¬?€ ?˜ë¨¸ì§€ ?±í¬ë¥?êµ¬ë¶„
      if (tankId === 1) {
        return (
          msg.includes("?˜ìœ„:5%?´ìƒ") || 
          msg.includes("?˜ìœ„ë¶€ì¡?5%ë¯¸ë§Œ") || 
          msg.includes("ê°€?ì±„?Œì§") ||
          msg.includes("ì±„ì?ê°€??)
        );
      } else {
        return (
          msg.includes("?˜ìœ„ë¶€ì¡?) || 
          msg.includes("?˜ìœ„?•ìƒ") || 
          msg.includes("ê°€?ì±„?Œì§") || 
          msg.includes("?•ìƒ?˜ìœ„")
        );
      }
    };
    
    // ì¤‘ìš” ë©”ì‹œì§€ ?¨í„´ ê°€?¸ì˜¤ê¸??¨ìˆ˜
    const getTankImportantMessagePattern = (tankId: number) => {
      // 1ë²??±í¬??ì¤‘ìš” ë©”ì‹œì§€ ?¨í„´
      if (tankId === 1) {
        return /(?˜ìœ„:\d+%?´ìƒ|?˜ìœ„ë¶€ì¡?\d+%ë¯¸ë§Œ|ê°€?ì±„?Œì§|ì±„ì?ê°€??/;
      }
      
      // 2~6ë²??±í¬??ì¤‘ìš” ë©”ì‹œì§€ ?¨í„´
      return /(?˜ìœ„ë¶€ì¡??˜ìœ„?•ìƒ|ê°€?ì±„?Œì§|?•ìƒ?˜ìœ„)/;
    };
    
    // ?±í¬ ?´ë????œì‹œ???íƒœ ?ìŠ¤??ê²°ì •
    const getStatusText = () => {
      // ?±í¬ ë©”ì‹œì§€ê°€ ?ˆê³ , ì¤‘ìš” ?íƒœ ë©”ì‹œì§€??ê²½ìš°ë§??±í¬ ?´ë????œì‹œ
      if (tankMessage && isImportantStatusMessage(tankMessage, tankId)) {
        // ì¤‘ìš” ë©”ì‹œì§€?ì„œ ?œê°„ ?•ë³´ ?œê±°?˜ê³  ?œì‹œ
        const pattern = getTankImportantMessagePattern(tankId);
        const baseMsgMatch = tankMessage.match(pattern);
        return baseMsgMatch ? baseMsgMatch[0] : tankMessage;
      }
      
      // localStorage???€?¥ëœ ì¤‘ìš” ë©”ì‹œì§€ê°€ ?ˆëŠ”ì§€ ?•ì¸
      const storedImportantMessage = localStorage.getItem(`tank_${tankId}_important_message`);
      if (storedImportantMessage && isImportantStatusMessage(storedImportantMessage, tankId)) {
        // ?€?¥ëœ ì¤‘ìš” ë©”ì‹œì§€?ì„œ ?œê°„ ?•ë³´ ?œê±°?˜ê³  ?œì‹œ
        const pattern = getTankImportantMessagePattern(tankId);
        const baseMsgMatch = storedImportantMessage.match(pattern);
        return baseMsgMatch ? baseMsgMatch[0] : storedImportantMessage;
      }
      
      // ì¤‘ìš” ë©”ì‹œì§€ê°€ ?†ìœ¼ë©?ê¸°ë³¸ ?íƒœ ë©”ì‹œì§€ ë°˜í™˜
      const tankStatus = tankData1?.status || "empty";
      const tankLevel = tankData1?.level || 0;
      return getStatusMessage(tankStatus, tankLevel);
    };
    
    return (
      <g key={`tank-${tankId}`} id={`tank-${tankId}`}>
        {/* ?±í¬ ë³¸ì²´ */}
        <rect
          x={x - tankWidth / 2}
          y={y - tankHeight / 2}
          width={tankWidth}
          height={tankHeight}
          rx="5"
          className={getTankColor(status, tankId)}
        />
        
        {/* ì±„ì›Œì§€??? ë‹ˆë©”ì´?˜ì„ ?„í•œ ?¤ë²„?ˆì´ - ?Œí”„ê°€ ì¼œì ¸ ?ˆì„ ?Œë§Œ ?ìš© */}
        {isPumpOn && (
          <rect
            x={x - tankWidth / 2}
            y={y - tankHeight / 2}
            width={tankWidth}
            height={tankHeight}
            rx="5"
            className="fill-blue-500/30"
            style={fillingStyle}
          />
        )}
        
        {/* ?±í¬ ?¼ë²¨ - ê¸€???¬ê¸° 15% ?¤ì? */}
        <text x={x} y={y} textAnchor="middle" className="text-[1.15rem] font-bold fill-black">
          {label}
        </text>
        
        {/* ?íƒœ ë©”ì‹œì§€ - ì¤‘ìš” ?íƒœ ë©”ì‹œì§€ë§??œì‹œ */}
        <text x={x} y={y + 25} textAnchor="middle" className="text-[12.1px] fill-gray-700">
          {getStatusText()}
        </text>
        
        {/* ?Œí”„ ?íƒœê°€ ON?????¨ì? ë°˜ë³µ ?Ÿìˆ˜ë§??œì‹œ (?¼ì„¼???œê±°) */}
        {isPumpOn && remainingRepeats && (
          <text x={x} y={y + 45} textAnchor="middle" className="text-[12px] fill-blue-700 font-bold">
            {remainingRepeats}
          </text>
        )}
      </g>
    );
  };

  // ë©”ì¸ ?±í¬ ?ˆë²¨ ë©”ì‹œì§€ ì²˜ë¦¬ ?¨ìˆ˜ ê°œì„ 
  const handleMainTankLevelMessage = (messageStr: string) => {
    console.log(`ë³??±í¬ ?ˆë²¨ ë©”ì‹œì§€ ?˜ì‹ : ${messageStr}`);
    
    // ??ƒ ë©”ì‹œì§€ë¥?ë°”ë¡œ ?€??- ?”ë©´???œì‹œ??ë©”ì‹œì§€ ?…ë°?´íŠ¸
    setMainTankMessage(messageStr);
    console.log(`ë³??±í¬ ë©”ì‹œì§€ ?¤ì •?? ${messageStr}`);
    
    // ë©”ì‹œì§€???°ë¼ ?ˆë²¨ ?¤ì • (? ë‹ˆë©”ì´?˜ì„ ?„í•œ ?ˆë²¨ ?…ë°?´íŠ¸)
    let newLevel = tankData?.mainTank?.level || 0;
    
    // ?¹ì • ë©”ì‹œì§€???°ë¼ ?ˆë²¨ ?¤ì •
    if (messageStr === "50%?´ìƒ ì±„ì›Œì§?) {
      newLevel = 60; // 60% ì±„ì?
      console.log("ë³??±í¬ ?ˆë²¨: 60%ë¡??¤ì •(50%?´ìƒ ì±„ì›Œì§?");
    } else if (messageStr === "50%?´í•˜ ë¹„ì›Œì§?) {
      newLevel = 20; // 20% ì±„ì?
      console.log("ë³??±í¬ ?ˆë²¨: 20%ë¡??¤ì •(50%?´í•˜ ë¹„ì›Œì§?");
    }
    
    // ?ˆë²¨ ?…ë°?´íŠ¸ - ë¡œì»¬ ?íƒœë§?ë³€ê²½í•˜ê³??€??    if (tankData && tankData.mainTank) {
      // ?…ë°?´íŠ¸???°ì´??ì¤€ë¹?      const updatedTankData = {
        ...tankData,
        mainTank: {
          ...tankData.mainTank,
          level: newLevel
        }
      };
      
      // ë¡œì»¬ ?¤í† ë¦¬ì????€??      saveState(updatedTankData);
      console.log(`ë³??±í¬ ?ˆë²¨ ?€?¥ë¨: ${newLevel}%`);
    }
  };

  // MQTT ë©”ì‹œì§€ ì²˜ë¦¬ ë¶€ë¶„ì—??ë³??±í¬ ë©”ì‹œì§€ ì²˜ë¦¬ ë¡œì§ ê°œì„ 
  useEffect(() => {
    if (!mqttClient) return;
    
    // ? í”½ êµ¬ë… ?¨ìˆ˜
    const subscribeTankTopics = () => {
      console.log('Tank System MQTT ? í”½ êµ¬ë… ?œì‘');
      
      // 1. ?œì–´ ?¸í„°?˜ì´??? í”½ êµ¬ë…
      mqttClient.subscribe('tank-system/notifications');
      
      // 2. ë³??±í¬ ?˜ìœ„ ? í”½ êµ¬ë…
      mqttClient.subscribe('extwork/tankMain/level');
      console.log('> ë³??±í¬ ?˜ìœ„ ? í”½ êµ¬ë…: extwork/tankMain/level');
      
      // 3. ì¶”ì¶œ ëª…ë ¹ ? í”½ êµ¬ë…
      mqttClient.subscribe('extwork/extraction/input');
      
      // 4. ?¸ë²„???Œí”„ ?íƒœ ? í”½ êµ¬ë…
      for (let i = 1; i <= 6; i++) {
        mqttClient.subscribe(`extwork/inverter${i}/state`);
        console.log(`> ?¸ë²„???Œí”„ ?íƒœ ? í”½ êµ¬ë…: extwork/inverter${i}/state`);
      }
      
      // 5. ?±í¬ ?˜ìœ„ ? í”½ êµ¬ë…
      for (let i = 1; i <= 6; i++) {
        for (let j = 1; j <= 6; j++) {
          mqttClient.subscribe(`extwork/inverter${i}/tank${j}_level`);
          console.log(`> ?±í¬ ?˜ìœ„ ? í”½ êµ¬ë…: extwork/inverter${i}/tank${j}_level`);
        }
      }
      
      console.log('ëª¨ë“  MQTT ? í”½ êµ¬ë… ?„ë£Œ');
    };
    
    // ë©”ì‹œì§€ ì²˜ë¦¬ ?¨ìˆ˜
    const handleMessage = (topic: string, message: Buffer) => {
      try {
        const messageStr = message.toString();
        
        // ë³??±í¬ ?˜ìœ„ ? í”½ ì²˜ë¦¬ - ?¹ë³„???°ì„  ì²˜ë¦¬
        if (topic === 'extwork/tankMain/level') {
          console.log(`ë³??±í¬ ?˜ìœ„ ë©”ì‹œì§€ ?˜ì‹ : ${messageStr}`);
          
          // ë©”ì‹œì§€ ?íƒœ ?…ë°?´íŠ¸ (?”ë©´???œì‹œ??ë©”ì‹œì§€)
          setMainTankMessage(messageStr);
          
          // ë©”ì‹œì§€???°ë¼ ?ˆë²¨ ?¤ì •
          let newLevel = tankData?.mainTank?.level || 0;
          
          if (messageStr === "50%?´ìƒ ì±„ì›Œì§?) {
            newLevel = 60; // 60% ì±„ì?
            console.log("ë³??±í¬ ?ˆë²¨: 60%ë¡??¤ì •??);
          } else if (messageStr === "50%?´í•˜ ë¹„ì›Œì§?) {
            newLevel = 20; // 20% ì±„ì?
            console.log("ë³??±í¬ ?ˆë²¨: 20%ë¡??¤ì •??);
          }
          
          // ?íƒœ ?€??          if (tankData && tankData.mainTank) {
            // ?„ì¬ ?±í¬ ?°ì´??ë³µì‚¬
            const updatedTankData = {
              ...tankData,
              mainTank: {
                ...tankData.mainTank,
                level: newLevel
              }
            };
            
            // ?íƒœ ?€??- IndexedDB???€??            saveState(updatedTankData);
            console.log(`ë³??±í¬ ?ˆë²¨ ?€?¥ë¨: ${newLevel}%`);
          }
        }
        // ?¤ë¥¸ ? í”½ ì²˜ë¦¬ ê³„ì†...
      } catch (error) {
        console.error('ë©”ì‹œì§€ ì²˜ë¦¬ ?¤ë¥˜:', error);
      }
    };
    
    // ?°ê²° ??? í”½ êµ¬ë…
    mqttClient.on('connect', subscribeTankTopics);
    
    // ë©”ì‹œì§€ ?˜ì‹  ?´ë²¤??ë¦¬ìŠ¤???±ë¡
    mqttClient.on('message', handleMessage);
    
    // ì»´í¬?ŒíŠ¸ ?¸ë§ˆ?´íŠ¸ ???´ë²¤??ë¦¬ìŠ¤???œê±°
    return () => {
      mqttClient.off('message', handleMessage);
      mqttClient.off('connect', subscribeTankTopics);
    };
  }, [mqttClient, tankData, setMainTankMessage]);

  // ?Œí”„ë³?ì§„í–‰ ?íƒœ ì¶”ì ???„í•œ useEffect ì¶”ê?
  useEffect(() => {
    // ?œì„±?”ëœ ?Œí”„ê°€ ?ˆëŠ”ì§€ ?•ì¸
    const activePump = Object.entries(pumpProgressInfo).find(([_, progress]) => 
      progress && (progress.elapsed_time !== undefined || progress.remaining_time !== undefined)
    );
    
    if (activePump) {
      const [pumpId, progress] = activePump;
      
      // ì§„í–‰ë¥?ê³„ì‚°???„í•œ ?°ì´??ì¶”ì¶œ
      let elapsedTime = 0;
      let totalTime = 0;
      
      // elapsed_time ê°?ì¶”ì¶œ
      if (progress.elapsed_time !== undefined) {
        if (typeof progress.elapsed_time === 'number') {
          elapsedTime = progress.elapsed_time;
        } else if (typeof progress.elapsed_time === 'string') {
          const matchElapsed = String(progress.elapsed_time).match(/(\d+)/);
          if (matchElapsed) {
            elapsedTime = parseInt(matchElapsed[1], 10);
          }
        }
      }
      
      // remaining_time ê°?ì¶”ì¶œ
      if (progress.remaining_time !== undefined) {
        if (typeof progress.remaining_time === 'number') {
          totalTime = elapsedTime + progress.remaining_time;
        } else if (typeof progress.remaining_time === 'string') {
          const matchRemaining = String(progress.remaining_time).match(/(\d+)/);
          if (matchRemaining) {
            totalTime = elapsedTime + parseInt(matchRemaining[1], 10);
          }
        }
      }
      
      // ?°ì´?°ê? ? íš¨?˜ë©´ ì§„í–‰ë¥?ê³„ì‚°
      if (totalTime > 0) {
        let fillPercent = Math.min((elapsedTime / totalTime) * 100, 100);
        fillPercent = Math.max(fillPercent, 5); // ìµœì†Œ 5% ë³´ì¥
        
        // fillPercentage ?íƒœ ?…ë°?´íŠ¸ (?ˆì „?˜ê²Œ useEffect ?´ì—??
        setFillPercentage(fillPercent);
        console.log(`[useEffect] ?„ì—­ fillPercentage ?…ë°?´íŠ¸: ${fillPercent.toFixed(1)}%`);
      }
    }
    
    // ?´ë¦°???¨ìˆ˜ - ?„ìš”??ê²½ìš° ?¬ê¸°??ë¡œì§ ì¶”ê?
    return () => {
      // ?„ìš”??ê²½ìš° ?´ë¦°??ë¡œì§
    };
  }, [pumpProgressInfo]); // pumpProgressInfoê°€ ë³€ê²½ë  ?Œë§Œ ?¤í–‰

  return (
    <div className="relative w-full h-[950px] bg-white rounded-lg shadow-sm overflow-hidden border border-gray-100">
      {/* ?„ìŠ¤ ? ë‹ˆë©”ì´???¤í???ì¶”ê? */}
      <style>{pulseCss}</style>
      
      {/* ëª¨ë‹ˆ?°ë§ ?€?´í?ê³??œê°„ ?œì‹œ - ?ŒìŠ¤???‰ìƒ?¼ë¡œ ë³€ê²?*/}
      <div className="bg-blue-200 text-gray-700 px-4 py-1.5 flex justify-between items-center">
        <h2 className="text-sm font-semibold">ëª¨ë‹ˆ?°ë§: {formatTimeStr()}</h2>
        {/* ?¤ë¥¸ìª??íƒœ ?ì—­: ?ëŸ¬ ë©”ì‹œì§€?€ ?„ë£Œ ë©”ì‹œì§€ */}
        <div className="flex items-center space-x-2 text-xs">
          {/* ?ëŸ¬ ë©”ì‹œì§€ê°€ ?ˆìœ¼ë©?ë¹¨ê°„???Œë¦¼?¼ë¡œ ?œì‹œ */}
          {errorMessage && (
            <span className="bg-red-100 px-2 py-0.5 rounded text-red-700 animate-pulse">
              {errorMessage}
            </span>
          )}
          {/* ì¶”ì¶œ ?„ë£Œ ë©”ì‹œì§€ ?œì‹œ */}
          {extractionCompleteMessage && (
            <span className="bg-green-100 px-2 py-0.5 rounded text-green-700">
              {extractionCompleteMessage}
            </span>
          )}
          {/* ê³µì • ì§„í–‰ ì¤??œì‹œ */}
          {processRunning && (
            <span className="bg-indigo-100 px-2 py-0.5 rounded text-indigo-700 flex items-center">
              <span className="h-2 w-2 bg-indigo-500 rounded-full mr-1 animate-pulse"></span>
              ê³µì • ì§„í–‰ ì¤?            </span>
          )}
        </div>
      </div>
      
      {/* ?íƒœ ë³€ê²??Œë¦¼ UI???œê±°?˜ê³  ?„ë˜???¤ì‹œ ì¶”ê? */}
      
      {/* ëª¨ë‹ˆ?°ë§ ì»¨í…ì¸?ì»¨í…Œ?´ë„ˆ */}
      <div className="flex h-[calc(100%-32px)]">
        {/* ë©”ì¸ ëª¨ë‹ˆ?°ë§ ?ì—­ - ë¹„ìœ¨??60%?ì„œ 55%ë¡?ì¡°ì • */}
        <div className="w-[55%] border-r border-gray-200 p-0 pl-1 pr-1">
          {/* SVG ì»¨í…Œ?´ë„ˆ - ë°•ìŠ¤ë¡?ê°ì‹¸ê¸?*/}
          <div className="bg-white border border-gray-200 rounded-lg shadow-sm p-0 mb-0 h-[850px] flex flex-col">
            <div className="bg-gray-100 py-2 px-3 text-sm font-semibold text-gray-700 rounded-t-lg border-b border-gray-200">
              ?±í¬ ?œìŠ¤??ëª¨ë‹ˆ?°ë§
            </div>
            
            <div className="flex justify-start items-start flex-grow pl-0">
              <svg 
                viewBox="0 0 800 680" 
                className="w-[100%] h-[800px] ml-0 mr-auto"
                style={{ 
                  backgroundColor: 'white',
                  overflow: 'visible'
                }}
              >
                {/* ?„ì²´ ì»¨í…ì¸ ë? ?±í¬ ?œìŠ¤??ëª¨ë‹ˆ?°ë§ ?ì ?ˆìœ¼ë¡??´ë™ - ?¬ê¸° ì¶”ê? ì¦ê? ë°??„ì¹˜ ì¡°ì • */}
                <g transform="translate(-260, -140) scale(1.33)">
          {/* ë³¸íƒ±??- ?ˆë¹„ ?•ë?, ?’ì´ ê°ì†Œ */}
          <rect
            x={mainTankPosition.x - mainTankPosition.width / 2}
            y={mainTankPosition.y - mainTankPosition.height / 2}
            width={mainTankPosition.width}
            height={mainTankPosition.height}
            rx="10"
            className={`${valve1 === 0 && isPipeActive(5) ? "fill-white stroke-yellow-400 stroke-[3]" : getTankColor(tankData?.mainTank?.status, 0)}`}
          />
          
          {/* ì±„ì›Œì§€??? ë‹ˆë©”ì´?˜ì„ ?„í•œ ?¤ë²„?ˆì´ - ?Œí”„ê°€ ON?´ê±°??filling ?íƒœ?????ìš© */}
          {(tankData?.mainTank?.status === "filling" || valve2 === 1) && (
            <rect
              x={mainTankPosition.x - mainTankPosition.width / 2}
              y={mainTankPosition.y - mainTankPosition.height / 2}
              width={mainTankPosition.width}
              height={mainTankPosition.height}
              rx="10"
              className="fill-amber-200/30"
              style={getFillingStyle(tankData?.mainTank?.status || 'empty', 0)}
            />
          )}
          <text x={mainTankPosition.x} y={mainTankPosition.y} textAnchor="middle" className="text-xl font-bold fill-black">
            {mainTankPosition.label}
          </text>
          
          {/* ë³¸íƒ±???íƒœ ë©”ì‹œì§€ ?ìŠ¤??*/}
          <text 
            x={mainTankPosition.x} 
            y={mainTankPosition.y + 30} 
            textAnchor="middle" 
            className="text-[14px] font-semibold fill-blue-700"
          >
            {mainTankMessage || getStatusMessage(tankData?.mainTank?.status, tankData?.mainTank?.level, 0)}
          </text>

          {/* ?±í¬ ?°ê²° ?Œì´??- ì§ì„ ?¼ë¡œ ?°ê²° (2-3, 3-4, 4-5, 5-6ë²??±í¬ë§? */}
          {Array(4)
            .fill(0)
            .map((_, i) => {
              const currentIndex = i + 1 // 2, 3, 4, 5ë²??±í¬ë¶€???œì‘
              const nextIndex = (currentIndex + 1) % 6 // 3, 4, 5, 6ë²??±í¬
              const pumpIndex = i + 2 // ?Œí”„ ?¸ë±??(3, 4, 5, 6ë²??Œí”„??ê°ê° 2, 3, 4, 5ë²??¸ë±??
              
              // ?ˆì „ ê²€?¬ë? ì¶”ê??˜ì—¬ tankData.tanks[pumpIndex]ê°€ ì¡´ì¬?˜ëŠ”ì§€ ?•ì¸
              const pipeColor = tankData?.tanks && 
                                tankData?.tanks[pumpIndex] && 
                                tankData?.tanks[pumpIndex].pumpStatus === "ON" ? 
                                "stroke-blue-500" : "stroke-gray-300";
              
              return (
                <path
                  key={`pipe-${currentIndex}-${nextIndex}`}
                  d={calculatePipePath(currentIndex, nextIndex)}
                  className={`${pipeColor} stroke-[12]`}
                  fill="none"
                  strokeLinecap="round"
                />
              )
            })}

          {/* 1ë²??±í¬?ì„œ 2ë²??Œí”„ë¡œì˜ ê²½ë¡œ */}
          <path
            d={calculate1ToPump2Path()}
            className={`stroke-[12] ${
              tankData?.tanks && 
              tankData?.tanks[1] && 
              tankData?.tanks[1].pumpStatus === "ON" ? 
              "stroke-blue-500" : "stroke-gray-300"
            }`}
            fill="none"
            strokeLinecap="round"
          />

          {/* 2ë²??Œí”„?ì„œ 2ë²??±í¬ë¡œì˜ ê²½ë¡œ */}
          <path
            d={calculatePump2To2Path()}
            className={`stroke-[12] ${
              tankData?.tanks && 
              tankData?.tanks[1] && 
              tankData?.tanks[1].pumpStatus === "ON" ? 
              "stroke-blue-500" : "stroke-gray-300"
            }`}
            fill="none"
            strokeLinecap="round"
          />

          {/* 6ë²??±í¬?ì„œ 3way ë°¸ë¸Œ(ë°¸ë¸Œ2)ë¡œì˜ ê²½ë¡œ */}
          <path
            d={calculate6ToValvePath()}
            className={`stroke-[12] ${
              (tankData?.tanks && 
              tankData?.tanks[5] && 
              tankData?.tanks[5].pumpStatus === "ON") || 
              (valve1 === 1 && isPipeActive(0)) ? 
              "stroke-blue-500" : "stroke-gray-300"
            }`}
            fill="none"
            strokeLinecap="round"
          />

          {/* 3way ë°¸ë¸Œ(ë°¸ë¸Œ2)?ì„œ ë³¸íƒ±?¬ë¡œ??ê²½ë¡œ - ?„ì²´?œí™˜???Œë§Œ ?œì‹œ */}
          {valve1 === 0 && (
            <path
              d={calculate3wayToMainPath()}
              className={`stroke-[12] ${isPipeActive(5) ? "stroke-blue-500" : "stroke-gray-300"}`}
              fill="none"
              strokeLinecap="round"
            />
          )}

          {/* ë³¸íƒ±?¬ì—??2way ë°¸ë¸Œ(ë°¸ë¸Œ1)ë¡œì˜ ê²½ë¡œ - ??ƒ ?œì‹œ */}
          <path
            d={calculateMainToTank1Path()}
            className={`stroke-[12] ${valve2 === 1 || (valve1 === 1 && isPipeActive(0)) ? "stroke-blue-500" : "stroke-gray-300"}`}
            fill="none"
            strokeLinecap="round"
          />

          {/* 2way ë°¸ë¸Œ(ë°¸ë¸Œ1)?ì„œ ?Œí”„1 ?…êµ¬ ìª½ìœ¼ë¡œì˜ ê²½ë¡œ - ??ƒ ?œì‹œ */}
          <path
            d={calculate2wayToPump1Path()}
            className={`stroke-[12] ${(valve2 === 1 && isPipeActive(0)) ? "stroke-blue-500" : "stroke-gray-300"}`}
            fill="none"
            strokeLinecap="round"
          />

          {/* 3way ë°¸ë¸Œ(ë°¸ë¸Œ2)?ì„œ ?Œí”„ 1ë¡œì˜ ê²½ë¡œ - ì¶”ì¶œ?œí™˜???Œë§Œ ?œì‹œ */}
          {valve1 === 1 && (
            <path
              d={calculate3wayToPump1Path()}
              className={`stroke-[12] ${isPipeActive(5) || isPipeActive(0) ? "stroke-blue-500" : "stroke-gray-300"}`}
              fill="none"
              strokeLinecap="round"
            />
          )}

          {/* ?©ë¥˜ ì§€?ì—???Œí”„1ë¡œì˜ ê²½ë¡œ */}
          <path
            d={calculateMergeToPump1Path()}
            className={`stroke-[12] ${((valve1 === 1 && (isPipeActive(5) || isPipeActive(0))) || (valve2 === 1 && isPipeActive(0))) ? "stroke-blue-500" : "stroke-gray-300"}`}
            fill="none"
            strokeLinecap="round"
          />

          {/* 1ë²??Œí”„?ì„œ 1ë²??±í¬ë¡œì˜ ê²½ë¡œ */}
          <path
            d={calculatePump1To1Path()}
            className={`stroke-[12] ${isPipeActive(0) ? "stroke-blue-500" : "stroke-gray-300"}`}
            fill="none"
            strokeLinecap="round"
          />

          {/* ?Œí”„ (1ë²? */}
          {(() => {
            const pumpPos = calculatePumpPosition(5, 0);
            const tank = tankData?.tanks?.[0]; // 1ë²??Œí”„ = 0ë²??¸ë±??            const stateMessage = pumpStateMessages[1] || '';
            const switchPosition = pumpSwitchPosition[1] || 0;
            
            return (
              <g key="pump-1" id="pump-1">
                <circle
                  cx={pumpPos.x}
                  cy={pumpPos.y}
                  r={pumpRadius}
                  className="stroke-gray-400 stroke-2"
                  fill={tank && tank.pumpStatus === "ON" ? "#93c5fd" : "#e5e7eb"}
                />
                <text x={pumpPos.x} y={pumpPos.y + 10} textAnchor="middle" className="text-sm font-bold">
                  invP-1
                </text>
                
                {/* ?°ê²° ?íƒœ ?„ì´ì½?ì¶”ê? */}
                {renderConnectionIcons(1, pumpPos.x, pumpPos.y)}
                
                {/* ?Œí”„ ?¤ìœ„ì¹??œì‹œ - ?œê·¸ ?œê±°, ON/OFFë§??œì‹œ */}
                <g className="transition-transform duration-300" style={{ transform: `translateY(${switchPosition * 20}px)` }}>
                  {tank && tank.pumpStatus === "ON" && (
                    <rect 
                      x={pumpPos.x - 20} 
                      y={pumpPos.y - 30} 
                      width={40} 
                      height={15} 
                      rx={5}
                      className="fill-green-500 stroke-gray-700 stroke-1"
                    />
                  )}
                  <text x={pumpPos.x} y={pumpPos.y - 20} textAnchor="middle" className={`text-[12px] font-bold ${tank && tank.pumpStatus === "ON" ? "text-white" : "text-black"}`}>
                    {switchPosition < 0 ? "ë¦¬ì…‹" : (tank && tank.pumpStatus === "ON" ? "ON" : "OFF")}
                  </text>
                </g>
                
                {/* ë¦¬ì…‹ ?€?´ë¨¸ ?œì‹œ */}
                {resetTimers[1] && (
                  <circle
                    cx={pumpPos.x}
                    cy={pumpPos.y}
                    r={pumpRadius + 8}
                    className="fill-transparent stroke-yellow-400 stroke-2 animate-pulse"
                  />
                )}
                
                {/* ?Œí”„ ë©”ì‹œì§€ ?œê·¸ ?œì‹œ - ?˜í‰?¼ë¡œ ?¤ìœ„ì¹??„ì— ë°°ì¹˜, ???„ë¡œ ?¬ë¦¼ */}
                {pumpStateMessages[1] && (
                  <g transform={`translate(${pumpPos.x - 60}, ${pumpPos.y - 60}) rotate(0)`}>
                    <rect
                      x={0}
                      y={0}
                      width={120}
                      height={20}
                      rx={10}
                      className="fill-amber-100 stroke-amber-300 stroke-1 shadow-sm"
                    />
                    <text
                      x={60}
                      y={13}
                      textAnchor="middle"
                      className="text-[9px] font-medium fill-amber-800"
                    >
                      {pumpStateMessages[1].length > 14 ? pumpStateMessages[1].substring(0, 14) + '...' : pumpStateMessages[1]}
                    </text>
                  </g>
                )}
                
                {currentPressedPump === 1 && (
                  <circle
                    cx={pumpPos.x}
                    cy={pumpPos.y}
                    r={pumpRadius + 5}
                    className="fill-transparent stroke-yellow-400 stroke-2 animate-pulse"
                  />
                )}
              </g>
            );
          })()}

          {/* ?Œí”„ (2ë²? */}
          {(() => {
            const pumpPos = calculatePumpPosition(0, 1);
            const tank = tankData?.tanks?.[1]; // 2ë²??Œí”„ = 1ë²??¸ë±??            const stateMessage = pumpStateMessages[2] || '';
            const switchPosition = pumpSwitchPosition[2] || 0;
            
            return (
              <g key="pump-2" id="pump-2">
                <circle
                  cx={pumpPos.x}
                  cy={pumpPos.y}
                  r={pumpRadius}
                  className="stroke-gray-400 stroke-2"
                  fill={tank && tank.pumpStatus === "ON" ? "#93c5fd" : "#e5e7eb"}
                />
                <text x={pumpPos.x} y={pumpPos.y + 10} textAnchor="middle" className="text-sm font-bold">
                  invP-2
                </text>
                
                {/* ?°ê²° ?íƒœ ?„ì´ì½?ì¶”ê? */}
                {renderConnectionIcons(2, pumpPos.x, pumpPos.y)}
                
                {/* ?Œí”„ ?¤ìœ„ì¹??œì‹œ - ?œê·¸ ?œê±°, ON/OFFë§??œì‹œ */}
                <g className="transition-transform duration-300" style={{ transform: `translateY(${switchPosition * 20}px)` }}>
                  {tank && tank.pumpStatus === "ON" && (
                    <rect 
                      x={pumpPos.x - 20} 
                      y={pumpPos.y - 30} 
                      width={40} 
                      height={15} 
                      rx={5}
                      className="fill-green-500 stroke-gray-700 stroke-1"
                    />
                  )}
                  <text x={pumpPos.x} y={pumpPos.y - 20} textAnchor="middle" className={`text-[12px] font-bold ${tank && tank.pumpStatus === "ON" ? "text-white" : "text-black"}`}>
                    {switchPosition < 0 ? "ë¦¬ì…‹" : (tank && tank.pumpStatus === "ON" ? "ON" : "OFF")}
                  </text>
                </g>
                
                {/* ë¦¬ì…‹ ?€?´ë¨¸ ?œì‹œ */}
                {resetTimers[2] && (
                  <circle
                    cx={pumpPos.x}
                    cy={pumpPos.y}
                    r={pumpRadius + 8}
                    className="fill-transparent stroke-yellow-400 stroke-2 animate-pulse"
                  />
                )}
                
                {/* ?Œí”„ ë©”ì‹œì§€ ?œê·¸ ?œì‹œ - ?˜í‰?¼ë¡œ ?¤ìœ„ì¹??„ì— ë°°ì¹˜, ???„ë¡œ ?¬ë¦¼ */}
                {pumpStateMessages[2] && (
                  <g transform={`translate(${pumpPos.x - 60}, ${pumpPos.y - 60}) rotate(0)`}>
                    <rect
                      x={0}
                      y={0}
                      width={120}
                      height={20}
                      rx={10}
                      className="fill-amber-100 stroke-amber-300 stroke-1 shadow-sm"
                    />
                    <text
                      x={60}
                      y={13}
                      textAnchor="middle"
                      className="text-[9px] font-medium fill-amber-800"
                    >
                      {pumpStateMessages[2].length > 14 ? pumpStateMessages[2].substring(0, 14) + '...' : pumpStateMessages[2]}
                    </text>
                  </g>
                )}
                
                {currentPressedPump === 2 && (
                  <circle
                    cx={pumpPos.x}
                    cy={pumpPos.y}
                    r={pumpRadius + 5}
                    className="fill-transparent stroke-yellow-400 stroke-2 animate-pulse"
                  />
                )}
              </g>
            );
          })()}

          {/* ?Œí”„ (3~6ë²? - ?±í¬ ?¬ì´??ë°°ì¹˜ */}
          {Array(4)
            .fill(0)
            .map((_, index) => {
              const currentTankIndex = index + 1 // 2, 3, 4, 5ë²??±í¬ë¶€???œì‘
              const nextTankIndex = (currentTankIndex + 1) % 6 // 3, 4, 5, 6ë²??±í¬
              const pumpPos = calculatePumpPosition(currentTankIndex, nextTankIndex);
              const pumpNum = index + 3 // 3, 4, 5, 6ë²??Œí”„
              // ?ˆì „?˜ê²Œ ?±í¬ ?°ì´???‘ê·¼
              const tank = tankData?.tanks && tankData?.tanks.length > (pumpNum - 1) ? tankData?.tanks[pumpNum - 1] : null;
              const stateMessage = pumpStateMessages[pumpNum] || '';
              const switchPosition = pumpSwitchPosition[pumpNum] || 0;
              
              return (
                <g key={`pump-${pumpNum}`} id={`pump-${pumpNum}`}>
                  {/* ?¸ë²„???Œí”„ */}
                  <circle
                    cx={pumpPos.x}
                    cy={pumpPos.y}
                    r={pumpRadius}
                    className="stroke-gray-400 stroke-2"
                    fill={tank && tank.pumpStatus === "ON" ? "#93c5fd" : "#e5e7eb"}
                  />
                  <text x={pumpPos.x} y={pumpPos.y + 10} textAnchor="middle" className="text-sm font-bold">
                    invP-{pumpNum}
                  </text>
                  
                  {/* ?°ê²° ?íƒœ ?„ì´ì½?ì¶”ê? */}
                  {renderConnectionIcons(pumpNum, pumpPos.x, pumpPos.y)}
                  
                  {/* ?Œí”„ ?¤ìœ„ì¹??œì‹œ - ?œê·¸ ?œê±°, ON/OFFë§??œì‹œ */}
                  <g className="transition-transform duration-300" style={{ transform: `translateY(${switchPosition * 20}px)` }}>
                    {tank && tank.pumpStatus === "ON" && (
                      <rect 
                        x={pumpPos.x - 20} 
                        y={pumpPos.y - 30} 
                        width={40} 
                        height={15} 
                        rx={5}
                        className="fill-green-500 stroke-gray-700 stroke-1"
                      />
                    )}
                    <text x={pumpPos.x} y={pumpPos.y - 20} textAnchor="middle" className={`text-[12px] font-bold ${tank && tank.pumpStatus === "ON" ? "text-white" : "text-black"}`}>
                      {switchPosition < 0 ? "ë¦¬ì…‹" : (tank && tank.pumpStatus === "ON" ? "ON" : "OFF")}
                    </text>
                  </g>
                  
                  {/* ë¦¬ì…‹ ?€?´ë¨¸ ?œì‹œ */}
                  {resetTimers[pumpNum] && (
                    <circle
                      cx={pumpPos.x}
                      cy={pumpPos.y}
                      r={pumpRadius + 8}
                      className="fill-transparent stroke-yellow-400 stroke-2 animate-pulse"
                    />
                  )}
                  
                  {/* ?Œí”„ ë©”ì‹œì§€ ?œê·¸ ?œì‹œ - ê°??Œí”„??ë¶™ì–´?ˆëŠ” ?€ê°ì„  ?•íƒœ */}
                  {pumpStateMessages[pumpNum] && (
                    <g transform={(() => {
                      // ê°??Œí”„ë§ˆë‹¤ ?¤ë¥¸ ?„ì¹˜?€ ê°ë„ ?¤ì • - ë¹?ê³µê°„??ë°°ì¹˜
                      switch (pumpNum) {
                        case 3: // ?Œí”„ 3ë²?- ?Œí”„ ?„ë˜ìª½ì— ?˜í‰?¼ë¡œ ë°°ì¹˜
                          return `translate(${pumpPos.x - 60}, ${pumpPos.y + 30}) rotate(0)`;
                        case 4: // ?Œí”„ 4ë²?- ?¤ìœ„ì¹??„ì— ?˜í‰?¼ë¡œ ë°°ì¹˜, ???„ë¡œ ?¬ë¦¼
                          return `translate(${pumpPos.x - 60}, ${pumpPos.y - 60}) rotate(0)`;
                        case 5: // ?Œí”„ 5ë²?- ?¤ìœ„ì¹??„ì— ?˜í‰?¼ë¡œ ë°°ì¹˜, ???„ë¡œ ?¬ë¦¼
                          return `translate(${pumpPos.x - 60}, ${pumpPos.y - 60}) rotate(0)`;
                        case 6: // ?Œí”„ 6ë²?- ?Œí”„ ?„ë˜ìª½ì— ?˜í‰?¼ë¡œ ë°°ì¹˜
                          return `translate(${pumpPos.x - 60}, ${pumpPos.y + 30}) rotate(0)`;
                        default:
                          return `translate(${pumpPos.x - 60}, ${pumpPos.y - 60}) rotate(0)`;
                      }
                    })()}>
                      <rect
                        x={0}
                        y={0}
                        width={120}
                        height={20}
                        rx={10}
                        className="fill-amber-100 stroke-amber-300 stroke-1 shadow-sm"
                      />
                      <text
                        x={60}
                        y={13}
                        textAnchor="middle"
                        className="text-[9px] font-medium fill-amber-800"
                      >
                        {pumpStateMessages[pumpNum].length > 14 ? pumpStateMessages[pumpNum].substring(0, 14) + '...' : pumpStateMessages[pumpNum]}
                      </text>
                    </g>
                  )}
                  
                  {currentPressedPump === pumpNum && (
                    <circle
                      cx={pumpPos.x}
                      cy={pumpPos.y}
                      r={pumpRadius + 5}
                      className="fill-transparent stroke-yellow-400 stroke-2 animate-pulse"
                    />
                  )}
                </g>
              );
            })}

          {/* ?±í¬ 1-6 */}
                  {tankPositions.map((position, i) => {
                    const tankId = i + 1;
                    const tankData1 = tankData?.tanks?.[i];
                    // ?´ë‹¹ ?¸ë±?¤ì˜ ?±í¬ ë©”ì‹œì§€ ê°€?¸ì˜¤ê¸?                    const tankMessage = tankMessages[tankId] || (tankData?.tankMessages ? tankData.tankMessages[tankId] : '');
            
            return (
                      <g key={`tank-${tankId}`} id={`tank-${tankId}`}>
                {renderTank(tankId, position.x, position.y, position.label)}
                
                        {/* ?±í¬ ?ìŠ¤??ë°•ìŠ¤ ì¶”ê? - ?‰ë„‰???¬ë°±?¼ë¡œ ì¡°ì • */}
                <g>
                  <rect
                            x={position.x - tankWidth / 2}
                            y={position.y + tankHeight / 2 + 5}
                            width={tankWidth}
                            height={30}
                    rx="3"
                            className={`fill-gray-100 stroke-gray-300 stroke-1 ${tankId === 4 ? 'fill-gray-100' : ''}`}
                  />
                  <foreignObject
                    x={position.x - tankWidth / 2}
                    y={position.y + tankHeight / 2 + 5}
                    width={tankWidth}
                    height={30}
                  >
                    <div 
                      className={`h-full flex items-center justify-center px-2 text-center ${tankMessage ? 'text-blue-700 font-medium' : 'text-gray-700'}`}
                      style={{ fontSize: '8px', lineHeight: '1', paddingTop: '4px' }}
                  >
                            {tankMessage || getStatusMessage(tankData1?.status, tankData1?.level)}
                    </div>
                  </foreignObject>
                </g>
              </g>
            );
          })}

          {/* 3way ë°¸ë¸Œ - ON/OFF ?¤ìœ„ì¹??•íƒœë¡?ê°œì„  - ?¬ê¸° ì¤„ì„ */}
          <g
            onClick={() => handleValveChange(getNextValveState())}
            className="cursor-pointer"
            transform={`translate(${valve3wayPosition.x}, ${valve3wayPosition.y})`}
          >
            {/* ë°¸ë¸Œ ë°°ê²½ - ?¬ê¸° ì¤„ì„ */}
            <rect 
              x="-30" 
              y="-30" 
              width="60" 
              height="50" 
              rx="10" 
              className={`fill-yellow-50 stroke-yellow-400 stroke-2`} 
            />
            
            {/* ë°¸ë¸Œ ?´ë? T???œì‹œ - ?¬ê¸° ì¡°ì • */}
            <line x1="-20" y1="0" x2="20" y2="0" className="stroke-yellow-500 stroke-2" />
            <line x1="0" y1="0" x2="0" y2="15" className="stroke-yellow-500 stroke-2" />
            
            {/* ON/OFF ?¤ìœ„ì¹?- ?„ì¹˜???°ë¼ ?„ì•„?˜ë¡œ ?´ë™ */}
            <rect 
              x="-20" 
              y={valve1 === 1 ? "-20" : "0"} 
              width="40" 
              height="20" 
              rx="10" 
              className={`${valve1 === 1 ? "fill-green-500" : "fill-red-500"} stroke-gray-400 stroke-1 transition-all duration-300`} 
            />
            
            {/* ë°¸ë¸Œ ?ìŠ¤??ë³€ê²?*/}
            <text x="0" y="-20" textAnchor="middle" className="text-sm font-bold">
              ë°¸ë¸Œ2
            </text>
            <text x="0" y={valve1 === 1 ? "-10" : "10"} textAnchor="middle" className="text-[12px] font-bold text-white">
              {valve1 === 1 ? "ì¶”ì¶œ?œí™˜" : "?„ì²´?œí™˜"}
            </text>
          </g>

          {/* 2way ë°¸ë¸Œ ?´ë¦„ê³??œì‹œ ë³€ê²?*/}
          <g transform={`translate(${valve2Position.x}, ${valve2Position.y})`}>
            {/* ë°¸ë¸Œ ë°°ê²½ */}
            <rect 
              x="-30" 
              y="-30" 
              width="60" 
              height="50" 
              rx="10" 
              className={`fill-yellow-50 stroke-yellow-400 stroke-2`} 
            />
            
            {/* ë°¸ë¸Œ ?´ë? ?œì‹œ */}
            <line x1="-20" y1="0" x2="20" y2="0" className="stroke-yellow-500 stroke-2" />
            {valve2 === 1 && <line x1="0" y1="-15" x2="0" y2="15" className="stroke-yellow-500 stroke-2" />}
            
            {/* ON/OFF ?¤ìœ„ì¹?*/}
            <rect 
              x="-20" 
              y={valve2 === 1 ? "-20" : "0"} 
              width="40" 
              height="20" 
              rx="10" 
              className={`${valve2 === 1 ? "fill-green-500" : "fill-red-500"} stroke-gray-400 stroke-1 transition-all duration-300`} 
            />
            
            {/* ë°¸ë¸Œ ?ìŠ¤??ë³€ê²?*/}
            <text x="0" y="-20" textAnchor="middle" className="text-sm font-bold">
              ë°¸ë¸Œ1
            </text>
            <text x="0" y={valve2 === 1 ? "-10" : "10"} textAnchor="middle" className="text-[12px] font-bold text-white">
              {valve2 === 1 ? "ë³¸íƒ±???˜ì§‘" : "OFF"}
            </text>
          </g>

          {/* ?Œí”„ ë¦¬ì…‹ ë²„íŠ¼ ?ì - ì¶”ì¶œ ?œì–´ ?ì ?°ì¸¡??ë°°ì¹˜, ?½ê°„ ?¼ìª½?¼ë¡œ ?´ë™ */}
          {/* ?Œí”„ ë¦¬ì…‹ ë²„íŠ¼?€ ?ë‹¨?¼ë¡œ ?´ë™?ˆìœ¼ë¯€ë¡??œê±° */}
        </g> {/* ?„ì²´ ì»¨í…ì¸??„ë¡œ ?´ë™ translate???«ëŠ” ?œê·¸ */}
      </svg>
            </div>
              </div>
            </div>
            
        {/* ì¶”ê? ?•ë³´ ?¬ì´?œë°” - ë¹„ìœ¨??40%?ì„œ 45%ë¡?ì¡°ì • */}
        <div className="w-[45%] p-2 flex flex-col space-y-2">
          {/* ?„ì¬ ?íƒœ ë°?ì§„í–‰ ?•ë³´ */}
          {renderSystemStatusInfo()}
        
          {/* ì¶”ê? ?•ë³´ ë°•ìŠ¤ 1 - ?±í¬ ?”ì•½ ?•ë³´ë¥?ê³µì • ì§„í–‰ ?”ì•½ ?•ë³´ë¡?ë³€ê²?*/}
          <div className="bg-white border border-gray-200 rounded-lg shadow-sm mb-2">
            <div className="bg-blue-50 py-1 px-2 text-xs font-semibold text-blue-700 rounded-t-lg border-b border-gray-200 flex justify-between items-center">
              <span>ê³µì • ì§„í–‰ ê³„íš ?”ì•½</span>
              {progressMessages.filter(msg => msg.rawJson).length > 0 && (
                <span className="px-1.5 py-0.5 bg-blue-100 text-blue-800 rounded-full text-[9px] font-bold animate-pulse">
                  ?œì„±
                </span>
              )}
            </div>
            <div className="p-2 text-xs">
              {/* ê³µì • ê³„íš ?•ë³´ ?œì‹œ */}
              <div className="space-y-2">
                {/* ê³µì • ê³„íš ?•ë³´ ?œì‹œ */}
                {progressMessages.filter(msg => msg.rawJson).slice(0, 1).map((msg, idx) => {
                  try {
                    const jsonData = msg.rawJson ? JSON.parse(msg.rawJson) : null;
                    
                    // ë³µí•© ëª…ë ¹??ì²˜ë¦¬ (sequences ë°°ì—´???ˆëŠ” ê²½ìš°)
                    if (jsonData?.sequences && Array.isArray(jsonData.sequences)) {
                      return (
                        <div key={`process-plan-${idx}`} className="bg-gray-50 p-2 rounded border border-gray-100">
                          <div className="mb-2 font-semibold text-blue-700 border-b border-blue-100 pb-1">ë³µí•© ê³µì • ê³„íš</div>
                          
                          {jsonData.sequences.map((seq, seqIdx) => (
                            <div key={`seq-${seqIdx}`} className="mb-2 p-1.5 bg-white rounded border border-gray-100">
                  <div className="flex justify-between items-center mb-1">
                                <span className="font-semibold text-blue-700">?œí€€??{seqIdx + 1}:</span>
                                <span className="text-[9px] bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100">
                                  {seq.operation_mode ? `ëª¨ë“œ: ${seq.operation_mode}` : ''}
                                </span>
                  </div>
                              
                              {seq.repeats !== undefined && (
                                <div className="mb-1 flex justify-between items-center">
                                  <span className="font-semibold text-blue-700">ë°˜ë³µ ?Ÿìˆ˜:</span>
                                  <span className="bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100">{seq.repeats}??/span>
                  </div>
                              )}
                              
                              {seq.process && Array.isArray(seq.process) && (
                                <div className="mb-1">
                                  <span className="font-semibold text-blue-700">?„ë¡œ?¸ìŠ¤:</span>
                                  <div className="mt-1 flex flex-wrap gap-1">
                                    {seq.process.map((proc, procIdx) => (
                                      <span key={procIdx} className="bg-green-50 text-green-700 text-[9px] px-1.5 py-0.5 rounded border border-green-100">
                                        {proc}
                                      </span>
                                    ))}
                </div>
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      );
                    }
                    
                    // ?¼ë°˜ ëª…ë ¹??ì²˜ë¦¬
                    return (
                      <div key={`process-info-${idx}`} className="bg-gray-50 p-2 rounded border border-gray-100">
                        {jsonData?.name && (
                          <div className="mb-1 flex justify-between items-center">
                            <span className="font-semibold text-blue-700">ê³µì • ?´ë¦„:</span>{" "}
                            <span className="bg-blue-50 px-2 py-0.5 rounded border border-blue-100">{jsonData.name}</span>
              </div>
                        )}
                        {jsonData?.mode && (
                          <div className="mb-1 flex justify-between items-center">
                            <span className="font-semibold text-blue-700">?´ì˜ ëª¨ë“œ:</span>{" "}
                            <span className={`px-2 py-0.5 rounded border ${
                              jsonData.mode === "sequential" ? "bg-purple-50 border-purple-100 text-purple-700" : 
                              jsonData.mode === "concurrent" ? "bg-green-50 border-green-100 text-green-700" : 
                              jsonData.mode === "mixed" ? "bg-yellow-50 border-yellow-100 text-yellow-700" : 
                              "bg-gray-50 border-gray-100"
                            }`}>
                              {jsonData.mode === "sequential" ? "?œì°¨ ëª¨ë“œ" : 
                                  jsonData.mode === "concurrent" ? "?™ì‹œ ëª¨ë“œ" : 
                              jsonData.mode === "mixed" ? "?¼í•© ëª¨ë“œ" : jsonData.mode}
                            </span>
              </div>
                        )}
                        {jsonData?.repeat !== undefined && (
                          <div className="mb-1 flex justify-between items-center">
                            <span className="font-semibold text-blue-700">ë°˜ë³µ ?Ÿìˆ˜:</span>{" "}
                            <span className="bg-blue-50 px-2 py-0.5 rounded border border-blue-100">{jsonData.repeat}??/span>
                      </div>
                        )}
                        {jsonData?.sequences && (
                          <div className="mb-1">
                            <span className="font-semibold text-blue-700">?œì„±?”ë  ?Œí”„:</span>{" "}
                            <div className="mt-1 flex flex-wrap gap-1">
                              {jsonData.sequences.map((seq: any, i: number) => {
                                const pumpId = seq.pump_id || seq.pumpId;
                                if (!pumpId) return null;
                                return (
                                  <span key={i} className="bg-green-50 text-green-700 text-[9px] px-1.5 py-0.5 rounded border border-green-100">
                                    {pumpId}
                            </span>
                                );
                              }).filter(Boolean)}
                            </div>
                  </div>
                        )}
                        {jsonData?.estimated_completion_time && (
                          <div className="mb-1 flex justify-between items-center">
                            <span className="font-semibold text-blue-700">?ˆìƒ ì¢…ë£Œ:</span>{" "}
                            <span className="bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100 text-indigo-700">{jsonData.estimated_completion_time}</span>
                </div>
                        )}
              </div>
                    );
                  } catch (error) {
                    return (
                      <div key={`process-info-error-${idx}`} className="text-red-500 bg-red-50 p-2 rounded border border-red-200">
                        ê³µì • ëª…ë ¹ ì²˜ë¦¬ ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.
                      </div>
                    );
                  }
                })}
                
                {/* ëª…ë ¹???†ëŠ” ê²½ìš° ?ˆë‚´ ë©”ì‹œì§€ ?œì‹œ */}
                {progressMessages.filter(msg => msg.rawJson).length === 0 && (
                  <div className="text-gray-500 bg-gray-50 border border-gray-200 italic text-center p-3 rounded">
                    <div className="text-[10px] mb-1">ê³µì • ëª…ë ¹???†ìŠµ?ˆë‹¤</div>
                    <div className="text-[9px]">extwork/extraction/input ? í”½?¼ë¡œ JSON ëª…ë ¹??ë³´ë‚´ì£¼ì„¸??/div>
                  </div>
                )}
                
                {/* ì±„ì? ë¹„ìœ¨ ì§„í–‰ ë°?- ? ë‹ˆë©”ì´???ìš© */}
                <div className="mb-2 mt-3 pt-2 border-t border-gray-200">
                  <div className="flex justify-between items-center mb-1">
                    <span className="font-semibold">ì§„í–‰ ?íƒœ:</span>
                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded-full ${
                      fillPercentage >= 90 ? 'bg-green-100 text-green-800' :
                      fillPercentage >= 60 ? 'bg-blue-100 text-blue-800' :
                      fillPercentage >= 30 ? 'bg-yellow-100 text-yellow-800' :
                      'bg-gray-100 text-gray-800'
                    }`}>
                      {(() => {
                        try {
                          // ìµœì‹  JSON ?°ì´?°ì—??repetition ì°¾ê¸°
                          const latestJsonMsg = progressMessages.find(msg => msg.rawJson);
                          if (latestJsonMsg && latestJsonMsg.rawJson) {
                            const jsonData = JSON.parse(latestJsonMsg.rawJson);
                            if (jsonData.repetition_count && jsonData.repetition) {
                              return `${jsonData.repetition_count - jsonData.repetition}???¨ìŒ`;
                            }
                          }
                        } catch (e) {
                          console.error('Repetition parsing error:', e);
                        }
                        return `${Math.floor(fillPercentage)}%`;
                      })()}
                    </span>
                  </div>
                  
                  {/* ?í˜• ê·¸ë˜??ì¶”ê? */}
                  <div className="flex items-center justify-between mb-2">
                    <div className="w-16 h-16 relative">
                      <svg viewBox="0 0 36 36" className="w-full h-full">
                        {/* ë°°ê²½ ??*/}
                        <circle 
                          cx="18" 
                          cy="18" 
                          r="15.9" 
                          fill="none" 
                          stroke="#eeeeee" 
                          strokeWidth="3"
                        />
                        
                        {/* ì§„í–‰ ??*/}
                        {(() => {
                          // ê¸°ë³¸ê°??€???™ì  ì§„í–‰ë¥?ê³„ì‚°
                          let percent = 0;

                          // ìµœì‹  JSON ?°ì´?°ì—??ì§„í–‰ ?•ë³´ ì°¾ê¸°
                          try {
                            const latestJsonMsg = progressMessages.find(msg => msg.rawJson);
                            if (latestJsonMsg && latestJsonMsg.rawJson) {
                              const jsonData = JSON.parse(latestJsonMsg.rawJson);
                              // process_timeê³?total_remaining?¼ë¡œ ì§„í–‰ë¥?ê³„ì‚°
                              if (jsonData.process_time && jsonData.total_remaining) {
                                const totalTime = parseInt(String(jsonData.process_time).match(/(\d+)/)?.[1] || "0", 10);
                                const totalRemaining = parseInt(String(jsonData.total_remaining).match(/(\d+)/)?.[1] || "0", 10);
                                
                                if (totalTime > 0 && totalRemaining >= 0) {
                                  // ì§„í–‰ë¥?ê³„ì‚° = (?„ì²´ ?œê°„ - ?¨ì? ?œê°„) / ?„ì²´ ?œê°„ * 100
                                  percent = Math.min(100, Math.max(0, Math.floor(100 - (totalRemaining / totalTime * 100))));
                                }
                              }
                            }
                          } catch (e) {
                            console.error('Progress calculation error:', e);
                            // ?ëŸ¬ ë°œìƒ ??ê¸°ë³¸ê°?? ì?
                          }
                          
                          return (
                            <>
                              <circle 
                                cx="18" 
                                cy="18" 
                                r="15.9" 
                                fill="none" 
                                stroke={percent >= 90 ? '#22c55e' : percent >= 60 ? '#3b82f6' : percent >= 30 ? '#eab308' : '#6b7280'} 
                                strokeWidth="3" 
                                strokeDasharray={`${percent}, 100`} 
                                strokeDashoffset="25" 
                                strokeLinecap="round" 
                                className="transition-all duration-1000"
                              />
                              
                              {/* ê°€?´ë° ?ìŠ¤??*/}
                              <text 
                                x="18" 
                                y="18.5" 
                                textAnchor="middle" 
                                fontSize="10" 
                                fontWeight="bold" 
                                fill={percent >= 90 ? '#22c55e' : percent >= 60 ? '#3b82f6' : percent >= 30 ? '#eab308' : '#6b7280'}
                              >
                                {percent}%
                              </text>
                            </>
                          );
                        })()}
                      </svg>
                    </div>
                    
                    {/* ì§„í–‰ ?íƒœ ë°”ë? ê°œë³„ë¡?ë¶„ë¦¬?˜ì—¬ ?œì‹œ */}
                    <div className="space-y-1.5 flex-1 ml-2">
                      {/* ?„ì¬ ?‘ì—… ì§„í–‰ë¥?ë°?- ?€ê¸°ì¤‘?ë„ ??ƒ ?œì‹œ */}
                      {(() => {
                        try {
                          // ìµœì‹  JSON ?°ì´?°ì—???Œí”„ ì§„í–‰ ?•ë³´ ì°¾ê¸°
                          const latestJsonMsg = progressMessages.find(msg => msg.rawJson);
                          if (latestJsonMsg && latestJsonMsg.rawJson) {
                            const jsonData = JSON.parse(latestJsonMsg.rawJson);
                            
                            // ?€ê¸??íƒœ??ê²½ìš° - ê³ ì • ê°’ìœ¼ë¡??œì‹œ
                            if (jsonData.process_info === "waiting") {
                              const pumpId = jsonData.pump_id || 0;
                              return (
                                <div className="flex items-center space-x-2">
                                  <span className="text-[10px] font-medium text-yellow-700 w-14">?Œí”„ {pumpId}(?€ê¸?:</span>
                                  <div className="flex-1 h-2.5 bg-gray-200 rounded-full overflow-hidden">
                                    <div 
                                      className="h-full bg-yellow-200 rounded-full"
                                      style={{ width: '100%' }}
                                    ></div>
                                  </div>
                                  <span className="text-[9px] font-semibold text-yellow-700">?€ê¸°ì¤‘</span>
                                </div>
                              );
                            }
                            
                            // ?¼ë°˜ ?‘ì—… ?íƒœ
                            if (jsonData.pump_id) {
                              const pumpMatch = String(jsonData.pump_id).match(/(\d+)\((\d+)\/(\d+)\)/);
                              if (pumpMatch) {
                                const pumpId = parseInt(pumpMatch[1], 10);
                                const current = parseInt(pumpMatch[2], 10);
                                const total = parseInt(pumpMatch[3], 10);
                                if (!isNaN(current) && !isNaN(total) && total > 0) {
                                  const pumpPercent = Math.min(100, Math.floor((current / total) * 100));
                                  return (
                                    <div className="flex items-center space-x-2">
                                      <span className="text-[10px] font-medium text-yellow-700 w-14">?Œí”„ {pumpId}(ê°€??:</span>
                                      <div className="flex-1 h-2.5 bg-gray-200 rounded-full overflow-hidden">
                                        <div 
                                          className="h-full bg-yellow-500 rounded-full transition-all duration-1000 ease-in-out"
                                          style={{ width: `${pumpPercent}%` }}
                                        ></div>
                                      </div>
                                      <span className="text-[9px] font-semibold text-yellow-700">{pumpPercent}%</span>
                                    </div>
                                  );
                                }
                              } else if (typeof jsonData.pump_id === 'number') {
                                // ?Œí”„ IDê°€ ?«ì??ê²½ìš° - ?¨ìˆœ???Œí”„ ë²ˆí˜¸ë§??œì‹œ
                                const pumpId = jsonData.pump_id;
                                return (
                                  <div className="flex items-center space-x-2">
                                    <span className="text-[10px] font-medium text-yellow-700 w-14">?Œí”„ {pumpId}(ê°€??:</span>
                                    <div className="flex-1 h-2.5 bg-gray-200 rounded-full overflow-hidden">
                                      <div 
                                        className="h-full bg-yellow-500 rounded-full transition-all duration-1000 ease-in-out"
                                        style={{ width: '50%' }}
                                      ></div>
                                    </div>
                                    <span className="text-[9px] font-semibold text-yellow-700">ì§„í–‰ì¤?/span>
                                  </div>
                                );
                              }
                            }
                          }
                        } catch (e) {
                          console.error('Pump info parsing error:', e);
                        }
                        
                        // ê¸°ë³¸ ?íƒœ - ??ƒ ?œì‹œ?˜ë„ë¡?                        return (
                          <div className="flex items-center space-x-2">
                            <span className="text-[10px] font-medium text-yellow-700 w-14">?Œí”„(?€ê¸?:</span>
                            <div className="flex-1 h-2.5 bg-gray-200 rounded-full overflow-hidden">
                              <div 
                                className="h-full bg-yellow-200 rounded-full"
                                style={{ width: '100%' }}
                              ></div>
                            </div>
                            <span className="text-[9px] font-semibold text-yellow-700">ë¯¸ì‘??/span>
                          </div>
                        );
                      })()}
                      
                      {/* ?€ê¸°ì‹œê°?ì¹´ìš´??ê·¸ë˜??*/}
                      {(() => {
                        try {
                          // ìµœì‹  JSON ?°ì´?°ì—???€ê¸°ì‹œê°??•ë³´ ì°¾ê¸°
                          const latestJsonMsg = progressMessages.find(msg => msg.rawJson);
                          if (latestJsonMsg && latestJsonMsg.rawJson) {
                            const jsonData = JSON.parse(latestJsonMsg.rawJson);
                            
                            // ?€ê¸??íƒœ??ê²½ìš°???€ê¸°ì‹œê°?ì¹´ìš´???œì‹œ
                            if (jsonData.process_info === "waiting" && jsonData.remaining_time !== undefined && jsonData.total_time !== undefined) {
                              const remainingTime = parseInt(String(jsonData.remaining_time), 10);
                              const totalTime = parseInt(String(jsonData.total_time), 10);
                              
                              if (!isNaN(remainingTime) && !isNaN(totalTime) && totalTime > 0) {
                                const elapsedTime = totalTime - remainingTime;
                                const waitPercent = Math.min(100, Math.max(0, Math.floor((elapsedTime / totalTime) * 100)));
                                
                                return (
                                  <div className="flex items-center space-x-2">
                                    <span className="text-[10px] font-medium text-blue-700 w-14">?€ê¸°ì¹´?´í„°:</span>
                                    <div className="flex-1 h-2.5 bg-gray-200 rounded-full overflow-hidden">
                                      <div 
                                        className="h-full bg-blue-500 rounded-full transition-all duration-1000 ease-in-out"
                                        style={{ width: `${waitPercent}%` }}
                                      ></div>
                                    </div>
                                    <span className="text-[9px] font-semibold text-blue-700">{remainingTime}ì´?{totalTime}ì´?/span>
                                  </div>
                                );
                              }
                            }
                          }
                        } catch (e) {
                          console.error('Wait counter parsing error:', e);
                        }
                        return null;
                      })()}
                      
                      {/* 3. ?€ê¸°ì‹œê°?ì§„í–‰ë¥?ë°?ì¶”ê? */}
                      {(() => {
                        try {
                          // ìµœì‹  JSON ?°ì´?°ì—???€ê¸°ì‹œê°??•ë³´ ì°¾ê¸°
                          const latestJsonMsg = progressMessages.find(msg => msg.rawJson);
                          if (latestJsonMsg && latestJsonMsg.rawJson) {
                            const jsonData = JSON.parse(latestJsonMsg.rawJson);
                            
                            // ?ë™???€ê¸°ì‹œê°??œì‹œ (automationWaitTime???ˆìœ¼ë©??€ê¸°ì‹œê°??œì‹œ)
                            if (automationWaitTime && automationWaitTime.value > 0) {
                              // max ê°’ì´ ?†ì–´??ì´ˆê¸°ê°’ì„ ê³„ì‚°?´ì„œ ?¬ìš©
                              const initialTime = automationWaitTime.endTime ? Math.ceil((automationWaitTime.endTime - Date.now() + automationWaitTime.value * 1000) / 1000) : 60;
                              const waitPercent = Math.min(100, Math.max(0, Math.floor(((initialTime - automationWaitTime.value) / initialTime) * 100)));
                              
                              return (
                                <div className="flex items-center space-x-2">
                                  <span className="text-[10px] font-medium text-purple-700 w-14">?€ê¸?</span>
                                  <div className="flex-1 h-2.5 bg-gray-200 rounded-full overflow-hidden">
                                    <div 
                                      className="h-full bg-purple-500 rounded-full transition-all duration-1000 ease-in-out"
                                      style={{ width: `${waitPercent}%` }}
                                    ></div>
                                  </div>
                                  <span className="text-[9px] font-semibold text-purple-700">{automationWaitTime.value}ì´?/span>
                                </div>
                              );
                            }
                            
                            // total_remaining???ˆìœ¼ë©??€ê¸°ì‹œê°„ìœ¼ë¡??œì‹œ
                            if (jsonData.total_remaining && jsonData.process_time) {
                              const totalTime = parseInt(String(jsonData.process_time).match(/(\d+)/)?.[1] || "0", 10);
                              const totalRemaining = parseInt(String(jsonData.total_remaining).match(/(\d+)/)?.[1] || "0", 10);
                              
                              if (totalTime > 0 && totalRemaining > 0) {
                                const waitPercent = Math.min(100, Math.max(0, Math.floor(100 - (totalRemaining / totalTime * 100))));
                                
                                // ?œê°„ ?¨ìœ„ ê³„ì‚° (??ë¶?ì´??•ì‹)
                                const hours = Math.floor(totalRemaining / 3600);
                                const minutes = Math.floor((totalRemaining % 3600) / 60);
                                const seconds = totalRemaining % 60;
                                
                                // ?œê°„ ?¬ë§·??(?œê°„???ˆìœ¼ë©???ë¶?ì´? ?†ìœ¼ë©?ë¶?ì´?
                                const timeDisplay = hours > 0 
                                  ? `${hours}??${minutes}ë¶?${seconds}ì´?
                                  : `${minutes}ë¶?${seconds}ì´?;
                                
                                return (
                                  <div className="flex items-center space-x-2">
                                    <span className="text-[10px] font-medium text-purple-700 w-14">ê³µì • ì¢…ë£Œ:</span>
                                    <div className="flex-1 h-2.5 bg-gray-200 rounded-full overflow-hidden">
                                      <div 
                                        className="h-full bg-purple-500 rounded-full transition-all duration-1000 ease-in-out"
                                        style={{ width: `${waitPercent}%` }}
                                      ></div>
                                    </div>
                                    <span className="text-[9px] font-semibold text-purple-700">{timeDisplay}</span>
                                  </div>
                                );
                              }
                            }
                          }
                        } catch (e) {
                          console.error('Wait time parsing error:', e);
                        }
                        return null;
                      })()}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          {/* ì¶”ê? ?•ë³´ ë°•ìŠ¤ 2 - Loading Process */}
          <div className="bg-white border border-gray-200 rounded-lg shadow-sm mb-4">
            <div className="bg-green-50 py-1 px-2 text-xs font-semibold text-green-700 rounded-t-lg border-b border-gray-200">
              Loading Process
            </div>
            <div className="p-3">
              {/* JSON ?°ì´??- ?˜ë‚˜ë§??œì‹œ */}
              <div className="space-y-2">
                {progressMessages.filter(msg => msg.rawJson).slice(0, 1).map((msg, idx) => (
                  <div key={`json-${idx}`} className="p-2 rounded bg-white border border-gray-100 text-[10px] leading-tight">
                      <div className="flex justify-between items-center">
                      <span className="font-medium text-green-700">JSON ?°ì´??/span>
                      <span className="text-green-500 font-semibold text-[8px]">{formatTimeStr()}</span>
                      </div>
                      
                      {msg.rawJson && (
                        <div className="mt-2 bg-green-50 border border-green-100 rounded p-2 overflow-x-auto">
                        <div className="grid grid-cols-2 gap-x-2 gap-y-1 text-[9px]">
                          {(() => {
                            try {
                              const jsonData = JSON.parse(msg.rawJson);
                              return (
                                <>
                                  {jsonData.process_info && (
                              <div>
                                <span className="font-semibold text-green-700">ì§„í–‰:</span>{" "}
                                    <span className="font-medium">{jsonData.process_info}</span>
                              </div>
                            )}
                                  {jsonData.pump_id && (
                              <div>
                                      <span className="font-semibold text-green-700">?Œí”„:</span>{" "}
                                    <span className="font-medium">{jsonData.pump_id}</span>
                              </div>
                            )}
                                  {jsonData.remaining_time && (
                              <div>
                                <span className="font-semibold text-green-700">?¨ì?:</span>{" "}
                                    <span className="font-medium">{jsonData.remaining_time}</span>
                              </div>
                            )}
                                  {jsonData.total_remaining && (
                              <div>
                                <span className="font-semibold text-green-700">ì´ë‚¨?€:</span>{" "}
                                    <span className="font-medium">{jsonData.total_remaining}</span>
                              </div>
                            )}
                                  {jsonData.total_time && (
                              <div>
                                <span className="font-semibold text-green-700">ì´ì‹œê°?</span>{" "}
                                    <span className="font-medium">{jsonData.total_time}</span>
                              </div>
                            )}
                                </>
                              );
                            } catch (error) {
                              return (
                                <div className="col-span-2 text-red-500">
                                  JSON ?Œì‹± ?¤ë¥˜: ?˜ëª»???•ì‹
                                </div>
                              );
                            }
                          })()}
                          </div>
                        </div>
                      )}
                            </div>
                ))}
                            </div>
                            </div>
          </div>
          
          {/* ì¶”ê? ?•ë³´ ë°•ìŠ¤ 3 - ?Œë¦¼ */}
          <div className="bg-white border border-gray-200 rounded-lg shadow-sm">
            <div className="bg-gray-50 py-1 px-2 text-xs font-semibold text-gray-700 rounded-t-lg border-b border-gray-200">
              ?Œë¦¼
            </div>
            <div className="p-2 max-h-[70px] overflow-y-auto">
              {notifications.length > 0 ? (
                notifications.slice(0, 5).map((notification, idx) => (
                  <div key={idx} className="text-[9px] mb-1 pb-1 border-b border-gray-100 last:border-0 last:mb-0 last:pb-0">
                    <div className="font-medium">{new Date(notification.timestamp).toLocaleTimeString()}</div>
                    <div>{notification.message}</div>
                  </div>
                ))
              ) : (
                <div className="text-[9px] text-gray-500">?ˆë¡œ???Œë¦¼???†ìŠµ?ˆë‹¤</div>
              )}
            </div>
          </div>
          
          {/* ?íƒœ ë³€ê²??Œë¦¼ UI ì¶”ê? - ?°ì¸¡ ?˜ë‹¨ ë¹?ê³µê°„??ë°°ì¹˜ */}
          {notifications.length > 0 && (
            <div className="mt-1 space-y-1">
              {notifications.slice(0, 2).map((notification, idx) => (
                <div 
                  key={`popup-${notification.timestamp}-${idx}`}
                  className={`p-2 rounded-lg border text-xs shadow-sm animate-slideInRight ${
                    notification.type === 'warning' ? 'bg-yellow-50 border-yellow-300 text-yellow-800' :
                    notification.type === 'error' ? 'bg-red-50 border-red-300 text-red-800' :
                    'bg-blue-50 border-blue-200 text-blue-800'
                  }`}
                  style={{
                    animation: 'slideInRight 0.5s forwards, fadeOut 0.5s 4.5s forwards'
                  }}
                >
                  <div className="flex justify-between">
                    <span className={`font-medium ${
                      notification.type === 'warning' ? 'text-yellow-600' :
                      notification.type === 'error' ? 'text-red-600' :
                      'text-blue-700'
                    }`}>
                      {notification.type === 'warning' ? '? ï¸ ê²½ê³ ' : 
                      notification.type === 'error' ? '???¤ë¥˜' : 
                      '?’¡ ?Œë¦¼'}
                    </span>
                    <span className="text-[10px] text-gray-500">
                      {new Date(notification.timestamp).toLocaleTimeString()}
                    </span>
                  </div>
                  <p className="mt-1">{notification.message}</p>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* ? ë‹ˆë©”ì´???¤í”„?ˆì„ ?•ì˜ */}
      <style jsx>{`
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
          from { opacity: 1; }
          to { opacity: 0; }
        }
      `}</style>

      <div className="absolute bottom-0 left-0 right-0 bg-gray-50 border-t border-gray-200 mt-0">
        <div className="p-0">
          <div className="w-full">
            <div className="flex justify-between items-center px-1 py-0.5">
              <div className="font-bold text-[9px]">ì¶”ì¶œ ì§„í–‰ ?í™©:</div>
              <div className="text-[8px] text-gray-500">{formatTimeStr()}</div>
            </div>
            <div className="max-h-[40px] overflow-y-auto px-1">
              {progressMessages.slice(0, 2).map((msg, idx) => (
                <div key={`msg-${idx}`} className="p-0.5 mb-0.5 rounded bg-white border border-gray-100 text-[9px] leading-tight flex items-center last:mb-0">
                  <div className="w-3 h-3 flex-shrink-0 bg-blue-100 rounded-full flex items-center justify-center mr-1">
                    <span className="text-[7px] font-bold text-blue-700">{idx+1}</span>
                  </div>
                  <div className="flex-grow overflow-hidden">
                    {msg.message || 'ì§„í–‰ ?•ë³´'}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>

      {/* ì§„í–‰ ë²„íŠ¼ ?íƒœ ?„ë‹¬???„í•œ ?ˆë“  ?”ì†Œ */}
      <div className="hidden" id="process-running-state" data-running={processRunning.toString()}></div>
    </div>
  );
}

